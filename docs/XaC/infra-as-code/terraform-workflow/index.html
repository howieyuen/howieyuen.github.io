<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Terraform 每次运行都经过多个操作阶段（Pending、Plan、Cost Estimation、Policy Check、Apply 和 Completion），Terraform Cloud 将这些阶段的进度显示为运行状态。
在 Terraform Cloud 主页上的工作区列表中，每个工作区都显示了它当前正在处理的运行状态。（或者，如果没有正在进行的运行，则为最近完成的运行的状态。）">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="Terraform 执行状态和阶段关系" />
<meta property="og:description" content="Terraform 每次运行都经过多个操作阶段（Pending、Plan、Cost Estimation、Policy Check、Apply 和 Completion），Terraform Cloud 将这些阶段的进度显示为运行状态。
在 Terraform Cloud 主页上的工作区列表中，每个工作区都显示了它当前正在处理的运行状态。（或者，如果没有正在进行的运行，则为最近完成的运行的状态。）" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://howieyuen.github.io/docs/XaC/infra-as-code/terraform-workflow/" /><meta property="article:section" content="docs" />
<meta property="article:published_time" content="2022-12-16T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-02-27T19:55:28+08:00" />

<title>Terraform 执行状态和阶段关系 | 袁昊的学习笔记</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.c58292d36b18b675680ab9baea2029204537b839ea72f258746ec0f32ce8d6c8.css" integrity="sha256-xYKS02sYtnVoCrm66iApIEU3uDnqcvJYdG7A8yzo1sg=" crossorigin="anonymous">
  <script defer src="/flexsearch.min.js"></script>
  <script defer src="/en.search.min.cb7fbe0a2b5fdbeb70dfc02cf3085cf1a7ed6f7ac0dd5ed1d9a97b843d7c92c8.js" integrity="sha256-y3&#43;&#43;Citf2&#43;tw38As8whc8aftb3rA3V7R2al7hD18ksg=" crossorigin="anonymous"></script>

  <script defer src="/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js" integrity="sha256-b2&#43;Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC&#43;NdcPIvZhzk=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><img src="/logo.jpeg" alt="Logo" /><span>袁昊的学习笔记</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li>
          
  
  

  
    <span>Golang</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-b81db6492518b1ec8f31de69b0812196" class="toggle"  />
    <label for="section-b81db6492518b1ec8f31de69b0812196" class="flex justify-between">
      <a role="button" class="">数据结构</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/golang/data-structure/chan/" class="">chan</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/golang/data-structure/map/" class="">map</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/golang/data-structure/slice/" class="">slice</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-def2dd5a69e672402d635862e3155cbd" class="toggle"  />
    <label for="section-def2dd5a69e672402d635862e3155cbd" class="flex justify-between">
      <a role="button" class="">语言基础</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/golang/language-basics/unsafe/" class="">unsafe</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/golang/language-basics/reflect/" class="">reflect</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-873194c4b0ec7a578576232c8d994c31" class="toggle"  />
    <label for="section-873194c4b0ec7a578576232c8d994c31" class="flex justify-between">
      <a role="button" class="">内存管理</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/golang/memory-manage/memory-model/" class="">内存模型</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-b2e47afb5c03c825c53136ae4cc0848f" class="toggle"  />
    <label for="section-b2e47afb5c03c825c53136ae4cc0848f" class="flex justify-between">
      <a role="button" class="">golang 工具</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/golang/tools/pprof/" class="">pprof</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Kubernetes</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-99bae3fc02ce73f8422ca93f733590ac" class="toggle"  />
    <label for="section-99bae3fc02ce73f8422ca93f733590ac" class="flex justify-between">
      <a role="button" class="">kube-apisever</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-apiserver/authorization/" class="">鉴权机制</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-apiserver/authentication/" class="">认证机制</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-apiserver/garbage-collector/" class="">垃圾回收</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-apiserver/key-design-of-etcd-watch/" class="">watch 关键设计</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-apiserver/crd/" class="">CRD 入门和使用</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-8db6df9b09828d3b4f51a3f0e8635341" class="toggle"  />
    <label for="section-8db6df9b09828d3b4f51a3f0e8635341" class="flex justify-between">
      <a role="button" class="">kube-controller-manager</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-controller-manager/code-analysis-of-garbagecollector-controller/" class="">GC Controller 源码分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-controller-manager/code-analysis-of-daemonset-controller/" class="">DaemonSet Controller 源码分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-controller-manager/code-analysis-of-statefulset-controller/" class="">Statefulset Controller 源码分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-controller-manager/k8s-apps-rolling-update/" class="">无状态应用滚动更新</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-f69546525118538b309149a83388b048" class="toggle"  />
    <label for="section-f69546525118538b309149a83388b048" class="flex justify-between">
      <a role="button" class="">kube-scheduler</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-scheduler/advanced-scheduling/" class="">高级调度</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-a5e90c89093229651c03236cd9ca0bf7" class="toggle"  />
    <label for="section-a5e90c89093229651c03236cd9ca0bf7" class="flex justify-between">
      <a role="button" class="">kubelet</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kubelet/kubelet-topology-manager/" class="">Topology Manager 设计方案</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kubelet/kubelet-eviction-manager/" class="">Eviction Manager 工作机制</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-a153eacbc14a16cf1bd898e9025b6121" class="toggle"  />
    <label for="section-a153eacbc14a16cf1bd898e9025b6121" class="flex justify-between">
      <a role="button" class="">sig-network</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/sig-network/svc-ep-epslice/" class="">Service 与 Endpoints、EndpointSlice 那些事</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/sig-network/learn-about-Service/" class="">深入了解 Service</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>XaC(Everything as Code)</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-87d48c1068c47e29214232148a6ffd46" class="toggle" checked />
    <label for="section-87d48c1068c47e29214232148a6ffd46" class="flex justify-between">
      <a role="button" class="">Infra as Code</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/XaC/infra-as-code/getting-started-of-acorn/" class="">Acorn：k8s 应用部署框架</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/XaC/infra-as-code/terraform-workflow/" class="active">Terraform 执行状态和阶段关系</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-e55a75d91330d73a365d7c5ff163ca1d" class="toggle"  />
    <label for="section-e55a75d91330d73a365d7c5ff163ca1d" class="flex justify-between">
      <a role="button" class="">Secret as Code</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/XaC/secret-as-code/helm-secrets/" class="">Helm Secrets</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/XaC/secret-as-code/kamus/" class="">Kamus</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/XaC/secret-as-code/secrets-store-csi-driver/" class="">Secrets Store CSI Driver</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/XaC/secret-as-code/sealed-secrets/" class="">Sealed Secrets</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/XaC/secret-as-code/external-secret-operator/" class="">External Secrets Operator</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-0a7e8a0838cc922d31092abb572fa971" class="toggle"  />
    <label for="section-0a7e8a0838cc922d31092abb572fa971" class="flex justify-between">
      <a role="button" class="">CI/CD Tools</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/XaC/cicd/argocd/" class="">使用 ArgoCD ApplicationSet 管理多集群</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Getting-Started</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/getting-started/monorepo/" class="">MonoRepo</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/getting-started/circle-ci/" class="">Circle CI</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Translation</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-c0f96e48b4daa204312defe713af5b04" class="toggle"  />
    <label for="section-c0f96e48b4daa204312defe713af5b04" class="flex justify-between">
      <a role="button" class="">Protocol Buffers</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/translation/protobuf/overview-of-protocal-buffers/" class="">概述</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/translation/protobuf/language-guideproto3/" class="">语言指南（proto3）</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-41d00712937ef3a8ada203a9e4f0c745" class="toggle"  />
    <label for="section-41d00712937ef3a8ada203a9e4f0c745" class="flex justify-between">
      <a role="button" class="">LeetCode</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/leetcode/0321/" class="">321. 拼接最大数</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/leetcode/0416/" class="">416. 分割等和子集</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>











  
<ul>
  
  <li>
    <a href="/posts/" >
        Blogs
      </a>
  </li>
  
  <li>
    <a href="https://github.com/howieyuen/" target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Terraform 执行状态和阶段关系</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#pending">Pending</a></li>
        <li><a href="#fetching">Fetching</a></li>
        <li><a href="#pre-plan可选">Pre-plan（可选）</a></li>
        <li><a href="#plan">Plan</a></li>
        <li><a href="#post-plan可选">Post-plan（可选）</a></li>
        <li><a href="#opa-policy-check可选">OPA Policy Check（可选）</a></li>
        <li><a href="#cost-estimation可选">Cost Estimation（可选）</a></li>
        <li><a href="#sentinel-policy-check可选">Sentinel Policy Check（可选）</a></li>
        <li><a href="#pre-apply可选">Pre-Apply（可选）</a></li>
        <li><a href="#apply">Apply</a></li>
        <li><a href="#completion">Completion</a></li>
        <li><a href="#reference">Reference</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><p>Terraform 每次运行都经过多个操作阶段（Pending、Plan、Cost Estimation、Policy Check、Apply 和 Completion），Terraform Cloud 将这些阶段的进度显示为运行状态。
在 Terraform Cloud 主页上的工作区列表中，每个工作区都显示了它当前正在处理的运行状态。（或者，如果没有正在进行的运行，则为最近完成的运行的状态。）</p>
<h2 id="pending">
  Pending
  <a class="anchor" href="#pending">#</a>
</h2>
<p>阶段状态：</p>
<ul>
<li>Pending：Terraform Cloud 尚未开始运行操作。Terraform Cloud 按照排队的顺序处理每个工作区的运行，并且运行在每次运行完成之前一直处于挂起状态。</li>
</ul>
<p>离开状态：</p>
<ul>
<li>Discarded：如果用户在开始前放弃运行，则运行不会继续。</li>
<li>Planning：如果运行在队列中排在首位，它会自动进入 Plan 阶段。</li>
</ul>
<p>图示：</p>
<img src="/iac/pending.png" width="300" height="200" style="display: block; margin: auto;">
<h2 id="fetching">
  Fetching
  <a class="anchor" href="#fetching">#</a>
</h2>
<p>Terraform Cloud 可能需要在开始计划之前从 VCS 获取配置。当所有运行完成后，Terraform Cloud 会自动存档通过 VCS 创建的配置版本，然后重新获取文件以供后续运行使用。</p>
<p>阶段状态：</p>
<ul>
<li>Fetching：如果 Terraform Cloud 尚未从 VCS 获取配置，则运行将进入此状态，直到配置可用。</li>
</ul>
<p>离开状态：</p>
<ul>
<li>Plan Errored：如果 Terraform Cloud 在从 VCS 获取配置时遇到错误，则运行不会继续。</li>
<li>如果 Terraform 成功获取配置，则运行进入下一阶段。</li>
</ul>
<p>图示：</p>
<img src="/iac/fetching.png" width="300" height="200" style="display: block; margin: auto;">
<h2 id="pre-plan可选">
  Pre-plan（可选）
  <a class="anchor" href="#pre-plan%e5%8f%af%e9%80%89">#</a>
</h2>
<p>创建 
  <a href="https://developer.hashicorp.com/terraform/cloud-docs/workspaces/settings/run-tasks">Run Task</a>，并关联 Workspace，选择在 “Pre-plan” 时执行，才有 Pre-plan 阶段。在此阶段，Terraform Cloud 将有关运行的信息发送到已配置的外部系统，并等待 passed 或 failed 响应以确定运行是否可以继续。</p>
<p>阶段状态：</p>
<ul>
<li>Pre-planning： Terraform Cloud 正在等待配置的外部系统的响应。
<ul>
<li>外部系统必须首先响应确认 200 OK请求正在进行中。之后，他们有 10 分钟的时间返回状态 passed、running或 failed。如果超时到期，Terraform Cloud 假定运行任务处于状态 failed。</li>
</ul>
</li>
</ul>
<p>离开状态：</p>
<ul>
<li>Plan Errored：如果任何强制性任务失败，运行将跳至完成（Plan Errored状态）。</li>
<li>Planning：如果任何咨询任务失败，运行将进入计划状态，并带有关于失败任务的可见警告。</li>
<li>Plan Errored/Planning：如果单次运行包含强制任务和建议任务的组合，Terraform 会采取最严格的操作。例如，如果有两项建议任务成功而一项强制任务失败，则运行失败。</li>
<li>Canceled：如果用户取消了运行，运行将以 Canceled 状态结束。</li>
</ul>
<p>图示：</p>
<img src="/iac/pre-plan.png" width="600" height="800" style="display: block; margin: auto;">
<p>场景：</p>
<ul>
<li>Blink：实现无代码自动化，以跨云工具和服务管理 IaC 工作流</li>
<li>
  <a href="https://get.spectralops.io/docs/integration/tfc/">Check Point</a>：在规划阶段之前检测安全配置错误</li>
<li>
  <a href="https://www.tines.com/blog/handle-terraform-cloud-infrastructure-requests-automatically">Tines</a>：帮助用户批准和记录来自 Terraform Cloud 的基础设施请求</li>
<li>
  <a href="https://docs.torq.io/integrations/hashicorp-terraform">Torq</a>：为基础设施扫描、批准生命周期和使用 Jira 等票务系统进行跟踪创建自动化的无代码工作流</li>
</ul>
<h2 id="plan">
  Plan
  <a class="anchor" href="#plan">#</a>
</h2>
<p>根据 Terraform Cloud 是否需要从 VCS 获取配置，一次运行在计划阶段会经历不同的步骤。当所有运行完成后，Terraform Cloud 会自动存档通过 VCS 创建的配置版本，然后重新获取文件以供后续运行使用。</p>
<p>阶段状态：</p>
<ul>
<li>Planning： Terraform Cloud 当前正在运行 terraform plan。</li>
<li>Needs Confirmation：`terraform plan 已完成。运行有时会在此状态下暂停，具体取决于工作区和组织设置。</li>
</ul>
<p>离开状态：</p>
<ul>
<li>Plan Errored：如果 terraform plan命令失败，则运行不会继续。</li>
<li>Canceled：如果用户通过按下“取消运行”按钮取消了计划，则运行不会继续。</li>
<li>Planned and Finished：如果计划成功且没有任何更改，并且既不会进行成本估算，也不会进行 Sentinel 策略检查，则 Terraform Cloud 认为运行已完成。</li>
<li>如果计划成功并需要更改：
<ul>
<li>Cost Estimation：如果启用了成本估算，则运行会自动进入成本估算阶段。</li>
<li>Sentinel Policy Check：如果禁用成本估算并启用 Sentinel 策略，则运行会自动进入策略检查阶段。</li>
<li>Apply：如果没有 Sentinel 策略并且可以自动应用计划，则运行会自动进入应用阶段。如果在工作区上启用了 auto-apply ，并且计划由新的 VCS 提交或具有应用运行权限的用户排队，则可以自动应用计划。</li>
<li>如果没有 Sentinel 策略并且 Terraform Cloud 无法自动应用该计划，则运行将暂停在 Needs Confirmation 状态，直到有权应用运行的用户采取行动。如果授权用户批准申请，则运行将进入 Apply阶段。如果授权用户拒绝申请，则运行不会继续（Discarded 状态）。</li>
</ul>
</li>
</ul>
<p>图示：</p>
<img src="/iac/plan.png" width="500" height="500" style="display: block; margin: auto;">
<h2 id="post-plan可选">
  Post-plan（可选）
  <a class="anchor" href="#post-plan%e5%8f%af%e9%80%89">#</a>
</h2>
<p>创建 
  <a href="https://developer.hashicorp.com/terraform/cloud-docs/workspaces/settings/run-tasks">Run Task</a>，并关联 Workspace，选择在 “Post-plan” 时执行，才有 Post-plan 阶段。在此阶段，Terraform Cloud 将有关运行的信息发送到已配置的外部系统，并等待 passed 或 failed 响应以确定运行是否可以继续。</p>
<p>阶段状态：</p>
<ul>
<li>Post-planning： Terraform Cloud 正在等待配置的外部系统的响应。
<ul>
<li>外部系统必须首先响应确认 200 OK请求正在进行中。之后，他们有 10 分钟的时间返回状态 passed、running或 failed。如果超时到期，Terraform Cloud 假定运行任务处于状态 failed。
离开状态：</li>
</ul>
</li>
<li>Plan Errored：如果任何强制性任务失败，运行将跳至完成 Plan Errored 状态。</li>
<li>Applying：如果任何咨询任务失败，运行将进入 Applying 状态，并带有关于失败任务的可见警告。</li>
<li>Plan Errored/Applying：如果单次运行包含强制任务和建议任务的组合，Terraform 会采取最严格的操作。例如，如果有两项建议任务成功而一项强制任务失败，则运行失败。如果一项强制性任务成功而两项建议性任务失败，则运行成功并发出警告。</li>
<li>Canceled：如果用户取消了运行，运行将以 Canceled 状态结束。</li>
</ul>
<p>图示：</p>
<img src="/iac/pending.png" width="300" height="200" style="display: block; margin: auto;">
<p>场景：</p>
<p>用户期望在运行生命周期的各个阶段能做更多的事情，Post-plan 普遍的用例是确保团队遵守组织的安全性和合规性要求：</p>
<ul>
<li>安全性：确保您没有使用 Snyk、Bridgecrew、Tenable、Moderne、Sophos、Aqua Security、Firefly 和 Lightlytics 等工具提供会导致安全问题的错误配置</li>
<li>成本控制：在使用 Infracost、Vantage 或 Kion 进行任何更改之前提供对基础设施成本的可见性</li>
<li>法规遵从性：使用 Bridgecrew 或 Kion 确保遵守各种法规，例如 HIPAA、GDPR 或 PCI-DSS</li>
</ul>
<h2 id="opa-policy-check可选">
  OPA Policy Check（可选）
  <a class="anchor" href="#opa-policy-check%e5%8f%af%e9%80%89">#</a>
</h2>
<p>此阶段仅在启用
  <a href="https://developer.hashicorp.com/terraform/cloud-docs/policy-enforcement/opa">开放策略代理 (OPA) 策略</a>并在 terraform plan 成功之后和成本估算之前运行时才会发生。在此阶段，Terraform Cloud 检查计划是否符合工作空间的 OPA 策略集中的策略。</p>
<p>阶段状态：</p>
<ul>
<li>Policy Check：Terraform Cloud 正在根据 OPA 政策集检查计划。</li>
<li>Policy Override：策略检查已完成，但强制策略失败。运行暂停，除非用户手动覆盖策略检查失败，否则 Terraform 无法执行应用。</li>
<li>Policy Checked：策略检查成功，Terraform 可以应用该计划。如果工作区未设置为自动应用运行，运行可能会在此状态下暂停。</li>
</ul>
<p>离开状态：</p>
<p>如果任何强制性 Policy 失败，运行将暂停在 Policy Override 状态。运行完成以下工作流程之一：</p>
<ul>
<li>Discarded：当具有应用运行权限的用户放弃运行时，运行停止并进入 Discarded 状态。</li>
<li>Policy Checked：当有权管理策略覆盖的用户覆盖失败的策略时，运行会进入 Policy Checked 状态。Policy Checked 状态意味着没有强制性策略失败或用户执行了手动覆盖。
一旦运行达到 Policy Checked 状态，运行将完成以下工作流程之一：</li>
<li>如果 Terraform 可以自动应用计划，则运行将进入 Apply 阶段。自动应用要求在工作区启用 auto-apply。</li>
<li>如果 Terraform 无法自动应用该计划，则运行将暂停在 Policy Checked 状态，直到有权应用运行的用户采取行动。如果用户批准申请，则运行进入 Apply 阶段。如果用户拒绝申请，则运行停止并进入 Discarded 状态。</li>
</ul>
<p>图示：</p>
<img src="/iac/opa.png" width="500" height="500" style="display: block; margin: auto;">
<h2 id="cost-estimation可选">
  Cost Estimation（可选）
  <a class="anchor" href="#cost-estimation%e5%8f%af%e9%80%89">#</a>
</h2>
<p>此阶段仅在启用成本估算时发生。成功后 terraform plan，Terraform Cloud 使用计划数据来估算计划中找到的每个资源的成本。</p>
<p>阶段状态：</p>
<ul>
<li>Cost Estimating： Terraform Cloud 目前正在估算计划中的资源。</li>
<li>Cost Estimated：已完成成本估算。</li>
</ul>
<p>离开状态：</p>
<ul>
<li>如果成本估算成功或出错，则运行进入下一阶段。</li>
<li>Planned and Finished：如果没有策略检查或应用，则运行不会继续。</li>
</ul>
<p>图示：</p>
<img src="/iac/cost.png" width="500" height="500" style="display: block; margin: auto;">
<h2 id="sentinel-policy-check可选">
  Sentinel Policy Check（可选）
  <a class="anchor" href="#sentinel-policy-check%e5%8f%af%e9%80%89">#</a>
</h2>
<p>terraform plan 执行成功后，Terraform Cloud 会检查计划是否符合策略，以确定是否可以应用。</p>
<p>阶段状态：</p>
<ul>
<li>Policy Check：Terraform Cloud 当前正在根据组织的政策检查计划。</li>
<li>Policy Override：策略检查已完成，但软强制性策略失败，因此未经有权为组织管理策略覆盖的用户批准，应用无法继续。运行在此状态下暂停。</li>
<li>Policy Checked：策略检查成功，Sentinel 将允许申请继续进行。运行有时会在此状态下暂停，具体取决于工作区设置。</li>
</ul>
<p>离开状态：</p>
<ul>
<li>Plan Errored：如果任何硬性强制策略失败，则运行不会继续）。</li>
<li>Policy Override：如果任何软强制策略失败，运行将暂停在 Policy Override 状态。
<ul>
<li>Policy Checked：如果有权管理策略覆盖的用户覆盖失败的策略，则运行会进入 Policy Checked 状态。</li>
<li>Discarded：如果有权应用运行的用户放弃运行，则运行不会继续。</li>
</ul>
</li>
<li>如果运行达到 Policy Checked 状态（没有强制策略失败，或者软强制策略被覆盖）：
<ul>
<li>如果计划可以自动应用，则运行会自动进入应用阶段。如果在工作区上启用了 auto-apply 设置，并且计划由新的 VCS 提交或具有应用运行权限的用户排队，则可以自动应用计划。</li>
<li>如果无法自动应用该计划，则运行将暂停在 Policy Checked 状态，直到有权应用运行的用户采取行动。如果他们批准申请，则运行会进入申请阶段，如果他们拒绝申请，则不会继续（Discarded）。</li>
</ul>
</li>
</ul>
<p>图示：</p>
<img src="/iac/policy-check.png" width="500" height="500" style="display: block; margin: auto;">
<h2 id="pre-apply可选">
  Pre-Apply（可选）
  <a class="anchor" href="#pre-apply%e5%8f%af%e9%80%89">#</a>
</h2>
<p>创建 
  <a href="https://developer.hashicorp.com/terraform/cloud-docs/workspaces/settings/run-tasks">Run Task</a>，并关联 Workspace，选择在 “Pre-apply” 时执行，才有 Pre-apply 阶段。在此阶段，Terraform Cloud 将有关运行的信息发送到已配置的外部系统，并等待 passed 或 failed 响应以确定运行是否可以继续。</p>
<p>阶段状态：</p>
<ul>
<li>Pre-apply running：Terraform Cloud 正在等待配置的外部系统的响应。
<ul>
<li>外部系统必须首先响应确认 200 OK请求正在进行中。之后，他们有 10 分钟的时间返回状态 passed、running或 failed。如果超时到期，Terraform Cloud 假定运行任务处于状态 failed。</li>
</ul>
</li>
</ul>
<p>离开状态：</p>
<ul>
<li>Apply Errored：如果任何强制性任务失败，运行将跳至完成。</li>
<li>Applying：如果任何咨询任务失败，运行将进入 Applying 状态，并带有关于失败任务的可见警告。</li>
<li>Apply Errored/Applying：如果单次运行包含强制任务和建议任务的组合，Terraform 会采取最严格的操作。例如，如果有两项建议任务成功而一项强制任务失败，则运行失败。</li>
<li>Canceled：如果用户取消了运行，运行将以 Canceled 状态结束。</li>
</ul>
<p>图示：</p>
<img src="/iac/pre-apply.png" width="500" height="500" style="display: block; margin: auto;">
<p>场景：</p>
<p>基础设施的日常运维中，检查 Terraform 配置是重要的一步。通常，团队会采用审查和批准流程，这通常会导致计划最初生成和应用之间出现延迟。这段时间，基础架构可以更改，可以强制执行，并且可以添加新的合规性规则，在同一个 Terraform Run 中执行。</p>
<h2 id="apply">
  Apply
  <a class="anchor" href="#apply">#</a>
</h2>
<p>阶段状态：</p>
<ul>
<li>Applying：Terraform Cloud 当前正在执行 terraform apply。</li>
</ul>
<p>离开状态：</p>
<ul>
<li>Applied：如果应用成功，则以 Applied 状态结束。</li>
<li>Apply Errored：如果应用失败，则以 Apply Errored 状态结束。</li>
<li>Canceled：如果用户通过按 Cancel Run 取消应用，则以 Canceled 状态结束。</li>
</ul>
<p>图示：</p>
<img src="/iac/apply.png" width="500" height="400" style="display: block; margin: auto;">
<h2 id="completion">
  Completion
  <a class="anchor" href="#completion">#</a>
</h2>
<p>如果 Apply 完成，或者任何一步失败，或者无事可做，或者用户选择不继续，则一次运行结束。一旦运行完成，队列中的下一个运行可以进入计划阶段。</p>
<p>阶段状态：</p>
<ul>
<li>Applied：一次运行成功应用。</li>
<li>Planned and Finished: terraform plan的输出已经与当前的基础设施状态相匹配，所以 terraform apply不需要做任何事情。</li>
<li>Apply Errored：命令 terraform apply失败，可能是由于缺少或配置错误的提供程序或对提供程序的非法操作。</li>
<li>Plan Errored：命令 terraform plan失败（通常需要修复变量或代码），或者硬性强制性 Sentinel 策略失败。无法应用运行。</li>
<li>Discarded：用户选择不继续此运行。</li>
<li>Canceled：用户使用“取消运行”按钮中断了 terraform plan或 terraform apply命令。</li>
</ul>
<h2 id="reference">
  Reference
  <a class="anchor" href="#reference">#</a>
</h2>
<ul>
<li>
  <a href="https://developer.hashicorp.com/terraform/cloud-docs/run/states">https://developer.hashicorp.com/terraform/cloud-docs/run/states</a></li>
<li>
  <a href="https://www.hashicorp.com/blog/pre-plan-apply-run-tasks-now-available-in-terraform-cloud">https://www.hashicorp.com/blog/pre-plan-apply-run-tasks-now-available-in-terraform-cloud</a></li>
<li>
  <a href="https://www.hashicorp.com/blog/terraform-cloud-run-tasks-are-now-generally-available">https://www.hashicorp.com/blog/terraform-cloud-run-tasks-are-now-generally-available</a></li>
</ul></article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">


  <div><a class="flex align-center" href="https://github.com/howieyuen/howieyuen.github.io/commit/3ca55ab350af2e1c5819434df7f796f281ad6dc8" title='Last modified by howieyuen | February 27, 2024' target="_blank" rel="noopener">
      <img src="/svg/calendar.svg" class="book-icon" alt="Calendar" />
      <span>February 27, 2024</span>
    </a>
  </div>




</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">



<div id="gitalk-container"></div>
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script>
  const gitalk = new Gitalk({
    clientID: 'b4cc17dbafc8ad637453',
    clientSecret: '77b4685b4d6da0280eca116a66b6f01244033d35',
    repo: 'howieyuen.github.io',
    owner: 'howieyuen',
    admin: ['howieyuen'],
    id: location.pathname, 
    distractionFreeMode: false 
  });
  (function() {
    if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
      document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
      return;
    }
    gitalk.render('gitalk-container');
  })();
</script>

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#pending">Pending</a></li>
        <li><a href="#fetching">Fetching</a></li>
        <li><a href="#pre-plan可选">Pre-plan（可选）</a></li>
        <li><a href="#plan">Plan</a></li>
        <li><a href="#post-plan可选">Post-plan（可选）</a></li>
        <li><a href="#opa-policy-check可选">OPA Policy Check（可选）</a></li>
        <li><a href="#cost-estimation可选">Cost Estimation（可选）</a></li>
        <li><a href="#sentinel-policy-check可选">Sentinel Policy Check（可选）</a></li>
        <li><a href="#pre-apply可选">Pre-Apply（可选）</a></li>
        <li><a href="#apply">Apply</a></li>
        <li><a href="#completion">Completion</a></li>
        <li><a href="#reference">Reference</a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












