<!DOCTYPE html>
<html lang="en" dir=>

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="1. DaemonSet 简介 #  我们知道，Deployment 是用来部署一定数量的 Pod。但是，当你希望 Pod 在集群中的每个节点上运行，并且每个节点上都需要一个 Pod 实例时，Deployment 就无法满足需求。
这类需求包括 Pod 执行系统级别与基础结构相关的操作，比如：希望在每个节点上运行日志收集器和资源监控组件。另一个典型的例子，就是 Kubernetes 自己的 kube-proxy 进程，它需要在所有节点上都运行，才能使得 Service 正常工作。
如此，DaemonSet 应运而生。它能确保集群中每个节点或者是满足某些特性的一组节点都运行一个 Pod 副本。当有新节点加入时，也会立即为它部署一个 Pod；当有节点从集群中删除时，Pod 也会被回收。删除 DaemonSet，也会删除所有关联的 Pod。
1.1 应用场景 #   在每个节点上运行集群存守护进程 在每个节点上运行日志收集守护进程 在每个节点上运行监控守护进程  一种简单的用法是为每种类型的守护进程在所有的节点上都启动一个 DaemonSet。 一个稍微复杂的用法是为同一种守护进程部署多个 DaemonSet；每个具有不同的标志，并且对不同硬件类型具有不同的内存、CPU 等要求。
1.2 基本功能 #   创建 删除  级联删除：kubectl delete ds/nginx-ds 非级联删除：kubectl delete ds/nginx-ds --cascade=false   更新  RollingUpdate OnDelete   回滚  1.3 示例 #  apiVersion: apps/v1 kind: DaemonSet metadata: name: fluentd-elasticsearch namespace: kube-system labels: k8s-app: fluentd-logging spec: selector: matchLabels: name: fluentd-elasticsearch template: metadata: labels: name: fluentd-elasticsearch spec: tolerations: # this toleration is to have the daemonset runnable on master nodes # remove it if your masters can&#39;t run pods - key: node-role.">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="DaemonSet Controller 源码分析" />
<meta property="og:description" content="1. DaemonSet 简介 #  我们知道，Deployment 是用来部署一定数量的 Pod。但是，当你希望 Pod 在集群中的每个节点上运行，并且每个节点上都需要一个 Pod 实例时，Deployment 就无法满足需求。
这类需求包括 Pod 执行系统级别与基础结构相关的操作，比如：希望在每个节点上运行日志收集器和资源监控组件。另一个典型的例子，就是 Kubernetes 自己的 kube-proxy 进程，它需要在所有节点上都运行，才能使得 Service 正常工作。
如此，DaemonSet 应运而生。它能确保集群中每个节点或者是满足某些特性的一组节点都运行一个 Pod 副本。当有新节点加入时，也会立即为它部署一个 Pod；当有节点从集群中删除时，Pod 也会被回收。删除 DaemonSet，也会删除所有关联的 Pod。
1.1 应用场景 #   在每个节点上运行集群存守护进程 在每个节点上运行日志收集守护进程 在每个节点上运行监控守护进程  一种简单的用法是为每种类型的守护进程在所有的节点上都启动一个 DaemonSet。 一个稍微复杂的用法是为同一种守护进程部署多个 DaemonSet；每个具有不同的标志，并且对不同硬件类型具有不同的内存、CPU 等要求。
1.2 基本功能 #   创建 删除  级联删除：kubectl delete ds/nginx-ds 非级联删除：kubectl delete ds/nginx-ds --cascade=false   更新  RollingUpdate OnDelete   回滚  1.3 示例 #  apiVersion: apps/v1 kind: DaemonSet metadata: name: fluentd-elasticsearch namespace: kube-system labels: k8s-app: fluentd-logging spec: selector: matchLabels: name: fluentd-elasticsearch template: metadata: labels: name: fluentd-elasticsearch spec: tolerations: # this toleration is to have the daemonset runnable on master nodes # remove it if your masters can&#39;t run pods - key: node-role." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://howieyuen.github.io/docs/kubernetes/sig-apps/code-analysis-of-daemonset-controller/" />
<meta property="article:published_time" content="2020-10-21T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-10-21T00:00:00+00:00" />
<title>DaemonSet Controller 源码分析 | 袁昊的学习笔记</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.bc96313b7eff2859c711746c9dbc5c9b3aca5651b50ecc3f8b1cf89154772a3b.css" integrity="sha256-vJYxO37/KFnHEXRsnbxcmzrKVlG1Dsw/ixz4kVR3Kjs=">
<script defer src="/en.search.min.7c14bc683fc901a79511e2ff61c61295da8e954e920a5ba81934f6eb99982fb7.js" integrity="sha256-fBS8aD/JAaeVEeL/YcYSldqOlU6SCluoGTT265mYL7c="></script>

<script defer src="/sw.min.74a8bb07f0bee86d6bb9a2750f073f14d93c7e4512f28860370cfd879e9719b4.js" integrity="sha256-dKi7B/C&#43;6G1ruaJ1Dwc/FNk8fkUS8ohgNwz9h56XGbQ="></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body dir=>
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><img src="/logo.jpeg" alt="Logo" /><span>袁昊的学习笔记</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  



  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Golang</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>数据结构</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/golang/data-structure/slice/" class="">切片</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/golang/data-structure/map/" class="">哈希表</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>语言基础</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/golang/language-basics/reflect/" class="">反射</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>内存管理</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/golang/memory-manage/memory-model/" class="">内存模型</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Kubernetes</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>sig-api-machinery</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/sig-api-machinery/garbage-collector/" class="">垃圾回收</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/sig-api-machinery/key-design-of-etcd-watch/" class="">k8s watch 关键设计</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>sig-apps</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/sig-apps/code-analysis-of-garbagecollector-controller/" class="">GC Controller 源码分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/sig-apps/code-analysis-of-daemonset-controller/" class=" active">DaemonSet Controller 源码分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/sig-apps/k8s-apps-rolling-update/" class="">k8s 应用滚动更新</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/sig-apps/code-analysis-of-statefulset-controller/" class="">Statefulset Controller 源码分析</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>sig-network</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/sig-network/learn-about-Service/" class="">深入了解 Service</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>sig-node</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/sig-node/kubelet-topology-manager/" class="">Topology Manager 设计方案</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/sig-node/kubelet-eviction-manager/" class="">Eviction Manager 工作机制</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>sig-scheduling</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/sig-scheduling/advanced-scheduling/" class="">高级调度</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>











  
<ul>
  
  <li>
    <a href="/posts/" >
        Blog
      </a>
  </li>
  
  <li>
    <a href="https://github.com/howieyuen/" target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
  <li>
    <a href="https://themes.gohugo.io/hugo-book/" target="_blank" rel="noopener">
        Hugo Themes
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>DaemonSet Controller 源码分析</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  <nav id="TableOfContents">
  <ul>
    <li><a href="#1-daemonset-简介">1. DaemonSet 简介</a>
      <ul>
        <li><a href="#11-应用场景">1.1 应用场景</a></li>
        <li><a href="#12-基本功能">1.2 基本功能</a></li>
        <li><a href="#13-示例">1.3 示例</a></li>
      </ul>
    </li>
    <li><a href="#2-源码分析">2. 源码分析</a>
      <ul>
        <li><a href="#21-startdaemonsetcontroller">2.1 startDaemonSetController()</a></li>
        <li><a href="#22-run">2.2 Run()</a></li>
        <li><a href="#23-syncdaemonset">2.3 syncDaemonSet()</a></li>
        <li><a href="#24-dscmanage">2.4 dsc.manage()</a></li>
        <li><a href="#25-dscrollingupdate">2.5 dsc.rollingUpdate()</a></li>
        <li><a href="#26-dscupdatedaemonsetstatus">2.6 dsc.updateDaemonSetStatus()</a></li>
        <li><a href="#27-源码分析小结">2.7 源码分析小结</a></li>
      </ul>
    </li>
    <li><a href="#3-总结">3. 总结</a></li>
    <li><a href="#4-参考资料">4. 参考资料</a></li>
  </ul>
</nav>


  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="1-daemonset-简介">
  1. DaemonSet 简介
  <a class="anchor" href="#1-daemonset-%e7%ae%80%e4%bb%8b">#</a>
</h1>
<p>我们知道，Deployment 是用来部署一定数量的 Pod。但是，当你希望 Pod 在集群中的每个节点上运行，并且每个节点上都需要一个 Pod 实例时，Deployment 就无法满足需求。</p>
<p>这类需求包括 Pod 执行系统级别与基础结构相关的操作，比如：希望在每个节点上运行日志收集器和资源监控组件。另一个典型的例子，就是 Kubernetes 自己的 kube-proxy 进程，它需要在所有节点上都运行，才能使得 Service 正常工作。</p>
<p>如此，DaemonSet 应运而生。它能确保集群中每个节点或者是满足某些特性的一组节点都运行一个 Pod 副本。当有新节点加入时，也会立即为它部署一个 Pod；当有节点从集群中删除时，Pod 也会被回收。删除 DaemonSet，也会删除所有关联的 Pod。</p>
<h2 id="11-应用场景">
  1.1 应用场景
  <a class="anchor" href="#11-%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af">#</a>
</h2>
<ul>
<li>在每个节点上运行集群存守护进程</li>
<li>在每个节点上运行日志收集守护进程</li>
<li>在每个节点上运行监控守护进程</li>
</ul>
<p>一种简单的用法是为每种类型的守护进程在所有的节点上都启动一个 DaemonSet。 一个稍微复杂的用法是为同一种守护进程部署多个 DaemonSet；每个具有不同的标志，并且对不同硬件类型具有不同的内存、CPU 等要求。</p>
<h2 id="12-基本功能">
  1.2 基本功能
  <a class="anchor" href="#12-%e5%9f%ba%e6%9c%ac%e5%8a%9f%e8%83%bd">#</a>
</h2>
<ul>
<li>创建</li>
<li>删除
<ul>
<li>级联删除：<code>kubectl delete ds/nginx-ds</code></li>
<li>非级联删除：<code>kubectl delete ds/nginx-ds --cascade=false</code></li>
</ul>
</li>
<li>更新
<ul>
<li>RollingUpdate</li>
<li>OnDelete</li>
</ul>
</li>
<li>回滚</li>
</ul>
<h2 id="13-示例">
  1.3 示例
  <a class="anchor" href="#13-%e7%a4%ba%e4%be%8b">#</a>
</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DaemonSet</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fluentd-elasticsearch</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">fluentd-logging</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fluentd-elasticsearch</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fluentd-elasticsearch</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">tolerations</span>:
      <span style="color:#75715e"># this toleration is to have the daemonset runnable on master nodes</span>
      <span style="color:#75715e"># remove it if your masters can&#39;t run pods</span>
      - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">node-role.kubernetes.io/master</span>
        <span style="color:#f92672">effect</span>: <span style="color:#ae81ff">NoSchedule</span>
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">fluentd-elasticsearch</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">quay.io/fluentd_elasticsearch/fluentd:v2.5.2</span>
        <span style="color:#f92672">resources</span>:
          <span style="color:#f92672">limits</span>:
            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">200Mi</span>
          <span style="color:#f92672">requests</span>:
            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">100m</span>
            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">200Mi</span>
        <span style="color:#f92672">volumeMounts</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varlog</span>
          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/log</span>
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varlibdockercontainers</span>
          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/lib/docker/containers</span>
          <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">true</span>
      <span style="color:#f92672">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">30</span>
      <span style="color:#f92672">volumes</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varlog</span>
        <span style="color:#f92672">hostPath</span>:
          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/var/log</span>
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">varlibdockercontainers</span>
        <span style="color:#f92672">hostPath</span>:
          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/var/lib/docker/containers</span>
</code></pre></div><h1 id="2-源码分析">
  2. 源码分析
  <a class="anchor" href="#2-%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90">#</a>
</h1>
<blockquote>
<p>kubernetes version: v1.19</p>
</blockquote>
<h2 id="21-startdaemonsetcontroller">
  2.1 startDaemonSetController()
  <a class="anchor" href="#21-startdaemonsetcontroller">#</a>
</h2>
<p>与其他资源的 Controller 启动方式一致，在 <code>startDaemonSetController()</code> 中初始化 DaemonSetController 对象，并调用 <code>Run()</code> 方法启动。从该方法可以看出，DaemonSet Controller 关心的是 <code>daemonset</code>、<code>controllerrevision</code>、<code>pod</code>、<code>node</code> 四种资源的变动，其中 <code>ConcurrentDaemonSetSyncs</code>  默认是 2。</p>
<p><code>cmd/kube-controller-manager/app/apps.go:36</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">startDaemonSetController</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">ControllerContext</span>) (<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handler</span>, <span style="color:#66d9ef">bool</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">AvailableResources</span>[<span style="color:#a6e22e">schema</span>.<span style="color:#a6e22e">GroupVersionResource</span>{<span style="color:#a6e22e">Group</span>: <span style="color:#e6db74">&#34;apps&#34;</span>, <span style="color:#a6e22e">Version</span>: <span style="color:#e6db74">&#34;v1&#34;</span>, <span style="color:#a6e22e">Resource</span>: <span style="color:#e6db74">&#34;daemonsets&#34;</span>}] {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">nil</span>
	}
	<span style="color:#a6e22e">dsc</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">NewDaemonSetsController</span>(
		<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">InformerFactory</span>.<span style="color:#a6e22e">Apps</span>().<span style="color:#a6e22e">V1</span>().<span style="color:#a6e22e">DaemonSets</span>(),
		<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">InformerFactory</span>.<span style="color:#a6e22e">Apps</span>().<span style="color:#a6e22e">V1</span>().<span style="color:#a6e22e">ControllerRevisions</span>(),
		<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">InformerFactory</span>.<span style="color:#a6e22e">Core</span>().<span style="color:#a6e22e">V1</span>().<span style="color:#a6e22e">Pods</span>(),
		<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">InformerFactory</span>.<span style="color:#a6e22e">Core</span>().<span style="color:#a6e22e">V1</span>().<span style="color:#a6e22e">Nodes</span>(),
		<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">ClientBuilder</span>.<span style="color:#a6e22e">ClientOrDie</span>(<span style="color:#e6db74">&#34;daemon-set-controller&#34;</span>),
		<span style="color:#a6e22e">flowcontrol</span>.<span style="color:#a6e22e">NewBackOff</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>, <span style="color:#ae81ff">15</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Minute</span>),
	)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">true</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;error creating DaemonSets controller: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">Run</span>(int(<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">ComponentConfig</span>.<span style="color:#a6e22e">DaemonSetController</span>.<span style="color:#a6e22e">ConcurrentDaemonSetSyncs</span>), <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Stop</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><h2 id="22-run">
  2.2 Run()
  <a class="anchor" href="#22-run">#</a>
</h2>
<p>Run() 方法中执行 2 个核心操作：<code>sync</code> 和 <code>gc</code>。其中 sync 操作是 controller 的核心代码，响应上述所有操作。在初始化 controller 对象时，指定了 <code>failedPodsBackoff</code> 的参数，<code>defaultDuration = 1s</code>，<code>maxDuration = 15min</code>；<code>gc</code> 的主要作用是发现 daemonset 的 pod 的 phase 为 failed，就会重启该 Pod，如果已经超时（2*15min）会删除该条记录。</p>
<p><code>pkg/controller/daemon/daemon_controller.go:281</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">dsc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DaemonSetsController</span>) <span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">workers</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">stopCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) {
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleCrash</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">ShutDown</span>()

	<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Starting daemon sets controller&#34;</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Shutting down daemon sets controller&#34;</span>)

	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">WaitForNamedCacheSync</span>(<span style="color:#e6db74">&#34;daemon sets&#34;</span>, <span style="color:#a6e22e">stopCh</span>, <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">podStoreSynced</span>, <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">nodeStoreSynced</span>, <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">historyStoreSynced</span>, <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">dsStoreSynced</span>) {
		<span style="color:#66d9ef">return</span>
	}

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">workers</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#75715e">// sync
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">Until</span>(<span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">runWorker</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>, <span style="color:#a6e22e">stopCh</span>)
	}
	<span style="color:#75715e">// gc
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">Until</span>(<span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">failedPodsBackoff</span>.<span style="color:#a6e22e">GC</span>, <span style="color:#a6e22e">BackoffGCInterval</span>, <span style="color:#a6e22e">stopCh</span>)

	<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">stopCh</span>
}
</code></pre></div><h2 id="23-syncdaemonset">
  2.3 syncDaemonSet()
  <a class="anchor" href="#23-syncdaemonset">#</a>
</h2>
<p>DaemonSet 的 Pod 的创建/删除都是和 Node 相关，所以每次 <code>sync</code> 操作，需要遍历所有的 Node 进行判断。<code>syncDaemonSet()</code> 的主要逻辑为：</p>
<ol>
<li>通过 key 获取 ns 和 name</li>
<li>从 dsLister 获取 ds 对象</li>
<li>从 nodeLister 获取全部 node 对象</li>
<li>获取 dsKey， 即：<code>&lt;namespace&gt;/&lt;name&gt;</code></li>
<li>判断 ds 是否处于删除中，如果正在删除，则等待删除完毕后再次进入 sync</li>
<li>获取 cur 和 old <code>controllerrevision</code></li>
<li>判断是否满足 <code>expectation</code> 机制，<code>expectation</code> 机制就是为了减少不必要的 <code>sync</code> 操作</li>
<li>调用 <code>dsc.manage()</code>，执行实际的 sync  操作</li>
<li>判断是否为更新操作，并执行</li>
<li>调用 <code>dsc.cleanupHistory()</code> 根据 <code>spec.revisionHistroyLimit</code> 清理过期的 <code>controllerrevision</code></li>
<li>调用 <code>dsc.updateDaemonSetStatus()</code>，更新 status 子资源</li>
</ol>
<p><code>pkg/controller/daemon/daemon_controller.go:1129</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">dsc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DaemonSetsController</span>) <span style="color:#a6e22e">syncDaemonSet</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#f92672">...</span>
    
	<span style="color:#75715e">// 1. 通过 key 获取 ns 和 name
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">namespace</span>, <span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">SplitMetaNamespaceKey</span>(<span style="color:#a6e22e">key</span>)
	<span style="color:#f92672">...</span>
    
	<span style="color:#75715e">// 2. 从 dsLister 获取 ds 对象
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ds</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">dsLister</span>.<span style="color:#a6e22e">DaemonSets</span>(<span style="color:#a6e22e">namespace</span>).<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">name</span>)
	<span style="color:#f92672">...</span>

	<span style="color:#75715e">// 3. 从 nodeLister 获取全部 node 对象
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">nodeList</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">nodeLister</span>.<span style="color:#a6e22e">List</span>(<span style="color:#a6e22e">labels</span>.<span style="color:#a6e22e">Everything</span>())
	<span style="color:#f92672">...</span>
    
	<span style="color:#75715e">// 4. 获取 dsKey， 即：&lt;namespace&gt;/&lt;name&gt;
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">dsKey</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">KeyFunc</span>(<span style="color:#a6e22e">ds</span>)
	<span style="color:#f92672">...</span>
	
	<span style="color:#75715e">// 5. 判断 ds 是否处于删除中，如果正在删除，则等待删除完毕后再次进入 sync
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ds</span>.<span style="color:#a6e22e">DeletionTimestamp</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#75715e">// 6. 获取 cur 和 old controllerrevision
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">cur</span>, <span style="color:#a6e22e">old</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">constructHistory</span>(<span style="color:#a6e22e">ds</span>)
	<span style="color:#75715e">// hash 就是当前 controllerrevision 的 controller-revision-hash 值
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">hash</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cur</span>.<span style="color:#a6e22e">Labels</span>[<span style="color:#a6e22e">apps</span>.<span style="color:#a6e22e">DefaultDaemonSetUniqueLabelKey</span>]

	<span style="color:#75715e">// 7. 判断是否满足 expectation 机制
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">expectations</span>.<span style="color:#a6e22e">SatisfiedExpectations</span>(<span style="color:#a6e22e">dsKey</span>) {
		<span style="color:#75715e">// 不满足，只更新 status 子资源
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">updateDaemonSetStatus</span>(<span style="color:#a6e22e">ds</span>, <span style="color:#a6e22e">nodeList</span>, <span style="color:#a6e22e">hash</span>, <span style="color:#66d9ef">false</span>)
	}

	<span style="color:#75715e">// 8. 实际执行的 sync  操作
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">manage</span>(<span style="color:#a6e22e">ds</span>, <span style="color:#a6e22e">nodeList</span>, <span style="color:#a6e22e">hash</span>)
	<span style="color:#f92672">...</span>

	<span style="color:#75715e">// 9. 判断是否为更新操作，并执行
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">expectations</span>.<span style="color:#a6e22e">SatisfiedExpectations</span>(<span style="color:#a6e22e">dsKey</span>) {
		<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">ds</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">UpdateStrategy</span>.<span style="color:#a6e22e">Type</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">apps</span>.<span style="color:#a6e22e">OnDeleteDaemonSetStrategyType</span>:
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">apps</span>.<span style="color:#a6e22e">RollingUpdateDaemonSetStrategyType</span>:
			<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">rollingUpdate</span>(<span style="color:#a6e22e">ds</span>, <span style="color:#a6e22e">nodeList</span>, <span style="color:#a6e22e">hash</span>)
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
	}

	<span style="color:#75715e">// 10. 清理过期的 controllerrevision
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">cleanupHistory</span>(<span style="color:#a6e22e">ds</span>, <span style="color:#a6e22e">old</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to clean up revisions of DaemonSet: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
	}

	<span style="color:#75715e">// 11. 最后更新 status 子资源
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">updateDaemonSetStatus</span>(<span style="color:#a6e22e">ds</span>, <span style="color:#a6e22e">nodeList</span>, <span style="color:#a6e22e">hash</span>, <span style="color:#66d9ef">true</span>)
}
</code></pre></div><h2 id="24-dscmanage">
  2.4 dsc.manage()
  <a class="anchor" href="#24-dscmanage">#</a>
</h2>
<p><code>dsc.manage()</code> 是为了保证ds 的 Pod 正常运行在应该存在的节点，该方法做了这几件事：</p>
<ol>
<li>调用 <code>dsc.getNodesToDaemonPods()</code>，获取当前的节点和 daemon pod 的映射关系（<code>map[nodeName][]*v1.Pod</code>）</li>
<li>遍历所有节点，判断每个节点是需要创建还是删除 daemonset pod</li>
<li>从 1.12 开始，daemon pod 已经由 <code>kube-scheduler</code> 负责调度，可能会出现把 daemon pod 调度到不存在的节点上，如果存在这种情况，就要删除该 pod</li>
<li>调用 <code>dsc.syncNodes()</code> 为对应的 node 创建 daemon pod 以及删除多余的 pods；</li>
</ol>
<p><code>pkg/controller/daemon/daemon_controller.go:881</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">dsc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DaemonSetsController</span>) <span style="color:#a6e22e">manage</span>(<span style="color:#a6e22e">ds</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">apps</span>.<span style="color:#a6e22e">DaemonSet</span>, <span style="color:#a6e22e">nodeList</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Node</span>, <span style="color:#a6e22e">hash</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#75715e">// 1. 找到节点和 ds 创建的 Pod 的映射关系（nodeName:[]Pod{}）
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">nodeToDaemonPods</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">getNodesToDaemonPods</span>(<span style="color:#a6e22e">ds</span>)
	<span style="color:#f92672">...</span>

	<span style="color:#75715e">// 2. 检查每个节点是否应当运行该 daemonset 的 Pod，如果不该运行就要删掉，反之就要创建
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">nodesNeedingDaemonPods</span>, <span style="color:#a6e22e">podsToDelete</span> []<span style="color:#66d9ef">string</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">node</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">nodeList</span> {
		<span style="color:#a6e22e">nodesNeedingDaemonPodsOnNode</span>, <span style="color:#a6e22e">podsToDeleteOnNode</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">podsShouldBeOnNode</span>(
			<span style="color:#a6e22e">node</span>, <span style="color:#a6e22e">nodeToDaemonPods</span>, <span style="color:#a6e22e">ds</span>)

		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">continue</span>
		}

		<span style="color:#a6e22e">nodesNeedingDaemonPods</span> = append(<span style="color:#a6e22e">nodesNeedingDaemonPods</span>, <span style="color:#a6e22e">nodesNeedingDaemonPodsOnNode</span><span style="color:#f92672">...</span>)
		<span style="color:#a6e22e">podsToDelete</span> = append(<span style="color:#a6e22e">podsToDelete</span>, <span style="color:#a6e22e">podsToDeleteOnNode</span><span style="color:#f92672">...</span>)
	}

    <span style="color:#75715e">// 3. 调用 getUnscheduledPodsWithoutNode() 方法找到把调度到不存在的节点的 Pod
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">podsToDelete</span> = append(<span style="color:#a6e22e">podsToDelete</span>, <span style="color:#a6e22e">getUnscheduledPodsWithoutNode</span>(<span style="color:#a6e22e">nodeList</span>, <span style="color:#a6e22e">nodeToDaemonPods</span>)<span style="color:#f92672">...</span>)

    <span style="color:#75715e">// 4. 调用 dsc.syncNodes()，删除多余的Pod，为应该运行 daemonset Pod 的 node 创建Pod
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">syncNodes</span>(<span style="color:#a6e22e">ds</span>, <span style="color:#a6e22e">podsToDelete</span>, <span style="color:#a6e22e">nodesNeedingDaemonPods</span>, <span style="color:#a6e22e">hash</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>下面继续看下 <code>dsc.podsShouldBeOnNode()</code> 和 <code>dsc.syncNodes()</code> 两个方法的具体逻辑：</p>
<p>其中，<code>podsShouldBeOnNode()</code> 主要是为了确定在给定节点上的是需要创建还是删除 daemon pod。主要逻辑为：</p>
<ol>
<li>调用 <code>dsc.nodeShouldRunDaemonPod</code> 判断该 node 是否要运行以及是否能继续运行 ds pod</li>
<li>获取该节点上的 daemon pod 列表</li>
<li>根据 <code>shouldRun</code>、<code>shouldContinueRunning</code> 和 <code>exists</code>（daemon pod 的存在状态），进行下一步
<ol>
<li>如果节点应该运行而没有运行，则创建该 Pod</li>
<li>如果 daemon pods 应该继续在此节点上运行，遍历每个 daemon pod，且
<ol>
<li>pod 在删除中，暂且不管</li>
<li>pod 处于 failed 状态，则删除 pod</li>
<li>daemon pods 数量 &gt; 1，则保留最早创建的 pod，其余都删除</li>
</ol>
</li>
<li>如果 pod 不需要继续运行但 pod 已存在，则需要删除</li>
</ol>
</li>
<li>最终返回需要运行 daemon pod 的节点集合和待删除 pod 的集合</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">dsc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DaemonSetsController</span>) <span style="color:#a6e22e">podsShouldBeOnNode</span>(
	<span style="color:#a6e22e">node</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Node</span>,
	<span style="color:#a6e22e">nodeToDaemonPods</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>][]<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>,
	<span style="color:#a6e22e">ds</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">apps</span>.<span style="color:#a6e22e">DaemonSet</span>,
) (<span style="color:#a6e22e">nodesNeedingDaemonPods</span>, <span style="color:#a6e22e">podsToDelete</span> []<span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
	<span style="color:#75715e">// 1. 判断该 node 是否要运行以及是否能继续运行 ds pod
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">shouldRun</span>, <span style="color:#a6e22e">shouldContinueRunning</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">nodeShouldRunDaemonPod</span>(<span style="color:#a6e22e">node</span>, <span style="color:#a6e22e">ds</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#75715e">// 2. 获取该节点上的该 daemon pod 列表
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">daemonPods</span>, <span style="color:#a6e22e">exists</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">nodeToDaemonPods</span>[<span style="color:#a6e22e">node</span>.<span style="color:#a6e22e">Name</span>]

	<span style="color:#66d9ef">switch</span> {
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">shouldRun</span> <span style="color:#f92672">&amp;&amp;</span> !<span style="color:#a6e22e">exists</span>:
		<span style="color:#75715e">// 3.1 如果节点应该运行而没有运行，则创建该 Pod
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">nodesNeedingDaemonPods</span> = append(<span style="color:#a6e22e">nodesNeedingDaemonPods</span>, <span style="color:#a6e22e">node</span>.<span style="color:#a6e22e">Name</span>)
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">shouldContinueRunning</span>:
		<span style="color:#75715e">// 3.2. 如果 daemon pod应该继续在此节点上运行
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">daemonPodsRunning</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">pod</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">daemonPods</span> {
			<span style="color:#75715e">// 3.2.1 pod 在删除中，暂且不管
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">DeletionTimestamp</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#66d9ef">continue</span>
			}
			<span style="color:#75715e">// 3.2.2 pod 处于 failed 状态，则删除 pod
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">Phase</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">PodFailed</span> {
				<span style="color:#75715e">// This is a critical place where DS is often fighting with kubelet that rejects pods.
</span><span style="color:#75715e"></span>				<span style="color:#75715e">// We need to avoid hot looping and backoff.
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">backoffKey</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">failedPodsBackoffKey</span>(<span style="color:#a6e22e">ds</span>, <span style="color:#a6e22e">node</span>.<span style="color:#a6e22e">Name</span>)

				<span style="color:#a6e22e">now</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">failedPodsBackoff</span>.<span style="color:#a6e22e">Clock</span>.<span style="color:#a6e22e">Now</span>()
				<span style="color:#a6e22e">inBackoff</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">failedPodsBackoff</span>.<span style="color:#a6e22e">IsInBackOffSinceUpdate</span>(<span style="color:#a6e22e">backoffKey</span>, <span style="color:#a6e22e">now</span>)
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">inBackoff</span> {
					<span style="color:#a6e22e">delay</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">failedPodsBackoff</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">backoffKey</span>)
					<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">4</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Deleting failed pod %s/%s on node %s has been limited by backoff - %v remaining&#34;</span>,
						<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Namespace</span>, <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">node</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">delay</span>)
					<span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">enqueueDaemonSetAfter</span>(<span style="color:#a6e22e">ds</span>, <span style="color:#a6e22e">delay</span>)
					<span style="color:#66d9ef">continue</span>
				}

				<span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">failedPodsBackoff</span>.<span style="color:#a6e22e">Next</span>(<span style="color:#a6e22e">backoffKey</span>, <span style="color:#a6e22e">now</span>)

				<span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;Found failed daemon pod %s/%s on node %s, will try to kill it&#34;</span>, <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Namespace</span>, <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">node</span>.<span style="color:#a6e22e">Name</span>)
				<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">2</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#a6e22e">msg</span>)
				<span style="color:#75715e">// Emit an event so that it&#39;s discoverable to users.
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">eventRecorder</span>.<span style="color:#a6e22e">Eventf</span>(<span style="color:#a6e22e">ds</span>, <span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">EventTypeWarning</span>, <span style="color:#a6e22e">FailedDaemonPodReason</span>, <span style="color:#a6e22e">msg</span>)
				<span style="color:#a6e22e">podsToDelete</span> = append(<span style="color:#a6e22e">podsToDelete</span>, <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Name</span>)
			} <span style="color:#66d9ef">else</span> {
				<span style="color:#a6e22e">daemonPodsRunning</span> = append(<span style="color:#a6e22e">daemonPodsRunning</span>, <span style="color:#a6e22e">pod</span>)
			}
		}
		<span style="color:#75715e">// 3.2.3 如果 daemon pod 应该在此节点上运行，但存在的pod数 &gt; 1，则保留最早创建的pod，其余删除
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">daemonPodsRunning</span>) &gt; <span style="color:#ae81ff">1</span> {
			<span style="color:#a6e22e">sort</span>.<span style="color:#a6e22e">Sort</span>(<span style="color:#a6e22e">podByCreationTimestampAndPhase</span>(<span style="color:#a6e22e">daemonPodsRunning</span>))
			<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> &lt; len(<span style="color:#a6e22e">daemonPodsRunning</span>); <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
				<span style="color:#a6e22e">podsToDelete</span> = append(<span style="color:#a6e22e">podsToDelete</span>, <span style="color:#a6e22e">daemonPodsRunning</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">Name</span>)
			}
		}
	<span style="color:#66d9ef">case</span> !<span style="color:#a6e22e">shouldContinueRunning</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">exists</span>:
		<span style="color:#75715e">// 3.3 如果 pod 不需要继续运行但 pod 已存在则需要删除 pod
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">pod</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">daemonPods</span> {
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">DeletionTimestamp</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#66d9ef">continue</span>
			}
			<span style="color:#a6e22e">podsToDelete</span> = append(<span style="color:#a6e22e">podsToDelete</span>, <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Name</span>)
		}
	}
    <span style="color:#75715e">// 4. 最终返回需要运行 daemon pod 的节点集合和待删除 pod 集合
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">nodesNeedingDaemonPods</span>, <span style="color:#a6e22e">podsToDelete</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>继续看 <code>dsc.syncNode()</code>，该方法主要是为需要 daemon pod 的 node 创建 pod 以及删除多余的 pod，其主要逻辑为：</p>
<ol>
<li>将 <code>createDiff</code> 和 <code>deleteDiff</code> 与 <code>burstReplicas</code> 进行比较，<code>burstReplicas</code> 默认值为 250，即每个 syncLoop 中创建或者删除的 pod 数最多为 250 个，若超过其值则剩余需要创建或者删除的 pod 在下一个 syncLoop 继续操作；</li>
<li>将 <code>createDiff</code> 和 <code>deleteDiff</code> 写入到 <code>expectations</code> 中；</li>
<li>并发创建 pod，通过 <code>nodeAffinity</code> 来保证每个节点都运行一个 pod；</li>
<li>并发删除 <code>deleteDiff</code> 中的所有 pod；</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">dsc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DaemonSetsController</span>) <span style="color:#a6e22e">syncNodes</span>(<span style="color:#a6e22e">ds</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">apps</span>.<span style="color:#a6e22e">DaemonSet</span>, <span style="color:#a6e22e">podsToDelete</span>, <span style="color:#a6e22e">nodesNeedingDaemonPods</span> []<span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">hash</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#75715e">// 1. 取 ds 的 key (namespace/name)
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">dsKey</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">KeyFunc</span>(<span style="color:#a6e22e">ds</span>)
	<span style="color:#f92672">...</span>
	<span style="color:#75715e">// 2. 设置创删过程中可超过的副本数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">createDiff</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">nodesNeedingDaemonPods</span>)
	<span style="color:#a6e22e">deleteDiff</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">podsToDelete</span>)

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">createDiff</span> &gt; <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">burstReplicas</span> {
		<span style="color:#a6e22e">createDiff</span> = <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">burstReplicas</span>
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">deleteDiff</span> &gt; <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">burstReplicas</span> {
		<span style="color:#a6e22e">deleteDiff</span> = <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">burstReplicas</span>
	}

	<span style="color:#75715e">// 3. 设置 expectation
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">expectations</span>.<span style="color:#a6e22e">SetExpectations</span>(<span style="color:#a6e22e">dsKey</span>, <span style="color:#a6e22e">createDiff</span>, <span style="color:#a6e22e">deleteDiff</span>)

	<span style="color:#75715e">// error channel to communicate back failures.  make the buffer big enough to avoid any blocking
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">errCh</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">error</span>, <span style="color:#a6e22e">createDiff</span><span style="color:#f92672">+</span><span style="color:#a6e22e">deleteDiff</span>)

	<span style="color:#a6e22e">createWait</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>{}
	
	<span style="color:#a6e22e">generation</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">GetTemplateGeneration</span>(<span style="color:#a6e22e">ds</span>)
	<span style="color:#f92672">...</span>
	<span style="color:#a6e22e">template</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">CreatePodTemplate</span>(<span style="color:#a6e22e">ds</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Template</span>, <span style="color:#a6e22e">generation</span>, <span style="color:#a6e22e">hash</span>)
	
	<span style="color:#75715e">// 4. 并发创建 pod，创建的 pod 数依次为 1, 2, 4, 8, ...
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">batchSize</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">integer</span>.<span style="color:#a6e22e">IntMin</span>(<span style="color:#a6e22e">createDiff</span>, <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">SlowStartInitialBatchSize</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">pos</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">createDiff</span> &gt; <span style="color:#a6e22e">pos</span>; <span style="color:#a6e22e">batchSize</span>, <span style="color:#a6e22e">pos</span> = <span style="color:#a6e22e">integer</span>.<span style="color:#a6e22e">IntMin</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#a6e22e">batchSize</span>, <span style="color:#a6e22e">createDiff</span><span style="color:#f92672">-</span>(<span style="color:#a6e22e">pos</span><span style="color:#f92672">+</span><span style="color:#a6e22e">batchSize</span>)), <span style="color:#a6e22e">pos</span><span style="color:#f92672">+</span><span style="color:#a6e22e">batchSize</span> {
		<span style="color:#a6e22e">errorCount</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">errCh</span>)
		<span style="color:#a6e22e">createWait</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">batchSize</span>)
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pos</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">pos</span><span style="color:#f92672">+</span><span style="color:#a6e22e">batchSize</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
			<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ix</span> <span style="color:#66d9ef">int</span>) {
				<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">createWait</span>.<span style="color:#a6e22e">Done</span>()

				<span style="color:#a6e22e">podTemplate</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">template</span>.<span style="color:#a6e22e">DeepCopy</span>()
				
				<span style="color:#75715e">// 5. 使用节点亲和性完成 daemon pod 调度
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">podTemplate</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Affinity</span> = <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">ReplaceDaemonSetPodNodeNameNodeAffinity</span>(
					<span style="color:#a6e22e">podTemplate</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Affinity</span>, <span style="color:#a6e22e">nodesNeedingDaemonPods</span>[<span style="color:#a6e22e">ix</span>])

				<span style="color:#75715e">// 6. 创建Pod 带上 ControllerRef
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">podControl</span>.<span style="color:#a6e22e">CreatePodsWithControllerRef</span>(<span style="color:#a6e22e">ds</span>.<span style="color:#a6e22e">Namespace</span>, <span style="color:#a6e22e">podTemplate</span>,
					<span style="color:#a6e22e">ds</span>, <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">NewControllerRef</span>(<span style="color:#a6e22e">ds</span>, <span style="color:#a6e22e">controllerKind</span>))

				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
					<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">HasStatusCause</span>(<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">NamespaceTerminatingCause</span>) {
						<span style="color:#75715e">// 如果此时namespace被删除，这里错误可以忽略
</span><span style="color:#75715e"></span>						<span style="color:#66d9ef">return</span>
					}
				}
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
					<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">2</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Failed creation, decrementing expectations for set %q/%q&#34;</span>, <span style="color:#a6e22e">ds</span>.<span style="color:#a6e22e">Namespace</span>, <span style="color:#a6e22e">ds</span>.<span style="color:#a6e22e">Name</span>)
					<span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">expectations</span>.<span style="color:#a6e22e">CreationObserved</span>(<span style="color:#a6e22e">dsKey</span>)
					<span style="color:#a6e22e">errCh</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">err</span>
					<span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleError</span>(<span style="color:#a6e22e">err</span>)
				}
			}(<span style="color:#a6e22e">i</span>)
		}
		<span style="color:#a6e22e">createWait</span>.<span style="color:#a6e22e">Wait</span>()
	
		<span style="color:#75715e">// 6. 将创建失败的 Pod 记录到 expectation 中
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">skippedPods</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">createDiff</span> <span style="color:#f92672">-</span> (<span style="color:#a6e22e">batchSize</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">pos</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">errorCount</span> &lt; len(<span style="color:#a6e22e">errCh</span>) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">skippedPods</span> &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">2</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Slow-start failure. Skipping creation of %d pods, decrementing expectations for set %q/%q&#34;</span>, <span style="color:#a6e22e">skippedPods</span>, <span style="color:#a6e22e">ds</span>.<span style="color:#a6e22e">Namespace</span>, <span style="color:#a6e22e">ds</span>.<span style="color:#a6e22e">Name</span>)
			<span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">expectations</span>.<span style="color:#a6e22e">LowerExpectations</span>(<span style="color:#a6e22e">dsKey</span>, <span style="color:#a6e22e">skippedPods</span>, <span style="color:#ae81ff">0</span>)
			<span style="color:#75715e">// skippedPod 会在下轮 sync 时重试
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">break</span>
		}
	}

	<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">4</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Pods to delete for daemon set %s: %+v, deleting %d&#34;</span>, <span style="color:#a6e22e">ds</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">podsToDelete</span>, <span style="color:#a6e22e">deleteDiff</span>)
	<span style="color:#a6e22e">deleteWait</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>{}
	<span style="color:#a6e22e">deleteWait</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">deleteDiff</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">deleteDiff</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#75715e">// 7. 并发删除 deleteDiff 中的 pod
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ix</span> <span style="color:#66d9ef">int</span>) {
			<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">deleteWait</span>.<span style="color:#a6e22e">Done</span>()
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">podControl</span>.<span style="color:#a6e22e">DeletePod</span>(<span style="color:#a6e22e">ds</span>.<span style="color:#a6e22e">Namespace</span>, <span style="color:#a6e22e">podsToDelete</span>[<span style="color:#a6e22e">ix</span>], <span style="color:#a6e22e">ds</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">expectations</span>.<span style="color:#a6e22e">DeletionObserved</span>(<span style="color:#a6e22e">dsKey</span>)
				<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">apierrors</span>.<span style="color:#a6e22e">IsNotFound</span>(<span style="color:#a6e22e">err</span>) {
					<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">2</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Failed deletion, decremented expectations for set %q/%q&#34;</span>, <span style="color:#a6e22e">ds</span>.<span style="color:#a6e22e">Namespace</span>, <span style="color:#a6e22e">ds</span>.<span style="color:#a6e22e">Name</span>)
					<span style="color:#a6e22e">errCh</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">err</span>
					<span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleError</span>(<span style="color:#a6e22e">err</span>)
				}
			}
		}(<span style="color:#a6e22e">i</span>)
	}
	<span style="color:#a6e22e">deleteWait</span>.<span style="color:#a6e22e">Wait</span>()

	<span style="color:#75715e">// 收集错误返回
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">errors</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">error</span>{}
	close(<span style="color:#a6e22e">errCh</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">errCh</span> {
		<span style="color:#a6e22e">errors</span> = append(<span style="color:#a6e22e">errors</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">utilerrors</span>.<span style="color:#a6e22e">NewAggregate</span>(<span style="color:#a6e22e">errors</span>)
}
</code></pre></div><p>到此，总结一下，<code>dsc.manage()</code> 方法的主要流程：</p>


<script src="/mermaid.min.js"></script>

  <script>mermaid.initialize({
  "flowchart": {
    "useMaxWidth":true
  },
  "theme": "default"
}
)</script>




<p class="mermaid">
graph LR
    op1(dsc.manage) -->  op2(dsc.getNodesToDaemonPods)
    op1 --> op3(dsc.podsShouldBeOnNode)
    op1 --> op4(dsc.syncNodes)
    op3 --> op5(dsc.nodeShouldRunDaemonPod)
</p>

<h2 id="25-dscrollingupdate">
  2.5 dsc.rollingUpdate()
  <a class="anchor" href="#25-dscrollingupdate">#</a>
</h2>
<p>daemonset update 的方式有两种 <code>OnDelete</code> 和 <code>RollingUpdate</code>，当为 <code>OnDelete</code> 时需要用户手动删除每一个 pod 后完成更新操作，当为 <code>RollingUpdate</code> 时，daemonset controller 会自动控制升级进度。</p>
<p>当为 <code>RollingUpdate</code> 时，主要逻辑为：</p>
<ol>
<li>获取 node 与 daemon pods 的映射关系</li>
<li>根据 <code>controllerrevision</code> 的 hash 值获取所有未更新的 pods；</li>
<li>获取 <code>maxUnavailable</code>, <code>numUnavailable</code> 的 pod 数值，<code>maxUnavailable</code> 是从 ds 的 <code>rollingUpdate</code> 字段中获取的默认值为 1，<code>numUnavailable</code> 的值是通过 daemonset pod 与 node 的映射关系计算每个 node 下是否有 available pod 得到的；</li>
<li>通过 <code>oldPods</code> 获取 <code>oldAvailablePods</code>, <code>oldUnavailablePods</code> 的 pod 列表；</li>
<li>遍历 <code>oldUnavailablePods</code> 列表将需要删除的 pod 追加到 <code>oldPodsToDelete</code> 数组中。<code>oldUnavailablePods</code> 列表中的 pod 分为两种，一种处于更新中，即删除状态，一种处于未更新且异常状态，处于异常状态的都需要被删除；</li>
<li>遍历 <code>oldAvailablePods</code> 列表，此列表中的 pod 都处于正常运行状态，根据 <code>maxUnavailable</code> 值确定是否需要删除该 pod 并将需要删除的 pod 追加到 <code>oldPodsToDelete</code> 数组中；</li>
<li>调用 <code>dsc.syncNodes()</code> 删除 <code>oldPodsToDelete</code> 数组中的 pods，syncNodes 方法在 manage 阶段已经分析过，此处不再赘述；</li>
</ol>
<p><code>pkg/controller/daemon/update.go:44</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">dsc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DaemonSetsController</span>) <span style="color:#a6e22e">rollingUpdate</span>(<span style="color:#a6e22e">ds</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">apps</span>.<span style="color:#a6e22e">DaemonSet</span>, <span style="color:#a6e22e">nodeList</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Node</span>, <span style="color:#a6e22e">hash</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#75715e">// 1. 获取 node 与 daemon pods 的映射关系
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">nodeToDaemonPods</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">getNodesToDaemonPods</span>(<span style="color:#a6e22e">ds</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;couldn&#39;t get node to daemon pod mapping for daemon set %q: %v&#34;</span>, <span style="color:#a6e22e">ds</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">err</span>)
	}

	<span style="color:#75715e">// 2. 获取所有未更新的 pods
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">oldPods</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">getAllDaemonSetPods</span>(<span style="color:#a6e22e">ds</span>, <span style="color:#a6e22e">nodeToDaemonPods</span>, <span style="color:#a6e22e">hash</span>)
	<span style="color:#75715e">// 3. 计算 maxUnavailable, numUnavailable 的 pod 数值
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">maxUnavailable</span>, <span style="color:#a6e22e">numUnavailable</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">getUnavailableNumbers</span>(<span style="color:#a6e22e">ds</span>, <span style="color:#a6e22e">nodeList</span>, <span style="color:#a6e22e">nodeToDaemonPods</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;couldn&#39;t get unavailable numbers: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#75715e">// 4. 把未更新的 pods 分成 available 和 unavailable
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">oldAvailablePods</span>, <span style="color:#a6e22e">oldUnavailablePods</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">SplitByAvailablePods</span>(<span style="color:#a6e22e">ds</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">MinReadySeconds</span>, <span style="color:#a6e22e">oldPods</span>)

	<span style="color:#75715e">// 5. 将 unavailable 状态且没有删除标记的 pods 加入到 oldPodsToDelete 中
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">oldPodsToDelete</span> []<span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">4</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Marking all unavailable old pods for deletion&#34;</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">pod</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">oldUnavailablePods</span> {
		<span style="color:#75715e">// Skip terminating pods. We won&#39;t delete them again
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">DeletionTimestamp</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">continue</span>
		}
		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">4</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Marking pod %s/%s for deletion&#34;</span>, <span style="color:#a6e22e">ds</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Name</span>)
		<span style="color:#a6e22e">oldPodsToDelete</span> = append(<span style="color:#a6e22e">oldPodsToDelete</span>, <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Name</span>)
	}

	<span style="color:#75715e">// 6. 根据 maxUnavailable 值确定是否需要删除 pod
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">4</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Marking old pods for deletion&#34;</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">pod</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">oldAvailablePods</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">numUnavailable</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">maxUnavailable</span> {
			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">4</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Number of unavailable DaemonSet pods: %d, is equal to or exceeds allowed maximum: %d&#34;</span>, <span style="color:#a6e22e">numUnavailable</span>, <span style="color:#a6e22e">maxUnavailable</span>)
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">4</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Marking pod %s/%s for deletion&#34;</span>, <span style="color:#a6e22e">ds</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Name</span>)
		<span style="color:#a6e22e">oldPodsToDelete</span> = append(<span style="color:#a6e22e">oldPodsToDelete</span>, <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Name</span>)
		<span style="color:#a6e22e">numUnavailable</span><span style="color:#f92672">++</span>
	}
	<span style="color:#75715e">// 7. 调用 syncNodes 方法删除 oldPodsToDelete 数组中的 pods
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">syncNodes</span>(<span style="color:#a6e22e">ds</span>, <span style="color:#a6e22e">oldPodsToDelete</span>, []<span style="color:#66d9ef">string</span>{}, <span style="color:#a6e22e">hash</span>)
}
</code></pre></div><h2 id="26-dscupdatedaemonsetstatus">
  2.6 dsc.updateDaemonSetStatus()
  <a class="anchor" href="#26-dscupdatedaemonsetstatus">#</a>
</h2>
<p><code>dsc.updateDaemonSetStatus()</code> 是 sync 动作的最后一步，主要是用来更新 DaemonSet 的 status 子资源。ds.Status的各个字段如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">status</span>:
  <span style="color:#f92672">collisionCount</span>: <span style="color:#ae81ff">0</span>         <span style="color:#75715e"># hash 冲突数</span>
  <span style="color:#f92672">currentNumberScheduled</span>: <span style="color:#ae81ff">1</span>  <span style="color:#75715e"># 已经运行了 DaemonSet Pod 的节点数量</span>
  <span style="color:#f92672">desiredNumberScheduled</span>: <span style="color:#ae81ff">1</span>  <span style="color:#75715e"># 需要运行该DaemonSet Pod的节点数量</span>
  <span style="color:#f92672">numberAvailable</span>: <span style="color:#ae81ff">1</span>        <span style="color:#75715e"># DaemonSet Pod 状态为 Ready 且运行时间超过 Spec.MinReadySeconds 的节点数量</span>
  <span style="color:#f92672">numberUnavailable</span>: <span style="color:#ae81ff">0</span>      <span style="color:#75715e"># desiredNumberScheduled - numberAvailable 的节点数量</span>
  <span style="color:#f92672">numberMisscheduled</span>: <span style="color:#ae81ff">0</span>     <span style="color:#75715e"># 不需要运行 DeamonSet Pod 但是已经运行了的节点数量</span>
  <span style="color:#f92672">numberReady</span>: <span style="color:#ae81ff">1</span>           <span style="color:#75715e"># DaemonSet Pod状态为Ready的节点数量</span>
  <span style="color:#f92672">observedGeneration</span>: <span style="color:#ae81ff">1</span>
  <span style="color:#f92672">updatedNumberScheduled</span>: <span style="color:#ae81ff">1</span> <span style="color:#75715e"># 已经完成DaemonSet Pod更新的节点数量</span>
</code></pre></div><p>主要逻辑为：</p>
<ol>
<li>调用 <code>dsc.getNodesToDaemonPods()</code> 获取node 与已存在的 daemon pods 的映射关系；</li>
<li>遍历所有 node，调用 <code>dsc.nodeShouldRunDaemonPod()</code> 判断该 node 是否需要运行 daemon pod，然后计算 status 中的部分字段值；</li>
<li>调用 <code>storeDaemonSetStatus()</code> 更新 ds.status；</li>
<li>判断 ds 是否需要 resync；</li>
</ol>
<p><code>pkg/controller/daemon/daemon_controller.go:1075</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">dsc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DaemonSetsController</span>) <span style="color:#a6e22e">updateDaemonSetStatus</span>(<span style="color:#a6e22e">ds</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">apps</span>.<span style="color:#a6e22e">DaemonSet</span>, <span style="color:#a6e22e">nodeList</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Node</span>, <span style="color:#a6e22e">hash</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">updateObservedGen</span> <span style="color:#66d9ef">bool</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">4</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Updating daemon set status&#34;</span>)
	<span style="color:#75715e">// 1. 获取 node 与 daemon pods 的映射关系
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">nodeToDaemonPods</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">getNodesToDaemonPods</span>(<span style="color:#a6e22e">ds</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;couldn&#39;t get node to daemon pod mapping for daemon set %q: %v&#34;</span>, <span style="color:#a6e22e">ds</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">err</span>)
	}

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">desiredNumberScheduled</span>, <span style="color:#a6e22e">currentNumberScheduled</span>, <span style="color:#a6e22e">numberMisscheduled</span>, <span style="color:#a6e22e">numberReady</span>, <span style="color:#a6e22e">updatedNumberScheduled</span>, <span style="color:#a6e22e">numberAvailable</span> <span style="color:#66d9ef">int</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">node</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">nodeList</span> {
		<span style="color:#75715e">// 2. 判断该 node 是否需要运行 daemon pod
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">shouldRun</span>, <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">nodeShouldRunDaemonPod</span>(<span style="color:#a6e22e">node</span>, <span style="color:#a6e22e">ds</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}

		<span style="color:#a6e22e">scheduled</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">nodeToDaemonPods</span>[<span style="color:#a6e22e">node</span>.<span style="color:#a6e22e">Name</span>]) &gt; <span style="color:#ae81ff">0</span>
		
		<span style="color:#75715e">// 3. 计算 status 中的字段值
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">shouldRun</span> {
			<span style="color:#a6e22e">desiredNumberScheduled</span><span style="color:#f92672">++</span>
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">scheduled</span> {
				<span style="color:#a6e22e">currentNumberScheduled</span><span style="color:#f92672">++</span>
				<span style="color:#75715e">// 按照创建时间排序，最早创建在最前
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">daemonPods</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">nodeToDaemonPods</span>[<span style="color:#a6e22e">node</span>.<span style="color:#a6e22e">Name</span>]
				<span style="color:#a6e22e">sort</span>.<span style="color:#a6e22e">Sort</span>(<span style="color:#a6e22e">podByCreationTimestampAndPhase</span>(<span style="color:#a6e22e">daemonPods</span>))
				<span style="color:#a6e22e">pod</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">daemonPods</span>[<span style="color:#ae81ff">0</span>]
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">podutil</span>.<span style="color:#a6e22e">IsPodReady</span>(<span style="color:#a6e22e">pod</span>) {
					<span style="color:#a6e22e">numberReady</span><span style="color:#f92672">++</span>
					<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">podutil</span>.<span style="color:#a6e22e">IsPodAvailable</span>(<span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">ds</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">MinReadySeconds</span>, <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">Now</span>()) {
						<span style="color:#a6e22e">numberAvailable</span><span style="color:#f92672">++</span>
					}
				}
				<span style="color:#75715e">// If the returned error is not nil we have a parse error.
</span><span style="color:#75715e"></span>				<span style="color:#75715e">// The controller handles this via the hash.
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">generation</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">GetTemplateGeneration</span>(<span style="color:#a6e22e">ds</span>)
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
					<span style="color:#a6e22e">generation</span> = <span style="color:#66d9ef">nil</span>
				}
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">IsPodUpdated</span>(<span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">hash</span>, <span style="color:#a6e22e">generation</span>) {
					<span style="color:#a6e22e">updatedNumberScheduled</span><span style="color:#f92672">++</span>
				}
			}
		} <span style="color:#66d9ef">else</span> {
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">scheduled</span> {
				<span style="color:#a6e22e">numberMisscheduled</span><span style="color:#f92672">++</span>
			}
		}
	}
	<span style="color:#a6e22e">numberUnavailable</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">desiredNumberScheduled</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">numberAvailable</span>

	<span style="color:#75715e">// 4. 更新 ds.status
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">storeDaemonSetStatus</span>(<span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">kubeClient</span>.<span style="color:#a6e22e">AppsV1</span>().<span style="color:#a6e22e">DaemonSets</span>(<span style="color:#a6e22e">ds</span>.<span style="color:#a6e22e">Namespace</span>), <span style="color:#a6e22e">ds</span>, <span style="color:#a6e22e">desiredNumberScheduled</span>, <span style="color:#a6e22e">currentNumberScheduled</span>, <span style="color:#a6e22e">numberMisscheduled</span>, <span style="color:#a6e22e">numberReady</span>, <span style="color:#a6e22e">updatedNumberScheduled</span>, <span style="color:#a6e22e">numberAvailable</span>, <span style="color:#a6e22e">numberUnavailable</span>, <span style="color:#a6e22e">updateObservedGen</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;error storing status for daemon set %#v: %v&#34;</span>, <span style="color:#a6e22e">ds</span>, <span style="color:#a6e22e">err</span>)
	}

	<span style="color:#75715e">// Resync the DaemonSet after MinReadySeconds as a last line of defense to guard against clock-skew.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 5. 判断 ds 是否需要 resync
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ds</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">MinReadySeconds</span> &gt; <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">numberReady</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">numberAvailable</span> {
		<span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">enqueueDaemonSetAfter</span>(<span style="color:#a6e22e">ds</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>(<span style="color:#a6e22e">ds</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">MinReadySeconds</span>)<span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><h2 id="27-源码分析小结">
  2.7 源码分析小结
  <a class="anchor" href="#27-%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%e5%b0%8f%e7%bb%93">#</a>
</h2>


<p class="mermaid">
graph LR
op(startDaeonSetController) --> op0(dsc.Run)
op0 --> op1(dsc.syncDaemonSet)
op1 --> op1.1(dsc.manage)
op1 --> op1.2(dsc.rollingUpdate)
op1 --> op1.3(dsc.updateDaemonSetStatus)
op1.1 --> op1.1.1(dsc.getNodesToDaemonPods)
op1.1 --> op1.1.2(dsc.podsShouldBeOnNode)
op1.1 --> op1.1.3(dsc.syncNodes)
op1.1.2 --> op1.1.2.1(dsc.nodeShouldRunDaemonPod)
</p>

<h1 id="3-总结">
  3. 总结
  <a class="anchor" href="#3-%e6%80%bb%e7%bb%93">#</a>
</h1>
<p>在 daemonset controller 中可以看到许多功能都是 deployment 和 statefulset 已有的。在创建 pod 的流程与 replicaset controller 创建 pod 的流程是相似的，都使用了 <code>expectations</code> 机制并且限制了在一个 syncLoop 中最多创建或删除的 pod 数。更新方式与 statefulset 一样都有 <code>OnDelete</code> 和 <code>RollingUpdate</code> 两种， <code>OnDelete</code> 方式与 statefulset 相似，都需要手动删除对应的 pod，而  <code>RollingUpdate</code>  方式与 statefulset 和 deployment 都有点区别，<code>RollingUpdate</code> 方式更新时不支持暂停操作并且 pod 是先删除再创建的顺序进行。版本控制方式与 statefulset 的一样都是使用 <code>controllerRevision</code>。最后要说的一点是在 v1.12 及以后的版本中，使用 daemonset 创建的 pod 已不再使用直接指定 .spec.nodeName的方式绕过调度器进行调度，而是走默认调度器通过 <code>nodeAffinity</code> 的方式调度到每一个节点上。</p>
<h1 id="4-参考资料">
  4. 参考资料
  <a class="anchor" href="#4-%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99">#</a>
</h1>
<ul>
<li>
  <a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/daemonset/">DaemonSet概念</a></li>
<li>
  <a href="https://kubernetes.io/zh/docs/tasks/manage-daemon/update-daemon-set/">DaemonSet 滚动更新</a></li>
<li>
  <a href="https://cloud.tencent.com/developer/article/1555709">daemonset controller 源码分析</a></li>
</ul>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>

 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#1-daemonset-简介">1. DaemonSet 简介</a>
      <ul>
        <li><a href="#11-应用场景">1.1 应用场景</a></li>
        <li><a href="#12-基本功能">1.2 基本功能</a></li>
        <li><a href="#13-示例">1.3 示例</a></li>
      </ul>
    </li>
    <li><a href="#2-源码分析">2. 源码分析</a>
      <ul>
        <li><a href="#21-startdaemonsetcontroller">2.1 startDaemonSetController()</a></li>
        <li><a href="#22-run">2.2 Run()</a></li>
        <li><a href="#23-syncdaemonset">2.3 syncDaemonSet()</a></li>
        <li><a href="#24-dscmanage">2.4 dsc.manage()</a></li>
        <li><a href="#25-dscrollingupdate">2.5 dsc.rollingUpdate()</a></li>
        <li><a href="#26-dscupdatedaemonsetstatus">2.6 dsc.updateDaemonSetStatus()</a></li>
        <li><a href="#27-源码分析小结">2.7 源码分析小结</a></li>
      </ul>
    </li>
    <li><a href="#3-总结">3. 总结</a></li>
    <li><a href="#4-参考资料">4. 参考资料</a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>

</html>












