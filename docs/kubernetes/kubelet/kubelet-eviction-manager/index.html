<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="概述 # 在可用计算资源较少时，kubelet 为保证节点稳定性，会主动地结束一个或多个 pod 以回收短缺地资源， 这在处理内存和磁盘这种不可压缩资源时，驱逐 pod 回收资源的策略，显得尤为重要。 下面来具体研究下 Kubelet Eviction Policy 的工作机制。
kubelet 预先监控本节点的资源使用，防止资源被耗尽，保证节点稳定性。 kubelet 会预先 Fail N(&gt;=1) 个 Pod，以回收出现紧缺的资源。 kubelet 在 Fail 一个 pod 时，kill 掉 pod 内所有 container，并设置 pod.status.phase = Failed。 kubelet 按照事先设定好的 Eviction Threshold 来触发驱逐动作，实现资源回收。 驱逐信号 # 在源码 pkg/kubelet/eviction/api/types.go 中定义了以下及几种 Eviction Signals：
Eviction Signal Description memory.available := node.status.capacity[memory] - node.stats.memory.workingSet nodefs.available := node.stats.fs.available nodefs.inodesFree := node.stats.fs.inodesFree imagefs.available := node.stats.runtime.imagefs.available imagefs.inodesFree := node.stats.runtime.imagefs.inodesFree allocatableMemory.available := pod.">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="Eviction Manager 工作机制" />
<meta property="og:description" content="概述 # 在可用计算资源较少时，kubelet 为保证节点稳定性，会主动地结束一个或多个 pod 以回收短缺地资源， 这在处理内存和磁盘这种不可压缩资源时，驱逐 pod 回收资源的策略，显得尤为重要。 下面来具体研究下 Kubelet Eviction Policy 的工作机制。
kubelet 预先监控本节点的资源使用，防止资源被耗尽，保证节点稳定性。 kubelet 会预先 Fail N(&gt;=1) 个 Pod，以回收出现紧缺的资源。 kubelet 在 Fail 一个 pod 时，kill 掉 pod 内所有 container，并设置 pod.status.phase = Failed。 kubelet 按照事先设定好的 Eviction Threshold 来触发驱逐动作，实现资源回收。 驱逐信号 # 在源码 pkg/kubelet/eviction/api/types.go 中定义了以下及几种 Eviction Signals：
Eviction Signal Description memory.available := node.status.capacity[memory] - node.stats.memory.workingSet nodefs.available := node.stats.fs.available nodefs.inodesFree := node.stats.fs.inodesFree imagefs.available := node.stats.runtime.imagefs.available imagefs.inodesFree := node.stats.runtime.imagefs.inodesFree allocatableMemory.available := pod." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://howieyuen.github.io/docs/kubernetes/kubelet/kubelet-eviction-manager/" /><meta property="article:section" content="docs" />
<meta property="article:published_time" content="2020-02-26T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-02-27T19:55:28+08:00" />

<title>Eviction Manager 工作机制 | 袁昊的学习笔记</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.c58292d36b18b675680ab9baea2029204537b839ea72f258746ec0f32ce8d6c8.css" integrity="sha256-xYKS02sYtnVoCrm66iApIEU3uDnqcvJYdG7A8yzo1sg=" crossorigin="anonymous">
  <script defer src="/flexsearch.min.js"></script>
  <script defer src="/en.search.min.cb7fbe0a2b5fdbeb70dfc02cf3085cf1a7ed6f7ac0dd5ed1d9a97b843d7c92c8.js" integrity="sha256-y3&#43;&#43;Citf2&#43;tw38As8whc8aftb3rA3V7R2al7hD18ksg=" crossorigin="anonymous"></script>

  <script defer src="/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js" integrity="sha256-b2&#43;Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC&#43;NdcPIvZhzk=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><img src="/logo.jpeg" alt="Logo" /><span>袁昊的学习笔记</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li>
          
  
  

  
    <span>Golang</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-b81db6492518b1ec8f31de69b0812196" class="toggle"  />
    <label for="section-b81db6492518b1ec8f31de69b0812196" class="flex justify-between">
      <a role="button" class="">数据结构</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/golang/data-structure/chan/" class="">chan</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/golang/data-structure/map/" class="">map</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/golang/data-structure/slice/" class="">slice</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-def2dd5a69e672402d635862e3155cbd" class="toggle"  />
    <label for="section-def2dd5a69e672402d635862e3155cbd" class="flex justify-between">
      <a role="button" class="">语言基础</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/golang/language-basics/unsafe/" class="">unsafe</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/golang/language-basics/reflect/" class="">reflect</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-873194c4b0ec7a578576232c8d994c31" class="toggle"  />
    <label for="section-873194c4b0ec7a578576232c8d994c31" class="flex justify-between">
      <a role="button" class="">内存管理</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/golang/memory-manage/memory-model/" class="">内存模型</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-b2e47afb5c03c825c53136ae4cc0848f" class="toggle"  />
    <label for="section-b2e47afb5c03c825c53136ae4cc0848f" class="flex justify-between">
      <a role="button" class="">golang 工具</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/golang/tools/pprof/" class="">pprof</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Kubernetes</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-99bae3fc02ce73f8422ca93f733590ac" class="toggle"  />
    <label for="section-99bae3fc02ce73f8422ca93f733590ac" class="flex justify-between">
      <a role="button" class="">kube-apisever</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-apiserver/authorization/" class="">鉴权机制</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-apiserver/authentication/" class="">认证机制</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-apiserver/garbage-collector/" class="">垃圾回收</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-apiserver/key-design-of-etcd-watch/" class="">watch 关键设计</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-apiserver/crd/" class="">CRD 入门和使用</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-8db6df9b09828d3b4f51a3f0e8635341" class="toggle"  />
    <label for="section-8db6df9b09828d3b4f51a3f0e8635341" class="flex justify-between">
      <a role="button" class="">kube-controller-manager</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-controller-manager/code-analysis-of-garbagecollector-controller/" class="">GC Controller 源码分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-controller-manager/code-analysis-of-daemonset-controller/" class="">DaemonSet Controller 源码分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-controller-manager/code-analysis-of-statefulset-controller/" class="">Statefulset Controller 源码分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-controller-manager/k8s-apps-rolling-update/" class="">无状态应用滚动更新</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-f69546525118538b309149a83388b048" class="toggle"  />
    <label for="section-f69546525118538b309149a83388b048" class="flex justify-between">
      <a role="button" class="">kube-scheduler</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-scheduler/advanced-scheduling/" class="">高级调度</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-a5e90c89093229651c03236cd9ca0bf7" class="toggle" checked />
    <label for="section-a5e90c89093229651c03236cd9ca0bf7" class="flex justify-between">
      <a role="button" class="">kubelet</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kubelet/kubelet-topology-manager/" class="">Topology Manager 设计方案</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kubelet/kubelet-eviction-manager/" class="active">Eviction Manager 工作机制</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-a153eacbc14a16cf1bd898e9025b6121" class="toggle"  />
    <label for="section-a153eacbc14a16cf1bd898e9025b6121" class="flex justify-between">
      <a role="button" class="">sig-network</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/sig-network/svc-ep-epslice/" class="">Service 与 Endpoints、EndpointSlice 那些事</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/sig-network/learn-about-Service/" class="">深入了解 Service</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>XaC(Everything as Code)</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-87d48c1068c47e29214232148a6ffd46" class="toggle"  />
    <label for="section-87d48c1068c47e29214232148a6ffd46" class="flex justify-between">
      <a role="button" class="">Infra as Code</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/XaC/infra-as-code/getting-started-of-acorn/" class="">Acorn：k8s 应用部署框架</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/XaC/infra-as-code/terraform-workflow/" class="">Terraform 执行状态和阶段关系</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-e55a75d91330d73a365d7c5ff163ca1d" class="toggle"  />
    <label for="section-e55a75d91330d73a365d7c5ff163ca1d" class="flex justify-between">
      <a role="button" class="">Secret as Code</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/XaC/secret-as-code/helm-secrets/" class="">Helm Secrets</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/XaC/secret-as-code/kamus/" class="">Kamus</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/XaC/secret-as-code/secrets-store-csi-driver/" class="">Secrets Store CSI Driver</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/XaC/secret-as-code/sealed-secrets/" class="">Sealed Secrets</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/XaC/secret-as-code/external-secret-operator/" class="">External Secrets Operator</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-0a7e8a0838cc922d31092abb572fa971" class="toggle"  />
    <label for="section-0a7e8a0838cc922d31092abb572fa971" class="flex justify-between">
      <a role="button" class="">CI/CD Tools</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/XaC/cicd/argocd/" class="">使用 ArgoCD ApplicationSet 管理多集群</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Getting-Started</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/getting-started/monorepo/" class="">MonoRepo</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/getting-started/circle-ci/" class="">Circle CI</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Translation</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-c0f96e48b4daa204312defe713af5b04" class="toggle"  />
    <label for="section-c0f96e48b4daa204312defe713af5b04" class="flex justify-between">
      <a role="button" class="">Protocol Buffers</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/translation/protobuf/overview-of-protocal-buffers/" class="">概述</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/translation/protobuf/language-guideproto3/" class="">语言指南（proto3）</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-41d00712937ef3a8ada203a9e4f0c745" class="toggle"  />
    <label for="section-41d00712937ef3a8ada203a9e4f0c745" class="flex justify-between">
      <a role="button" class="">LeetCode</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/leetcode/0321/" class="">321. 拼接最大数</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/leetcode/0416/" class="">416. 分割等和子集</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>











  
<ul>
  
  <li>
    <a href="/posts/" >
        Blogs
      </a>
  </li>
  
  <li>
    <a href="https://github.com/howieyuen/" target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Eviction Manager 工作机制</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#概述">概述</a>
      <ul>
        <li><a href="#驱逐信号">驱逐信号</a></li>
        <li><a href="#驱逐阈值">驱逐阈值</a>
          <ul>
            <li><a href="#软驱逐策略">软驱逐策略</a></li>
            <li><a href="#硬驱逐">硬驱逐</a></li>
          </ul>
        </li>
        <li><a href="#驱逐周期">驱逐周期</a></li>
        <li><a href="#节点状态">节点状态</a></li>
        <li><a href="#节点状态振荡">节点状态振荡</a></li>
        <li><a href="#回收节点层级资源">回收节点层级资源</a>
          <ul>
            <li><a href="#使用-imagefs">使用 imagefs</a></li>
            <li><a href="#未使用-imagefs">未使用 imagefs</a></li>
          </ul>
        </li>
        <li><a href="#驱逐策略">驱逐策略</a></li>
        <li><a href="#最小驱逐回收">最小驱逐回收</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="概述">
  概述
  <a class="anchor" href="#%e6%a6%82%e8%bf%b0">#</a>
</h1>
<p>在可用计算资源较少时，kubelet 为保证节点稳定性，会主动地结束一个或多个 pod 以回收短缺地资源，
这在处理内存和磁盘这种不可压缩资源时，驱逐 pod 回收资源的策略，显得尤为重要。
下面来具体研究下 Kubelet Eviction Policy 的工作机制。</p>
<ul>
<li>kubelet 预先监控本节点的资源使用，防止资源被耗尽，保证节点稳定性。</li>
<li>kubelet 会预先 Fail N(&gt;=1) 个 Pod，以回收出现紧缺的资源。</li>
<li>kubelet 在 Fail 一个 pod 时，kill 掉 pod 内所有 container，并设置 pod.status.phase = Failed。</li>
<li>kubelet 按照事先设定好的 Eviction Threshold 来触发驱逐动作，实现资源回收。</li>
</ul>
<h2 id="驱逐信号">
  驱逐信号
  <a class="anchor" href="#%e9%a9%b1%e9%80%90%e4%bf%a1%e5%8f%b7">#</a>
</h2>
<p>在源码 <code>pkg/kubelet/eviction/api/types.go</code> 中定义了以下及几种 Eviction Signals：</p>
<table>
<thead>
<tr>
<th><strong>Eviction Signal</strong></th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>memory.available</td>
<td>:= node.status.capacity[memory] - node.stats.memory.workingSet</td>
</tr>
<tr>
<td>nodefs.available</td>
<td>:= node.stats.fs.available</td>
</tr>
<tr>
<td>nodefs.inodesFree</td>
<td>:= node.stats.fs.inodesFree</td>
</tr>
<tr>
<td>imagefs.available</td>
<td>:= node.stats.runtime.imagefs.available</td>
</tr>
<tr>
<td>imagefs.inodesFree</td>
<td>:= node.stats.runtime.imagefs.inodesFree</td>
</tr>
<tr>
<td>allocatableMemory.available</td>
<td>:= pod.allocatable - pod.workingSet</td>
</tr>
<tr>
<td>pid.available</td>
<td>:= node.MaxPID - node.NumOfRunningProcesses</td>
</tr>
</tbody>
</table>
<p>上表主要涉及三个方面，memory、file system 和 pid。其中 kubelet 值支持 2 种文件系统分区：</p>
<ol>
<li>nodefs：kubelet 用来存储 volume 和 daemon logs 等</li>
<li>imagesfs：容器运行时 ( docker 等）用来保存镜像和容器的 writable layer</li>
</ol>
<h2 id="驱逐阈值">
  驱逐阈值
  <a class="anchor" href="#%e9%a9%b1%e9%80%90%e9%98%88%e5%80%bc">#</a>
</h2>
<p>kubelet 的入参接收用户定义的 eviction signal 和 eviction threshold 的映射关系，格式如下：</p>
<p><code>[eviction-signal] [opterator] [quantity]</code></p>
<ul>
<li>支持的 signal 如上表所示；</li>
<li>operator 是关系运算符，例如<code>&lt;</code>；</li>
<li>quantity 是驱逐阈值，合法的值必须是 kubernetes 使用的数量表示，例如 1Gi 和 10% 等；</li>
</ul>
<h3 id="软驱逐策略">
  软驱逐策略
  <a class="anchor" href="#%e8%bd%af%e9%a9%b1%e9%80%90%e7%ad%96%e7%95%a5">#</a>
</h3>
<p>Soft Eviction Thresholds，它与以下三个参数配合使用：</p>
<ul>
<li><code>eviction-soft</code>：(e.g. memory.available&lt;1.5Gi) 触发软驱逐的阈值；</li>
<li><code>eviction-soft-grace-period</code>：(e.g. memory.available=1m30s) 当达到软驱逐的阈值，需要等待的时间；
在这段时间内，每 10s 会重新获取监控数据并更新 threshold 值，
如果在等待期间，最后一次的数据仍然超过阈值，才会触发驱逐 pod 的行为。</li>
<li><code>eviction-max-pod-grace-period</code>：(e.g. 30s) 当满足软驱逐阈值并终止 pod 时允许的最大宽限期值。
如果待 Evict 的 Pod 指定了<code>pod.Spec.TerminationGracePeriodSeconds</code>，
则取<code>min(eviction-max-pod-grace-period, pod.Spec.TerminationGracePeriodSeconds)</code>
作为 Pod Termination 真正的 Grace Period。</li>
</ul>
<p>因此，在软驱逐策略下，从 kubelet 检测到驱逐信号达到了阈值设定开始，到 pod 真正被 kill 掉，
共花费的时间是：<code>sum(eviction-max-pod-grace-period, min(eviction-max-pod-grace-period, pod.Spec.TerminationGracePeriodSeconds))</code></p>
<h3 id="硬驱逐">
  硬驱逐
  <a class="anchor" href="#%e7%a1%ac%e9%a9%b1%e9%80%90">#</a>
</h3>
<p>Hard Eviction Thresholds 比 Soft Eviction Thresholds 简单粗暴，没有宽限期，
即使 pod 配置了 pod.Spec.TerminationGracePeriodSeconds，一旦达到阈值配置，
kubelet 立马回收关联的短缺资源，并且使用的就立即结束，而不是优雅终止。
此特性已经标记为 Deprecated。</p>
<p>源码 <code>pkg/kubelet/apis/config/v1beta1/defaults_linux.go</code> 给出了默认的硬驱逐配置：</p>
<ul>
<li>memory.available &lt; 100Mi</li>
<li>nodefs.available &lt; 10%</li>
<li>nodefs.inodesFree &lt; 5%</li>
<li>imagefs.available &lt; 15%</li>
</ul>
<h2 id="驱逐周期">
  驱逐周期
  <a class="anchor" href="#%e9%a9%b1%e9%80%90%e5%91%a8%e6%9c%9f">#</a>
</h2>
<p>有了驱逐信号和阈值，也有了策略，接下来就是 Eviction Monitoring Interval。
kubelet 对应的监控周期，就通过 cAdvisor 的 <code>housekeeping-interval</code> 配置的，默认 10s。</p>
<h2 id="节点状态">
  节点状态
  <a class="anchor" href="#%e8%8a%82%e7%82%b9%e7%8a%b6%e6%80%81">#</a>
</h2>
<p>kubelet 监测到配置的驱逐策略被触发，会将驱逐信号映射到对应的节点状态。
Kubelet 会将对应的 Eviction Signals 映射到对应的 Node Conditions，
源码 [<code>pkg/kubelet/eviction/helpers.go</code>]，其映射关系如下：</p>
<table>
<thead>
<tr>
<th>节点状态</th>
<th>驱逐信号</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>MemoryPressure</td>
<td>memory.avaliable, allocatableMemory.available</td>
<td>节点或 pod 的可用内存触发驱逐阈值</td>
</tr>
<tr>
<td>DiskPressure</td>
<td>nodefs.avaliable, nodefs.inodesFree, imagefs.available, imagesfs.inodesFree</td>
<td>节点的 root fs 或 i mage fs 上的可用磁盘空间和索引节点已满足收回阈值</td>
</tr>
<tr>
<td>PIDPressure</td>
<td>pid.available</td>
<td>节点的可用 PID 触发驱逐阈值</td>
</tr>
</tbody>
</table>
<p>kubelet 映射了 Node Condition 之 后，会继续按照<code>--node-status-update-frequency</code>(default 10s) 配置的时间间隔，
周期性的与 kube-apiserver 进行 node status updates。</p>
<h2 id="节点状态振荡">
  节点状态振荡
  <a class="anchor" href="#%e8%8a%82%e7%82%b9%e7%8a%b6%e6%80%81%e6%8c%af%e8%8d%a1">#</a>
</h2>
<p>​考虑这样一种场景，节点上监控到 soft eviction signal 的值，始终在 eviction threshold 上下波动，
那么 kubelet 就会将该 node 对应的 node condition 在 true 和 false 之间来回切换。
给 kube-scheduler 产生错误的调度结果。</p>
<p>​因此，kubelet 添加参数 <code>eviction-pressure-transition-period</code> (default 5m0s) 配置，
使 Kubelet 在解除由 Evicion Signal 映射的 Node Pressure 之前，必须等待 5 分钟。</p>
<p>​驱逐逻辑添加了一步：</p>
<ul>
<li><code>Soft Evction Singal</code> 高于 <code>Soft Eviction Thresholds</code> 时，
Kubelet 还是会立刻设置对应的 MemoryPressure 或 DiskPressure 为 True。</li>
<li>当 MemoryPressure 或 DiskPressure 为 True 的前提下，
发生了 <code>Soft Evction Singal</code> 低于 <code>Soft Eviction Thresholds</code> 的情况，
则需要等待 <code>eviction-pressure-transition-period</code>(default 5m0s) 配置的这么长时间，
才会将 condition pressure 切换回 False。</li>
</ul>
<p><strong>一句话总结</strong>：Node Condition Pressure 成为 True 容易，切换回 False 则要等<code>eviction-pressure-transition-period</code>。</p>
<h2 id="回收节点层级资源">
  回收节点层级资源
  <a class="anchor" href="#%e5%9b%9e%e6%94%b6%e8%8a%82%e7%82%b9%e5%b1%82%e7%ba%a7%e8%b5%84%e6%ba%90">#</a>
</h2>
<p>如果满足驱逐阈值并超过了宽限期，kubelet 将启动回收压力资源的过程，
直到它发现低于设定阈值的信号为止。
kubelet 将尝试在驱逐终端用户 pod 前回收节点层级资源。
发现磁盘压力时，如果节点针对容器运行时配置有独占的 imagefs，
kubelet 回收节点层级资源的方式将会不同。</p>
<h3 id="使用-imagefs">
  使用 imagefs
  <a class="anchor" href="#%e4%bd%bf%e7%94%a8-imagefs">#</a>
</h3>
<ul>
<li>如果 nodefs 文件系统满足驱逐阈值，kubelet 通过驱逐 pod 及其容器来释放磁盘空间。</li>
<li>如果 imagefs 文件系统满足驱逐阈值，kubelet 通过删除所有未使用的镜像来释放磁盘空间。</li>
</ul>
<h3 id="未使用-imagefs">
  未使用 imagefs
  <a class="anchor" href="#%e6%9c%aa%e4%bd%bf%e7%94%a8-imagefs">#</a>
</h3>
<ol>
<li>删除停止运行的 pod/container</li>
<li>删除全部没有被使用的镜像</li>
</ol>
<h2 id="驱逐策略">
  驱逐策略
  <a class="anchor" href="#%e9%a9%b1%e9%80%90%e7%ad%96%e7%95%a5">#</a>
</h2>
<p>​kubelet 根据 Pod 的 QoS Class 实现了一套默认的 Evication 策略，
kubelet 首先根据他们对短缺资源的使用是否超过请求来排除 pod 的驱逐行为，
然后通过优先级，然后通过相对于 pod 的调度请求消耗急需的计算资源。图解如下：</p>
<p>
  <img src="/kubernetes/kubelet/kubelet-eviction-manager/kubelet-eviction-strategy.png" alt="kubelet-eviction-strategy" /></p>
<p>​对于每一种 Resource 都可以将容器分为 3 种 QoS Classes: <em>Guaranteed</em>, <em>Burstable</em> 和 <em>Best-Effort</em>，
它们的 QoS 级别依次递减。</p>
<ul>
<li><code>BestEffort</code>，按照短缺资源占用量排序，占用量越高，被 kill 的优先级越高；</li>
<li><code>Burstable</code>，对使用量高于请求量的 pod 排序，占用越多，回收优先级越高；
如果没有 pod 的使用超过请求，按照 BestEffort 策略回收；</li>
<li><code>Guaranteed</code>，<code>Guaranteed</code> pod 只有为所有的容器指定了要求和限制并且它们相等时才能得到保证。
由于另一个 pod 的资源消耗，这些 pod 保证永远不会被驱逐。
如果系统守护进程（例如 <code>kubelet</code>、<code>docker</code>、和 <code>journald</code>）
消耗的资源多于通过 <code>system-reserved</code> 或 <code>kube-reserved</code> 分配保留的资源，
并且该节点只有 <code>Guaranteed</code> 或 <code>Burstable</code> pod 使用少于剩余的请求，
然后节点必须选择驱逐这样的 pod 以保持节点的稳定性并限制意外消耗对其他 pod 的影响。
在这种情况下，它将首先驱逐优先级最低的 pod。</li>
</ul>
<h2 id="最小驱逐回收">
  最小驱逐回收
  <a class="anchor" href="#%e6%9c%80%e5%b0%8f%e9%a9%b1%e9%80%90%e5%9b%9e%e6%94%b6">#</a>
</h2>
<p>有些情况下，可能只回收一小部分的资源就能使得 <code>Evication Signal</code> 的值低于 <code>eviction thresholds</code>。
但是，可能随着资源使用的波动或者新的调度 Pod 使得在该 Node 上很快又会触发 evict pods 的动作，
eviction 毕竟是耗时的动作，所以应该尽量避免这种情况的发生。</p>
<p>为了减少这类问题，每次 Evict Pods 后，Node 上对应的 Resource 不仅要比 Eviction Thresholds 低，
还要保证最少比 Eviction Thresholds，再低 <code>--eviction-minimum-reclaim</code> 中配置的数量。</p>
<p>例如使用下面的配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">--</span><span style="color:#a6e22e">eviction</span><span style="color:#f92672">-</span><span style="color:#a6e22e">hard</span>=<span style="color:#a6e22e">memory</span>.<span style="color:#a6e22e">available</span>&lt;<span style="color:#ae81ff">500</span><span style="color:#a6e22e">Mi</span>,<span style="color:#a6e22e">nodefs</span>.<span style="color:#a6e22e">available</span>&lt;<span style="color:#ae81ff">1</span><span style="color:#a6e22e">Gi</span>,<span style="color:#a6e22e">imagefs</span>.<span style="color:#a6e22e">available</span>&lt;<span style="color:#ae81ff">100</span><span style="color:#a6e22e">Gi</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">--</span><span style="color:#a6e22e">eviction</span><span style="color:#f92672">-</span><span style="color:#a6e22e">minimum</span><span style="color:#f92672">-</span><span style="color:#a6e22e">reclaim</span>=<span style="color:#e6db74">&#34;memory.available=0Mi,nodefs.available=500Mi,imagefs.available=2Gi&#34;</span>
</span></span></code></pre></div><p>如果 <code>memory.available</code> 驱逐阈值被触发，kubelet 将保证 <code>memory.available</code> 至少为 <code>500Mi</code>。
对于 <code>nodefs.available</code>，kubelet 将保证 <code>nodefs.available</code> 至少为 <code>1.5Gi</code>。
对于 <code>imagefs.available</code>，kubelet 将保证 <code>imagefs.available</code> 至少为 <code>102Gi</code>，
直到不再有相关资源报告压力为止。</p>
<p>所有资源的默认 <code>eviction-minimum-reclaim</code> 值为 0。</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">


  <div><a class="flex align-center" href="https://github.com/howieyuen/howieyuen.github.io/commit/3ca55ab350af2e1c5819434df7f796f281ad6dc8" title='Last modified by howieyuen | February 27, 2024' target="_blank" rel="noopener">
      <img src="/svg/calendar.svg" class="book-icon" alt="Calendar" />
      <span>February 27, 2024</span>
    </a>
  </div>




</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">



<div id="gitalk-container"></div>
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script>
  const gitalk = new Gitalk({
    clientID: 'b4cc17dbafc8ad637453',
    clientSecret: '77b4685b4d6da0280eca116a66b6f01244033d35',
    repo: 'howieyuen.github.io',
    owner: 'howieyuen',
    admin: ['howieyuen'],
    id: location.pathname, 
    distractionFreeMode: false 
  });
  (function() {
    if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
      document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
      return;
    }
    gitalk.render('gitalk-container');
  })();
</script>

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#概述">概述</a>
      <ul>
        <li><a href="#驱逐信号">驱逐信号</a></li>
        <li><a href="#驱逐阈值">驱逐阈值</a>
          <ul>
            <li><a href="#软驱逐策略">软驱逐策略</a></li>
            <li><a href="#硬驱逐">硬驱逐</a></li>
          </ul>
        </li>
        <li><a href="#驱逐周期">驱逐周期</a></li>
        <li><a href="#节点状态">节点状态</a></li>
        <li><a href="#节点状态振荡">节点状态振荡</a></li>
        <li><a href="#回收节点层级资源">回收节点层级资源</a>
          <ul>
            <li><a href="#使用-imagefs">使用 imagefs</a></li>
            <li><a href="#未使用-imagefs">未使用 imagefs</a></li>
          </ul>
        </li>
        <li><a href="#驱逐策略">驱逐策略</a></li>
        <li><a href="#最小驱逐回收">最小驱逐回收</a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












