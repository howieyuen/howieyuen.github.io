<!DOCTYPE html>
<html lang="en" dir=>

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="1. Customer Resource #  自定义资源是 Kubernetes API 的扩展，本文将讨什么时候应该向 Kubernetes 集群添加自定义资源以及何时使用独立服务。它描述了添加自定义资源的两种方法以及如何在它们之间进行选择。
1.1 自定义资源概述 #  资源就是 Kubernetes API 集合中的某个的对象。例如，内置 pods 资源包含 Pod 对象的集合。
自定义资源是扩展了 Kubernetes API，但在默认的 API 集合中是不可用的，因为没有对应的 controller 处理业务逻辑。使用自定义资源，不仅可以解耦大多数的自研功能，还可用使得 Kubernetes 更加模块化。
自定义资源可以通过动态注册的方法，于正在 running 的集群中创建、删除和更新，并且与集群本身的资源是相互独立的。当自定义资源被创建，就可以通过 kubectl 创建和访问对象，和对内置资源的操作完全一致。
1.2 是否需要自定义资源 #  在创建新的API时，应该考虑与Kubernetes的API聚合，还是让API独立运行。
   API聚合 API独立     声明式 非声明式   kubectl可读可写 不需要kubectl支持   接受k8s的REST限制 特定API路径   可限定为cluster或者namespace 不适用namespace   重用k8s API支持的功能 不需要这些功能    1.">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="CRD 入门和使用" />
<meta property="og:description" content="1. Customer Resource #  自定义资源是 Kubernetes API 的扩展，本文将讨什么时候应该向 Kubernetes 集群添加自定义资源以及何时使用独立服务。它描述了添加自定义资源的两种方法以及如何在它们之间进行选择。
1.1 自定义资源概述 #  资源就是 Kubernetes API 集合中的某个的对象。例如，内置 pods 资源包含 Pod 对象的集合。
自定义资源是扩展了 Kubernetes API，但在默认的 API 集合中是不可用的，因为没有对应的 controller 处理业务逻辑。使用自定义资源，不仅可以解耦大多数的自研功能，还可用使得 Kubernetes 更加模块化。
自定义资源可以通过动态注册的方法，于正在 running 的集群中创建、删除和更新，并且与集群本身的资源是相互独立的。当自定义资源被创建，就可以通过 kubectl 创建和访问对象，和对内置资源的操作完全一致。
1.2 是否需要自定义资源 #  在创建新的API时，应该考虑与Kubernetes的API聚合，还是让API独立运行。
   API聚合 API独立     声明式 非声明式   kubectl可读可写 不需要kubectl支持   接受k8s的REST限制 特定API路径   可限定为cluster或者namespace 不适用namespace   重用k8s API支持的功能 不需要这些功能    1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://howieyuen.github.io/docs/kubernetes/kube-apiserver/crd/" />
<meta property="article:published_time" content="2019-10-14T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-10-14T00:00:00+00:00" />
<title>CRD 入门和使用 | 袁昊的学习笔记</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.b77585324406fdba98b0d6281e32068303e5690a92ea506b5d2c6032cc22f6d5.css" integrity="sha256-t3WFMkQG/bqYsNYoHjIGgwPlaQqS6lBrXSxgMswi9tU=">
<script defer src="/en.search.min.d0c3e37ce62e781258e7b899488cb73e9bc716837f4fa0dbfa02423595e9cc23.js" integrity="sha256-0MPjfOYueBJY57iZSIy3PpvHFoN/T6Db&#43;gJCNZXpzCM="></script>

<script defer src="/sw.min.74a8bb07f0bee86d6bb9a2750f073f14d93c7e4512f28860370cfd879e9719b4.js" integrity="sha256-dKi7B/C&#43;6G1ruaJ1Dwc/FNk8fkUS8ohgNwz9h56XGbQ="></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body dir=>
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><img src="/logo.jpeg" alt="Logo" /><span>袁昊的学习笔记</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  



  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Golang</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>数据结构</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/golang/data-structure/chan/" class="">chan</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/golang/data-structure/map/" class="">map</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/golang/data-structure/slice/" class="">slice</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>语言基础</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/golang/language-basics/unsafe/" class="">unsafe</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/golang/language-basics/reflect/" class="">reflect</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>内存管理</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/golang/memory-manage/memory-model/" class="">内存模型</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Kubernetes</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>kube-apisever</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/kube-apiserver/authentication/" class="">认证机制</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/kube-apiserver/garbage-collector/" class="">垃圾回收</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/kube-apiserver/key-design-of-etcd-watch/" class="">watch 关键设计</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/kube-apiserver/crd/" class=" active">CRD 入门和使用</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>kube-controller-manager</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/kube-controller-manager/code-analysis-of-garbagecollector-controller/" class="">GC Controller 源码分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/kube-controller-manager/code-analysis-of-daemonset-controller/" class="">DaemonSet Controller 源码分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/kube-controller-manager/code-analysis-of-statefulset-controller/" class="">Statefulset Controller 源码分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/kube-controller-manager/k8s-apps-rolling-update/" class="">无状态应用滚动更新</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>kube-proxy</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/kube-proxy/learn-about-Service/" class="">深入了解 Service</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>kubelet</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/kubelet/kubelet-topology-manager/" class="">Topology Manager 设计方案</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/kubelet/kubelet-eviction-manager/" class="">Eviction Manager 工作机制</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>kube-scheduler</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/kube-scheduler/advanced-scheduling/" class="">高级调度</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-20038bcc21ca3d914920842c4a32533d" class="toggle"  />
    <label for="section-20038bcc21ca3d914920842c4a32533d" class="flex justify-between">
      <a  class="">LeetCode</a>
      <span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/leetcode/0321/" class="">321. 拼接最大数</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/leetcode/0416/" class="">416. 分割等和子集</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>











  
<ul>
  
  <li>
    <a href="/posts/" >
        Blog
      </a>
  </li>
  
  <li>
    <a href="https://github.com/howieyuen/" target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
  <li>
    <a href="https://themes.gohugo.io/hugo-book/" target="_blank" rel="noopener">
        Hugo Themes
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>CRD 入门和使用</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  <nav id="TableOfContents">
  <ul>
    <li><a href="#1-customer-resource">1. Customer Resource</a>
      <ul>
        <li><a href="#11-自定义资源概述">1.1 自定义资源概述</a></li>
        <li><a href="#12-是否需要自定义资源">1.2 是否需要自定义资源</a></li>
        <li><a href="#13-声明式-api-vs-命令式-api">1.3 声明式 API VS 命令式 API</a></li>
      </ul>
    </li>
    <li><a href="#2-customer-resource-definition">2. Customer Resource Definition</a>
      <ul>
        <li><a href="#21-customer-resource-definition-介绍">2.1 Customer Resource Definition 介绍</a></li>
        <li><a href="#22-crd-定义示例">2.2 CRD 定义示例</a></li>
        <li><a href="#23-customer-controller">2.3 Customer Controller</a>
          <ul>
            <li><a href="#231-client-go-组件">2.3.1 client-go 组件</a></li>
            <li><a href="#232-自定义-controller-组件">2.3.2 自定义 controller 组件</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#3-sample-controller-使用">3. sample-controller 使用</a>
      <ul>
        <li><a href="#31-资源准备">3.1 资源准备</a>
          <ul>
            <li><a href="#311-foocrdyaml">3.1.1 foo.crd.yaml</a></li>
            <li><a href="#312-examplefooyaml">3.1.2 example.foo.yaml</a></li>
          </ul>
        </li>
        <li><a href="#32-sample-controller-部署">3.2 sample-controller 部署</a>
          <ul>
            <li><a href="#321-代码">3.2.1 代码</a></li>
            <li><a href="#322-编译">3.2.2 编译</a></li>
            <li><a href="#323-启动">3.2.3 启动</a></li>
            <li><a href="#324-创建资源">3.2.4 创建资源</a></li>
            <li><a href="#325-校验">3.2.5 校验</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#4-参考资料">4. 参考资料</a></li>
  </ul>
</nav>


  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="1-customer-resource">
  1. Customer Resource
  <a class="anchor" href="#1-customer-resource">#</a>
</h1>
<p>自定义资源是 Kubernetes API 的扩展，本文将讨什么时候应该向 Kubernetes 集群添加自定义资源以及何时使用独立服务。它描述了添加自定义资源的两种方法以及如何在它们之间进行选择。</p>
<h2 id="11-自定义资源概述">
  1.1 自定义资源概述
  <a class="anchor" href="#11-%e8%87%aa%e5%ae%9a%e4%b9%89%e8%b5%84%e6%ba%90%e6%a6%82%e8%bf%b0">#</a>
</h2>
<p>资源就是 Kubernetes API 集合中的某个的对象。例如，内置 pods 资源包含 Pod 对象的集合。</p>
<p>自定义资源是扩展了 Kubernetes API，但在默认的 API 集合中是不可用的，因为没有对应的 controller 处理业务逻辑。使用自定义资源，不仅可以解耦大多数的自研功能，还可用使得 Kubernetes 更加模块化。</p>
<p>自定义资源可以通过动态注册的方法，于正在 running 的集群中创建、删除和更新，并且与集群本身的资源是相互独立的。当自定义资源被创建，就可以通过 kubectl 创建和访问对象，和对内置资源的操作完全一致。</p>
<h2 id="12-是否需要自定义资源">
  1.2 是否需要自定义资源
  <a class="anchor" href="#12-%e6%98%af%e5%90%a6%e9%9c%80%e8%a6%81%e8%87%aa%e5%ae%9a%e4%b9%89%e8%b5%84%e6%ba%90">#</a>
</h2>
<p>在创建新的API时，应该考虑与Kubernetes的API聚合，还是让API独立运行。</p>
<table>
<thead>
<tr>
<th>API聚合</th>
<th>API独立</th>
</tr>
</thead>
<tbody>
<tr>
<td>声明式</td>
<td>非声明式</td>
</tr>
<tr>
<td>kubectl可读可写</td>
<td>不需要kubectl支持</td>
</tr>
<tr>
<td>接受k8s的REST限制</td>
<td>特定API路径</td>
</tr>
<tr>
<td>可限定为cluster或者namespace</td>
<td>不适用namespace</td>
</tr>
<tr>
<td>重用k8s API支持的功能</td>
<td>不需要这些功能</td>
</tr>
</tbody>
</table>
<h2 id="13-声明式-api-vs-命令式-api">
  1.3 声明式 API VS 命令式 API
  <a class="anchor" href="#13-%e5%a3%b0%e6%98%8e%e5%bc%8f-api-vs-%e5%91%bd%e4%bb%a4%e5%bc%8f-api">#</a>
</h2>
<p>在声明式 API，通过具有以下特性：</p>
<ul>
<li>对象颗粒度小</li>
<li>基础结构的定义</li>
<li>读写多，更新少，操作主要为 CRUD</li>
<li>API表期望状态</li>
</ul>
<p>命令式 API，通过具有以下特性：</p>
<ul>
<li>同步响应</li>
<li>RPC调用</li>
<li>大量数据存储（大对象或多对象）</li>
<li>高带宽访问</li>
<li>操作非CRUD</li>
<li>API不易抽象</li>
</ul>
<h1 id="2-customer-resource-definition">
  2. Customer Resource Definition
  <a class="anchor" href="#2-customer-resource-definition">#</a>
</h1>
<p>Kubernetes提供了两种向集群添加自定义资源的方法：</p>
<ul>
<li>创建自定义 API server 并聚合到 API 中</li>
<li>CRDs</li>
</ul>
<h2 id="21-customer-resource-definition-介绍">
  2.1 Customer Resource Definition 介绍
  <a class="anchor" href="#21-customer-resource-definition-%e4%bb%8b%e7%bb%8d">#</a>
</h2>
<blockquote>
<p>kubernetes: v1.19.0</p>
</blockquote>
<p>通过CRD创建自定义资源，只要符合 CRD 结构体定义，均可以被 Kubernetes 所接收，CRD 的定义和 k8s 原生资源的定义非常类似，都是由 4 个子资源组成：TypeMeta、ObjectMeta、Spec、Status，具体代码如下：</p>
<p><code>staging/src/k8s.io/apiextensions-apiserver/pkg/apis/apiextensions/types.go:354</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CustomResourceDefinition</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">TypeMeta</span>
	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ObjectMeta</span>
	<span style="color:#a6e22e">Spec</span> <span style="color:#a6e22e">CustomResourceDefinitionSpec</span> 
	<span style="color:#a6e22e">Status</span> <span style="color:#a6e22e">CustomResourceDefinitionStatus</span>
}
</code></pre></div><p>下面主要来看下 Spec 和 Status 字段：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CustomResourceDefinitionSpec</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Group</span> <span style="color:#66d9ef">string</span>
	<span style="color:#75715e">// 定义复数、单数，简称，Kind，ListKind，Categories
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Names</span> <span style="color:#a6e22e">CustomResourceDefinitionNames</span>
	<span style="color:#75715e">// 表示集群级别或 namespace 级别
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Scope</span> <span style="color:#a6e22e">ResourceScope</span>
	<span style="color:#75715e">// 定义 CR 所有支持的版本号
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Versions</span> []<span style="color:#a6e22e">CustomResourceDefinitionVersion</span>
	<span style="color:#75715e">// 定义不同版本之间的转换方法
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Conversion</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">CustomResourceConversion</span>
	<span style="color:#75715e">// 是否保留未知字段，apiVersion、kind、metadata 等总是保留
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">PreserveUnknownFields</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">bool</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CustomResourceDefinitionStatus</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">// 描述资源的当前状态，即 status.conditions
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Conditions</span> []<span style="color:#a6e22e">CustomResourceDefinitionCondition</span>
	<span style="color:#75715e">// 与spec.names类似，即 status.acceptNames
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">AcceptedNames</span> <span style="color:#a6e22e">CustomResourceDefinitionNames</span>
	<span style="color:#75715e">// 资源曾经存在的版本，可在 etcd中存储，供迁移用
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">StoredVersions</span> []<span style="color:#66d9ef">string</span>
}

</code></pre></div><h2 id="22-crd-定义示例">
  2.2 CRD 定义示例
  <a class="anchor" href="#22-crd-%e5%ae%9a%e4%b9%89%e7%a4%ba%e4%be%8b">#</a>
</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apiextensions.k8s.io/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">CustomResourceDefinition</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#75715e"># 名称必须符合下面的格式：&lt;plural&gt;.&lt;group&gt;</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">foos.samplecontroller.io</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#75715e"># REST API使用的组名称：/apis/&lt;group&gt;/&lt;version&gt;</span>
  <span style="color:#f92672">group</span>: <span style="color:#ae81ff">samplecontroller.io</span>
  <span style="color:#75715e"># REST API使用的版本号：/apis/&lt;group&gt;/&lt;version&gt;</span>
  <span style="color:#f92672">versions</span>:
    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">v1alpha1</span>
      <span style="color:#f92672">served</span>: <span style="color:#66d9ef">true</span>
      <span style="color:#f92672">storage</span>: <span style="color:#66d9ef">true</span>
      <span style="color:#f92672">schema</span>:
        <span style="color:#75715e"># 校验方法</span>
        <span style="color:#f92672">openAPIV3Schema</span>:
          <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
          <span style="color:#f92672">properties</span>:
            <span style="color:#f92672">spec</span>:
              <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
              <span style="color:#f92672">properties</span>:
                <span style="color:#75715e">#类型校验</span>
                <span style="color:#f92672">replicas</span>:
                  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">integer</span>
                <span style="color:#f92672">deploymentName</span>:
                  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">string</span>
  <span style="color:#75715e"># Namespaced或Cluster</span>
  <span style="color:#f92672">scope</span>: <span style="color:#ae81ff">Namespaced</span>
  <span style="color:#f92672">names</span>:
    <span style="color:#75715e"># URL中使用的复数名称: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span>
    <span style="color:#f92672">plural</span>: <span style="color:#ae81ff">foos</span>
    <span style="color:#75715e"># CLI中使用的单数名称</span>
    <span style="color:#f92672">singular</span>: <span style="color:#ae81ff">foo</span>
    <span style="color:#75715e"># CamelCased格式的单数类型。在清单文件中使用</span>
    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Foo</span>
    <span style="color:#75715e"># 资源的List类型，默认是 “`kind`List”</span>
    <span style="color:#f92672">listKind</span>: <span style="color:#ae81ff">FooList</span>
    <span style="color:#75715e"># CLI中使用的资源简称</span>
    <span style="color:#f92672">shortNames</span>:
      - <span style="color:#ae81ff">fo</span>
    <span style="color:#75715e"># 分组</span>
    <span style="color:#f92672">categories</span>:
      - <span style="color:#ae81ff">all</span>
</code></pre></div><h2 id="23-customer-controller">
  2.3 Customer Controller
  <a class="anchor" href="#23-customer-controller">#</a>
</h2>
<p>只定义资源，不实现资源控制器是没有任何意义的。自定义控制器能够完成业务逻辑，最主要是依赖 client-go 库的各个组件的交互。下图展示它们之间的关系：</p>
<p>
  <img src="/kubernetes/kube-apiserver/crd/client-go-controller-interaction.jpeg" alt="client-go-controller-interaction.jpeg" /></p>
<p>通过图示，可以看到几个核心组件的交互流程，蓝色表示 client-go，黄色是自定义 controller，各组件作用介绍如下：</p>
<h3 id="231-client-go-组件">
  2.3.1 client-go 组件
  <a class="anchor" href="#231-client-go-%e7%bb%84%e4%bb%b6">#</a>
</h3>
<ul>
<li><strong>Reflector</strong>：reflector 用来 watch 特定的 k8s API 资源。具体的实现是通过 ListAndWatch 的方法，watch 可以是 k8s 内建的资源或者是自定义的资源。当 reflector 通过 watch API 接收到有关新资源实例存在的通知时，它使用相应的列表API获取新创建的对象，并将其放入 watchHandler 函数内的 Delta FIFO 队列中。</li>
<li><strong>Informer</strong>：informer 从 Delta FIFO 队列中弹出对象。执行此操作的功能是 processLoop。base controller 的作用是保存对象以供以后检索，并调用我们的控制器将对象传递给它。</li>
<li><strong>Indexer</strong>：索引器提供对象的索引功能。典型的索引用例是基于对象标签创建索引。 Indexer 可以根据多个索引函数维护索引。Indexer 使用线程安全的数据存储来存储对象及其键。 在 Store 中定义了一个名为 MetaNamespaceKeyFunc 的默认函数，该函数生成对象的键作为该对象的 namespace/name 组合。</li>
</ul>
<h3 id="232-自定义-controller-组件">
  2.3.2 自定义 controller 组件
  <a class="anchor" href="#232-%e8%87%aa%e5%ae%9a%e4%b9%89-controller-%e7%bb%84%e4%bb%b6">#</a>
</h3>
<ul>
<li><strong>Informer reference</strong>：指的是 Informer 实例的引用，定义如何使用自定义资源对象。自定义控制器代码需要创建对应的 Informer。</li>
<li><strong>Indexer reference</strong>：自定义控制器对 Indexer 实例的引用。自定义控制器需要创建对应的Indexer。</li>
<li><strong>Resource Event Handlers</strong>：资源事件回调函数，当它想要将对象传递给控制器时，它将被调用。编写这些函数的典型模式是获取调度对象的 key，并将该 key 排入工作队列以进行进一步处理。</li>
<li><strong>Work queue</strong>：任务队列。编写资源事件处理程序函数以提取传递的对象的 key 并将其添加到任务队列。</li>
<li><strong>Process Item</strong>：处理任务队列中对象的函数，这些函数通常使用 Indexer 引用或 Listing 包装器来重试与该 key 对应的对象。</li>
</ul>
<p>简单的说，整个处理流程大概为：Reflector 通过检测 Kubernetes API 来跟踪该扩展资源类型的变化，一旦发现有变化，就将该 Object 存储队列中，Informer 循环取出该 Object 并将其存入 Indexer 进行检索，同时触发 Callback 回调函数，并将变更的 Object Key 信息放入到工作队列中，此时自定义 Controller 里面的 Process Item 就会获取工作队列里面的 Key，并从 Indexer 中获取 Key 对应的 Object，从而进行相关的业务处理。</p>
<h1 id="3-sample-controller-使用">
  3. sample-controller 使用
  <a class="anchor" href="#3-sample-controller-%e4%bd%bf%e7%94%a8">#</a>
</h1>
<h2 id="31-资源准备">
  3.1 资源准备
  <a class="anchor" href="#31-%e8%b5%84%e6%ba%90%e5%87%86%e5%a4%87">#</a>
</h2>
<h3 id="311-foocrdyaml">
  3.1.1 foo.crd.yaml
  <a class="anchor" href="#311-foocrdyaml">#</a>
</h3>
<p>使用 2.2 节的示例。</p>
<h3 id="312-examplefooyaml">
  3.1.2 example.foo.yaml
  <a class="anchor" href="#312-examplefooyaml">#</a>
</h3>
<p>创建 foo 资源类型的对象：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">samplecontroller.io/v1alpha1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Foo</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">example-foo</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">deploymentName</span>: <span style="color:#ae81ff">example-foo</span>
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</code></pre></div><h2 id="32-sample-controller-部署">
  3.2 sample-controller 部署
  <a class="anchor" href="#32-sample-controller-%e9%83%a8%e7%bd%b2">#</a>
</h2>
<h3 id="321-代码">
  3.2.1 代码
  <a class="anchor" href="#321-%e4%bb%a3%e7%a0%81">#</a>
</h3>
<p>获取示例代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s">git clone https<span style="color:#f92672">://</span>github.com<span style="color:#f92672">/</span>kubernetes<span style="color:#f92672">/</span>sample<span style="color:#f92672">-</span>controller.git
cd sample<span style="color:#f92672">-</span>controller
</code></pre></div><h3 id="322-编译">
  3.2.2 编译
  <a class="anchor" href="#322-%e7%bc%96%e8%af%91">#</a>
</h3>
<p>在编译二进制之前，要修改 <code>pkg/apis/samplecontroller/register.go:21</code> GroupName 的定义，k8s.io 和 kubernetes.io 后缀都是官方保留字段，不建议 CRD 使用。所以将其修改为 <code>samplecontroller.io</code>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s">go build <span style="color:#f92672">-</span>o sample<span style="color:#f92672">-</span>controller .
</code></pre></div><h3 id="323-启动">
  3.2.3 启动
  <a class="anchor" href="#323-%e5%90%af%e5%8a%a8">#</a>
</h3>
<p>使用节点上的 kubeconfig 文件启动 controller：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s">./sample<span style="color:#f92672">-</span>controller <span style="color:#f92672">-</span>kubeconfig<span style="color:#f92672">=$</span>HOME<span style="color:#f92672">/</span>.kube<span style="color:#f92672">/</span>config
</code></pre></div><p>启动时，会提示 watch 不到资源，因为还没创建定义：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s">I1026 <span style="color:#ae81ff">23</span><span style="color:#f92672">:</span><span style="color:#ae81ff">40</span><span style="color:#f92672">:</span><span style="color:#ae81ff">56.529233</span>   <span style="color:#ae81ff">57978</span> controller.go<span style="color:#f92672">:</span><span style="color:#ae81ff">115</span>] Setting up event handlers
I1026 <span style="color:#ae81ff">23</span><span style="color:#f92672">:</span><span style="color:#ae81ff">40</span><span style="color:#f92672">:</span><span style="color:#ae81ff">56.529444</span>   <span style="color:#ae81ff">57978</span> controller.go<span style="color:#f92672">:</span><span style="color:#ae81ff">156</span>] Starting Foo controller
I1026 <span style="color:#ae81ff">23</span><span style="color:#f92672">:</span><span style="color:#ae81ff">40</span><span style="color:#f92672">:</span><span style="color:#ae81ff">56.529450</span>   <span style="color:#ae81ff">57978</span> controller.go<span style="color:#f92672">:</span><span style="color:#ae81ff">159</span>] Waiting for informer caches to sync
E1026 <span style="color:#ae81ff">23</span><span style="color:#f92672">:</span><span style="color:#ae81ff">40</span><span style="color:#f92672">:</span><span style="color:#ae81ff">56.554564</span>   <span style="color:#ae81ff">57978</span> reflector.go<span style="color:#f92672">:</span><span style="color:#ae81ff">138</span>] k8s.io<span style="color:#f92672">/</span>sample<span style="color:#f92672">-</span>controller<span style="color:#f92672">/</span>pkg<span style="color:#f92672">/</span>generated<span style="color:#f92672">/</span>informers<span style="color:#f92672">/</span>externalversions<span style="color:#f92672">/</span>factory.go<span style="color:#f92672">:</span><span style="color:#ae81ff">117</span><span style="color:#f92672">:</span> Failed to watch <span style="color:#f92672">*</span>v1alpha1.Foo<span style="color:#f92672">:</span> failed to list <span style="color:#f92672">*</span>v1alpha1.Foo<span style="color:#f92672">:</span> the server could not find the requested <span style="color:#a6e22e">resource </span>(get foos.samplecontroller.io)
E1026 <span style="color:#ae81ff">23</span><span style="color:#f92672">:</span><span style="color:#ae81ff">40</span><span style="color:#f92672">:</span><span style="color:#ae81ff">57.841194</span>   <span style="color:#ae81ff">57978</span> reflector.go<span style="color:#f92672">:</span><span style="color:#ae81ff">138</span>] k8s.io<span style="color:#f92672">/</span>sample<span style="color:#f92672">-</span>controller<span style="color:#f92672">/</span>pkg<span style="color:#f92672">/</span>generated<span style="color:#f92672">/</span>informers<span style="color:#f92672">/</span>externalversions<span style="color:#f92672">/</span>factory.go<span style="color:#f92672">:</span><span style="color:#ae81ff">117</span><span style="color:#f92672">:</span> Failed to watch <span style="color:#f92672">*</span>v1alpha1.Foo<span style="color:#f92672">:</span> failed to list <span style="color:#f92672">*</span>v1alpha1.Foo<span style="color:#f92672">:</span> the server could not find the requested <span style="color:#a6e22e">resource </span>(get foos.samplecontroller.io)
</code></pre></div><h3 id="324-创建资源">
  3.2.4 创建资源
  <a class="anchor" href="#324-%e5%88%9b%e5%bb%ba%e8%b5%84%e6%ba%90">#</a>
</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s"><span style="color:#f92672">$</span> kubectl create  <span style="color:#f92672">-</span>f foos.crd.yaml
customresourcedefinition.apiextensions.k8s.io<span style="color:#f92672">/</span>foos.samplecontroller.io created

<span style="color:#f92672">$</span> kubectl create  <span style="color:#f92672">-</span>f example.foos.yaml
foo.samplecontroller.io<span style="color:#f92672">/</span>example<span style="color:#f92672">-</span>foo created
</code></pre></div><p>创建完成，可以使用 <code>kubectl get crd</code> 查看资源定义和对象：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s"><span style="color:#f92672">$</span> kubectl get crd
NAME                       CREATED AT
clusterversions.cfe.io     <span style="color:#ae81ff">2020-10-26</span>T14<span style="color:#f92672">:</span><span style="color:#ae81ff">43</span><span style="color:#f92672">:</span><span style="color:#ae81ff">27</span>Z
foos.samplecontroller.io   <span style="color:#ae81ff">2020-10-26</span>T15<span style="color:#f92672">:</span><span style="color:#ae81ff">41</span><span style="color:#f92672">:</span><span style="color:#ae81ff">52</span>Z

<span style="color:#f92672">$</span> kubectl get foos
NAME          AGE
example<span style="color:#f92672">-</span>foo   <span style="color:#ae81ff">19</span>m
</code></pre></div><p>sample-controller 会 watch 到新对象 default/example-foo：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s">I1026 <span style="color:#ae81ff">23</span><span style="color:#f92672">:</span><span style="color:#ae81ff">42</span><span style="color:#f92672">:</span><span style="color:#ae81ff">03.232577</span>   <span style="color:#ae81ff">57978</span> controller.go<span style="color:#f92672">:</span><span style="color:#ae81ff">164</span>] Starting workers
I1026 <span style="color:#ae81ff">23</span><span style="color:#f92672">:</span><span style="color:#ae81ff">42</span><span style="color:#f92672">:</span><span style="color:#ae81ff">03.232607</span>   <span style="color:#ae81ff">57978</span> controller.go<span style="color:#f92672">:</span><span style="color:#ae81ff">170</span>] Started workers
I1026 <span style="color:#ae81ff">23</span><span style="color:#f92672">:</span><span style="color:#ae81ff">42</span><span style="color:#f92672">:</span><span style="color:#ae81ff">03.515970</span>   <span style="color:#ae81ff">57978</span> controller.go<span style="color:#f92672">:</span><span style="color:#ae81ff">228</span>] Successfully synced <span style="color:#e6db74">&#39;default/example-foo&#39;</span>
I1026 <span style="color:#ae81ff">23</span><span style="color:#f92672">:</span><span style="color:#ae81ff">42</span><span style="color:#f92672">:</span><span style="color:#ae81ff">03.516099</span>   <span style="color:#ae81ff">57978</span> event.go<span style="color:#f92672">:</span><span style="color:#ae81ff">291</span>] <span style="color:#e6db74">&#34;Event occurred&#34;</span> object<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;default/example-foo&#34;</span> kind<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Foo&#34;</span> apiVersion<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;samplecontroller.io/v1alpha1&#34;</span> type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Normal&#34;</span> reason<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Synced&#34;</span> message<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Foo synced successfully&#34;</span>
</code></pre></div><h3 id="325-校验">
  3.2.5 校验
  <a class="anchor" href="#325-%e6%a0%a1%e9%aa%8c">#</a>
</h3>
<p>检查 controller 创建 Deployment 对象：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s"><span style="color:#f92672">$</span> kubectl get deploy                       
NAME          READY   UP<span style="color:#f92672">-</span>TO<span style="color:#f92672">-</span>DATE   AVAILABLE   AGE
example<span style="color:#f92672">-</span>foo   <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           <span style="color:#ae81ff">3</span>m1s

<span style="color:#f92672">$</span> kubectl get pod
NAME                           READY   STATUS    RESTARTS   AGE
example<span style="color:#f92672">-</span>foo<span style="color:#ae81ff">-54</span>dc4db9fc<span style="color:#ae81ff">-4</span>r8pp   <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     Running   <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">3</span>m8s
shell<span style="color:#f92672">-</span>demo                     <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     Running   <span style="color:#ae81ff">9</span>          <span style="color:#ae81ff">43</span>d
web<span style="color:#ae81ff">-0</span>                          <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     Running   <span style="color:#ae81ff">16</span>         <span style="color:#ae81ff">78</span>d
web<span style="color:#ae81ff">-1</span>                          <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     Running   <span style="color:#ae81ff">16</span>         <span style="color:#ae81ff">78</span>d
</code></pre></div><h1 id="4-参考资料">
  4. 参考资料
  <a class="anchor" href="#4-%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99">#</a>
</h1>
<ul>
<li>
  <a href="https://kubernetes.io/zh/docs/concepts/extend-kubernetes/api-extension/custom-resources/">定制资源</a></li>
<li>
  <a href="https://github.com/kubernetes/sample-controller/blob/master/docs/controller-client-go.md">controller-client-go</a></li>
<li>
  <a href="https://github.com/kubernetes/sample-controller/blob/master/README.md">sample-controller</a></li>
</ul>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>

 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#1-customer-resource">1. Customer Resource</a>
      <ul>
        <li><a href="#11-自定义资源概述">1.1 自定义资源概述</a></li>
        <li><a href="#12-是否需要自定义资源">1.2 是否需要自定义资源</a></li>
        <li><a href="#13-声明式-api-vs-命令式-api">1.3 声明式 API VS 命令式 API</a></li>
      </ul>
    </li>
    <li><a href="#2-customer-resource-definition">2. Customer Resource Definition</a>
      <ul>
        <li><a href="#21-customer-resource-definition-介绍">2.1 Customer Resource Definition 介绍</a></li>
        <li><a href="#22-crd-定义示例">2.2 CRD 定义示例</a></li>
        <li><a href="#23-customer-controller">2.3 Customer Controller</a>
          <ul>
            <li><a href="#231-client-go-组件">2.3.1 client-go 组件</a></li>
            <li><a href="#232-自定义-controller-组件">2.3.2 自定义 controller 组件</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#3-sample-controller-使用">3. sample-controller 使用</a>
      <ul>
        <li><a href="#31-资源准备">3.1 资源准备</a>
          <ul>
            <li><a href="#311-foocrdyaml">3.1.1 foo.crd.yaml</a></li>
            <li><a href="#312-examplefooyaml">3.1.2 example.foo.yaml</a></li>
          </ul>
        </li>
        <li><a href="#32-sample-controller-部署">3.2 sample-controller 部署</a>
          <ul>
            <li><a href="#321-代码">3.2.1 代码</a></li>
            <li><a href="#322-编译">3.2.2 编译</a></li>
            <li><a href="#323-启动">3.2.3 启动</a></li>
            <li><a href="#324-创建资源">3.2.4 创建资源</a></li>
            <li><a href="#325-校验">3.2.5 校验</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#4-参考资料">4. 参考资料</a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>

</html>












