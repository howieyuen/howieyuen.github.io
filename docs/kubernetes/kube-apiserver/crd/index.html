<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="自定义资源是 Kubernetes API 的扩展，本文将讨什么时候应该向 Kubernetes 集群添加自定义资源以及何时使用独立服务。它描述了添加自定义资源的两种方法以及如何在它们之间进行选择。">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="CRD 入门和使用" />
<meta property="og:description" content="自定义资源是 Kubernetes API 的扩展，本文将讨什么时候应该向 Kubernetes 集群添加自定义资源以及何时使用独立服务。它描述了添加自定义资源的两种方法以及如何在它们之间进行选择。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://howieyuen.github.io/docs/kubernetes/kube-apiserver/crd/" /><meta property="article:section" content="docs" />
<meta property="article:published_time" content="2019-10-14T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-01-23T14:18:15+08:00" />

<title>CRD 入门和使用 | 袁昊的学习笔记</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.c58292d36b18b675680ab9baea2029204537b839ea72f258746ec0f32ce8d6c8.css" integrity="sha256-xYKS02sYtnVoCrm66iApIEU3uDnqcvJYdG7A8yzo1sg=" crossorigin="anonymous">
  <script defer src="/flexsearch.min.js"></script>
  <script defer src="/en.search.min.24bfea92d3f22f77dd53e4a7567161e20b00ded6783b4375a6921c31f40d2d62.js" integrity="sha256-JL/qktPyL3fdU&#43;SnVnFh4gsA3tZ4O0N1ppIcMfQNLWI=" crossorigin="anonymous"></script>

  <script defer src="/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js" integrity="sha256-b2&#43;Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC&#43;NdcPIvZhzk=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><img src="/logo.jpeg" alt="Logo" /><span>袁昊的学习笔记</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li>
          
  
  

  
    <span>Golang</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-aa0ad5dadefefc3354befb0f21b44571" class="toggle"  />
    <label for="section-aa0ad5dadefefc3354befb0f21b44571" class="flex justify-between">
      <a role="button" class="">数据结构</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/golang/data-structure/chan/" class="">chan</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/golang/data-structure/map/" class="">map</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/golang/data-structure/slice/" class="">slice</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-9730b84098027970ce9876389c401abb" class="toggle"  />
    <label for="section-9730b84098027970ce9876389c401abb" class="flex justify-between">
      <a role="button" class="">语言基础</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/golang/language-basics/unsafe/" class="">unsafe</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/golang/language-basics/reflect/" class="">reflect</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-84d526a58cfe5a50fb73329d6c7bd14a" class="toggle"  />
    <label for="section-84d526a58cfe5a50fb73329d6c7bd14a" class="flex justify-between">
      <a role="button" class="">内存管理</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/golang/memory-manage/memory-model/" class="">内存模型</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-084099e607ed94fee6028accac1c176c" class="toggle"  />
    <label for="section-084099e607ed94fee6028accac1c176c" class="flex justify-between">
      <a role="button" class="">golang 工具</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/golang/tools/pprof/" class="">pprof</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Kubernetes</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-103a3040e6af1931bd7a973aa3d5fe12" class="toggle" checked />
    <label for="section-103a3040e6af1931bd7a973aa3d5fe12" class="flex justify-between">
      <a role="button" class="">kube-apisever</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-apiserver/authorization/" class="">鉴权机制</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-apiserver/authentication/" class="">认证机制</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-apiserver/garbage-collector/" class="">垃圾回收</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-apiserver/key-design-of-etcd-watch/" class="">watch 关键设计</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-apiserver/crd/" class="active">CRD 入门和使用</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-55afec95d17025ab2841fd395bf5e066" class="toggle"  />
    <label for="section-55afec95d17025ab2841fd395bf5e066" class="flex justify-between">
      <a role="button" class="">kube-controller-manager</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-controller-manager/code-analysis-of-garbagecollector-controller/" class="">GC Controller 源码分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-controller-manager/code-analysis-of-daemonset-controller/" class="">DaemonSet Controller 源码分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-controller-manager/code-analysis-of-statefulset-controller/" class="">Statefulset Controller 源码分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-controller-manager/k8s-apps-rolling-update/" class="">无状态应用滚动更新</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-6c06d491bb5aface6ab2585a8049b13f" class="toggle"  />
    <label for="section-6c06d491bb5aface6ab2585a8049b13f" class="flex justify-between">
      <a role="button" class="">kube-scheduler</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kube-scheduler/advanced-scheduling/" class="">高级调度</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-89eea73f7e04e77c22ade24239d6a83e" class="toggle"  />
    <label for="section-89eea73f7e04e77c22ade24239d6a83e" class="flex justify-between">
      <a role="button" class="">kubelet</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kubelet/kubelet-topology-manager/" class="">Topology Manager 设计方案</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/kubelet/kubelet-eviction-manager/" class="">Eviction Manager 工作机制</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-f0e31a9428c0c5fa066c9ad36b1ae0b6" class="toggle"  />
    <label for="section-f0e31a9428c0c5fa066c9ad36b1ae0b6" class="flex justify-between">
      <a role="button" class="">sig-network</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/sig-network/svc-ep-epslice/" class="">Service 与 Endpoints、EndpointSlice 那些事</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kubernetes/sig-network/learn-about-Service/" class="">深入了解 Service</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>XaC(Everything as Code)</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-ad61c1f49e198d237c45c8c43e19ff81" class="toggle"  />
    <label for="section-ad61c1f49e198d237c45c8c43e19ff81" class="flex justify-between">
      <a role="button" class="">Infra as Code</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/XaC/infra-as-code/getting-started-of-acorn/" class="">Acorn：k8s 应用部署框架</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/XaC/infra-as-code/terraform-workflow/" class="">Terraform 执行状态和阶段关系</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-b38fb26cbaaf667f79df6e01d2ae5fc3" class="toggle"  />
    <label for="section-b38fb26cbaaf667f79df6e01d2ae5fc3" class="flex justify-between">
      <a role="button" class="">Secret as Code</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/XaC/secret-as-code/helm-secrets/" class="">Helm Secrets</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/XaC/secret-as-code/kamus/" class="">Kamus</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/XaC/secret-as-code/secrets-store-csi-driver/" class="">Secrets Store CSI Driver</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/XaC/secret-as-code/sealed-secrets/" class="">Sealed Secrets</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/XaC/secret-as-code/external-secret-operator/" class="">External Secrets Operator</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-92481b079017edd0b6e890ca098af79c" class="toggle"  />
    <label for="section-92481b079017edd0b6e890ca098af79c" class="flex justify-between">
      <a role="button" class="">CI/CD Tools</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/XaC/cicd/argocd/" class="">使用 Argo CD ApplicationSet 管理多集群</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Getting-Started</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/getting-started/monorepo/" class="">MonoRepo</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/getting-started/circle-ci/" class="">Circle CI</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Translation</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-f59f78b27df0d3218be457339234a283" class="toggle"  />
    <label for="section-f59f78b27df0d3218be457339234a283" class="flex justify-between">
      <a role="button" class="">Protocol Buffers</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/translation/protobuf/overview-of-protocal-buffers/" class="">概述</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/translation/protobuf/language-guideproto3/" class="">语言指南（proto3）</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-20038bcc21ca3d914920842c4a32533d" class="toggle"  />
    <label for="section-20038bcc21ca3d914920842c4a32533d" class="flex justify-between">
      <a role="button" class="">LeetCode</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/leetcode/0321/" class="">321. 拼接最大数</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/leetcode/0416/" class="">416. 分割等和子集</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>











  
<ul>
  
  <li>
    <a href="/posts/" >
        Blogs
      </a>
  </li>
  
  <li>
    <a href="https://github.com/howieyuen/" target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>CRD 入门和使用</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#customer-resource">Customer Resource</a>
      <ul>
        <li><a href="#概述">概述</a></li>
        <li><a href="#是否需要自定义资源">是否需要自定义资源</a></li>
        <li><a href="#声明式-api-vs-命令式-api">声明式 API VS 命令式 API</a></li>
      </ul>
    </li>
    <li><a href="#customer-resource-definition">Customer Resource Definition</a>
      <ul>
        <li><a href="#customer-resource-definition-介绍">Customer Resource Definition 介绍</a></li>
        <li><a href="#crd-定义示例">CRD 定义示例</a></li>
        <li><a href="#customer-controller">Customer Controller</a>
          <ul>
            <li><a href="#client-go-组件">client-go 组件</a></li>
            <li><a href="#自定义-controller-组件">自定义 controller 组件</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#sample-controller-使用">sample-controller 使用</a>
      <ul>
        <li><a href="#资源准备">资源准备</a>
          <ul>
            <li><a href="#foocrdyaml">foo.crd.yaml</a></li>
            <li><a href="#examplefooyaml">example.foo.yaml</a></li>
          </ul>
        </li>
        <li><a href="#sample-controller-部署">sample-controller 部署</a>
          <ul>
            <li><a href="#代码">代码</a></li>
            <li><a href="#编译">编译</a></li>
            <li><a href="#启动">启动</a></li>
            <li><a href="#创建资源">创建资源</a></li>
            <li><a href="#校验">校验</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#参考资料">参考资料</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><p>自定义资源是 Kubernetes API 的扩展，本文将讨什么时候应该向 Kubernetes 集群添加自定义资源以及何时使用独立服务。它描述了添加自定义资源的两种方法以及如何在它们之间进行选择。</p>
<h1 id="customer-resource">
  Customer Resource
  <a class="anchor" href="#customer-resource">#</a>
</h1>
<h2 id="概述">
  概述
  <a class="anchor" href="#%e6%a6%82%e8%bf%b0">#</a>
</h2>
<p>资源就是 Kubernetes API 集合中的某个的对象。例如，内置 pods 资源包含 Pod 对象的集合。</p>
<p>自定义资源是扩展了 Kubernetes API，但在默认的 API 集合中是不可用的，因为没有对应的 controller 处理业务逻辑。使用自定义资源，不仅可以解耦大多数的自研功能，还可用使得 Kubernetes 更加模块化。</p>
<p>自定义资源可以通过动态注册的方法，于正在 running 的集群中创建、删除和更新，并且与集群本身的资源是相互独立的。当自定义资源被创建，就可以通过 kubectl 创建和访问对象，和对内置资源的操作完全一致。</p>
<h2 id="是否需要自定义资源">
  是否需要自定义资源
  <a class="anchor" href="#%e6%98%af%e5%90%a6%e9%9c%80%e8%a6%81%e8%87%aa%e5%ae%9a%e4%b9%89%e8%b5%84%e6%ba%90">#</a>
</h2>
<p>在创建新的 API 时，应该考虑与 Kubernetes 的 API 聚合，还是让 API 独立运行。</p>
<table>
<thead>
<tr>
<th>API 聚合</th>
<th>API 独立</th>
</tr>
</thead>
<tbody>
<tr>
<td>声明式</td>
<td>非声明式</td>
</tr>
<tr>
<td>kubectl 可读可写</td>
<td>不需要 kubectl 支持</td>
</tr>
<tr>
<td>接受 k8s 的 REST 限制</td>
<td>特定 API 路径</td>
</tr>
<tr>
<td>可限定为 cluster 或者 namespace</td>
<td>不适用 namespace</td>
</tr>
<tr>
<td>重用 k8s API 支持的功能</td>
<td>不需要这些功能</td>
</tr>
</tbody>
</table>
<h2 id="声明式-api-vs-命令式-api">
  声明式 API VS 命令式 API
  <a class="anchor" href="#%e5%a3%b0%e6%98%8e%e5%bc%8f-api-vs-%e5%91%bd%e4%bb%a4%e5%bc%8f-api">#</a>
</h2>
<p>在声明式 API，通过具有以下特性：</p>
<ul>
<li>对象颗粒度小</li>
<li>基础结构的定义</li>
<li>读写多，更新少，操作主要为 CRUD</li>
<li>API 表期望状态</li>
</ul>
<p>命令式 API，通过具有以下特性：</p>
<ul>
<li>同步响应</li>
<li>RPC 调用</li>
<li>大量数据存储（大对象或多对象）</li>
<li>高带宽访问</li>
<li>操作非 CRUD</li>
<li>API 不易抽象</li>
</ul>
<h1 id="customer-resource-definition">
  Customer Resource Definition
  <a class="anchor" href="#customer-resource-definition">#</a>
</h1>
<p>Kubernetes 提供了两种向集群添加自定义资源的方法：</p>
<ul>
<li>创建自定义 API server 并聚合到 API 中</li>
<li>CRDs</li>
</ul>
<h2 id="customer-resource-definition-介绍">
  Customer Resource Definition 介绍
  <a class="anchor" href="#customer-resource-definition-%e4%bb%8b%e7%bb%8d">#</a>
</h2>
<blockquote class="book-hint info">
  kubernetes: v1.19.0
</blockquote>

<p>通过 CRD 创建自定义资源，只要符合 CRD 结构体定义，均可以被 Kubernetes 所接收，CRD 的定义和 k8s 原生资源的定义非常类似，都是由 4 个子资源组成：TypeMeta、ObjectMeta、Spec、Status，具体代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// staging/src/k8s.io/apiextensions-apiserver/pkg/apis/apiextensions/types.go:354
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CustomResourceDefinition</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">TypeMeta</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ObjectMeta</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Spec</span> <span style="color:#a6e22e">CustomResourceDefinitionSpec</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Status</span> <span style="color:#a6e22e">CustomResourceDefinitionStatus</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>下面主要来看下 Spec 和 Status 字段：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CustomResourceDefinitionSpec</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Group</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 定义复数、单数，简称，Kind，ListKind，Categories
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Names</span> <span style="color:#a6e22e">CustomResourceDefinitionNames</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 表示集群级别或 namespace 级别
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Scope</span> <span style="color:#a6e22e">ResourceScope</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 定义 CR 所有支持的版本号
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Versions</span> []<span style="color:#a6e22e">CustomResourceDefinitionVersion</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 定义不同版本之间的转换方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Conversion</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">CustomResourceConversion</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 是否保留未知字段，apiVersion、kind、metadata 等总是保留
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">PreserveUnknownFields</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CustomResourceDefinitionStatus</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 描述资源的当前状态，即 status.conditions
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Conditions</span> []<span style="color:#a6e22e">CustomResourceDefinitionCondition</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 与 spec.names 类似，即 status.acceptNames
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">AcceptedNames</span> <span style="color:#a6e22e">CustomResourceDefinitionNames</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 资源曾经存在的版本，可在 etcd 中存储，供迁移用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">StoredVersions</span> []<span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="crd-定义示例">
  CRD 定义示例
  <a class="anchor" href="#crd-%e5%ae%9a%e4%b9%89%e7%a4%ba%e4%be%8b">#</a>
</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apiextensions.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">CustomResourceDefinition</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 名称必须符合下面的格式：&lt;plural&gt;.&lt;group&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">foos.samplecontroller.io</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># REST API 使用的组名称：/apis/&lt;group&gt;/&lt;version&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">group</span>: <span style="color:#ae81ff">samplecontroller.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># REST API 使用的版本号：/apis/&lt;group&gt;/&lt;version&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">versions</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">v1alpha1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">served</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storage</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">schema</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 校验方法</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">openAPIV3Schema</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">properties</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">properties</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">#类型校验</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">replicas</span>:
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">integer</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">deploymentName</span>:
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">string</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Namespaced 或 Cluster</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scope</span>: <span style="color:#ae81ff">Namespaced</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">names</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># URL 中使用的复数名称：/apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">plural</span>: <span style="color:#ae81ff">foos</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># CLI 中使用的单数名称</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">singular</span>: <span style="color:#ae81ff">foo</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># CamelCased 格式的单数类型。在清单文件中使用</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Foo</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 资源的 List 类型，默认是 “`kind`List”</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listKind</span>: <span style="color:#ae81ff">FooList</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># CLI 中使用的资源简称</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">shortNames</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">fo</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 分组</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">categories</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">all</span>
</span></span></code></pre></div><h2 id="customer-controller">
  Customer Controller
  <a class="anchor" href="#customer-controller">#</a>
</h2>
<p>只定义资源，不实现资源控制器是没有任何意义的。自定义控制器能够完成业务逻辑，最主要是依赖 client-go 库的各个组件的交互。下图展示它们之间的关系：</p>
<p>
  <img src="/kubernetes/kube-apiserver/crd/client-go-controller-interaction.jpeg" alt="client-go-controller-interaction.jpeg" /></p>
<p>通过图示，可以看到几个核心组件的交互流程，蓝色表示 client-go，黄色是自定义 controller，各组件作用介绍如下：</p>
<h3 id="client-go-组件">
  client-go 组件
  <a class="anchor" href="#client-go-%e7%bb%84%e4%bb%b6">#</a>
</h3>
<ul>
<li><strong>Reflector</strong>：reflector 用来 watch 特定的 k8s API 资源。具体的实现是通过 ListAndWatch 的方法，watch 可以是 k8s 内建的资源或者是自定义的资源。当 reflector 通过 watch API 接收到有关新资源实例存在的通知时，它使用相应的列表 API 获取新创建的对象，并将其放入 watchHandler 函数内的 Delta FIFO 队列中。</li>
<li><strong>Informer</strong>：informer 从 Delta FIFO 队列中弹出对象。执行此操作的功能是 processLoop。base controller 的作用是保存对象以供以后检索，并调用我们的控制器将对象传递给它。</li>
<li><strong>Indexer</strong>：索引器提供对象的索引功能。典型的索引用例是基于对象标签创建索引。 Indexer 可以根据多个索引函数维护索引。Indexer 使用线程安全的数据存储来存储对象及其键。 在 Store 中定义了一个名为 MetaNamespaceKeyFunc 的默认函数，该函数生成对象的键作为该对象的 namespace/name 组合。</li>
</ul>
<h3 id="自定义-controller-组件">
  自定义 controller 组件
  <a class="anchor" href="#%e8%87%aa%e5%ae%9a%e4%b9%89-controller-%e7%bb%84%e4%bb%b6">#</a>
</h3>
<ul>
<li><strong>Informer reference</strong>：指的是 Informer 实例的引用，定义如何使用自定义资源对象。自定义控制器代码需要创建对应的 Informer。</li>
<li><strong>Indexer reference</strong>：自定义控制器对 Indexer 实例的引用。自定义控制器需要创建对应的 Indexer。</li>
<li><strong>Resource Event Handlers</strong>：资源事件回调函数，当它想要将对象传递给控制器时，它将被调用。编写这些函数的典型模式是获取调度对象的 key，并将该 key 排入工作队列以进行进一步处理。</li>
<li><strong>Work queue</strong>：任务队列。编写资源事件处理程序函数以提取传递的对象的 key 并将其添加到任务队列。</li>
<li><strong>Process Item</strong>：处理任务队列中对象的函数，这些函数通常使用 Indexer 引用或 Listing 包装器来重试与该 key 对应的对象。</li>
</ul>
<p>简单的说，整个处理流程大概为：Reflector 通过检测 Kubernetes API 来跟踪该扩展资源类型的变化，一旦发现有变化，就将该 Object 存储队列中，Informer 循环取出该 Object 并将其存入 Indexer 进行检索，同时触发 Callback 回调函数，并将变更的 Object Key 信息放入到工作队列中，此时自定义 Controller 里面的 Process Item 就会获取工作队列里面的 Key，并从 Indexer 中获取 Key 对应的 Object，从而进行相关的业务处理。</p>
<h1 id="sample-controller-使用">
  sample-controller 使用
  <a class="anchor" href="#sample-controller-%e4%bd%bf%e7%94%a8">#</a>
</h1>
<h2 id="资源准备">
  资源准备
  <a class="anchor" href="#%e8%b5%84%e6%ba%90%e5%87%86%e5%a4%87">#</a>
</h2>
<h3 id="foocrdyaml">
  foo.crd.yaml
  <a class="anchor" href="#foocrdyaml">#</a>
</h3>
<p>使用 2.2 节的示例。</p>
<h3 id="examplefooyaml">
  example.foo.yaml
  <a class="anchor" href="#examplefooyaml">#</a>
</h3>
<p>创建 foo 资源类型的对象：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">samplecontroller.io/v1alpha1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Foo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">example-foo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">deploymentName</span>: <span style="color:#ae81ff">example-foo</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><h2 id="sample-controller-部署">
  sample-controller 部署
  <a class="anchor" href="#sample-controller-%e9%83%a8%e7%bd%b2">#</a>
</h2>
<h3 id="代码">
  代码
  <a class="anchor" href="#%e4%bb%a3%e7%a0%81">#</a>
</h3>
<p>获取示例代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-s" data-lang="s"><span style="display:flex;"><span><span style="color:#f92672">$</span> git clone https<span style="color:#f92672">://</span>github.com<span style="color:#f92672">/</span>kubernetes<span style="color:#f92672">/</span>sample<span style="color:#f92672">-</span>controller.git
</span></span><span style="display:flex;"><span><span style="color:#f92672">$</span> cd sample<span style="color:#f92672">-</span>controller
</span></span></code></pre></div><h3 id="编译">
  编译
  <a class="anchor" href="#%e7%bc%96%e8%af%91">#</a>
</h3>
<p>在编译二进制之前，要修改 <code>pkg/apis/samplecontroller/register.go:21</code> GroupName 的定义，k8s.io 和 kubernetes.io 后缀都是官方保留字段，不建议 CRD 使用。所以将其修改为 <code>samplecontroller.io</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-s" data-lang="s"><span style="display:flex;"><span><span style="color:#f92672">$</span> go build <span style="color:#f92672">-</span>o sample<span style="color:#f92672">-</span>controller .
</span></span></code></pre></div><h3 id="启动">
  启动
  <a class="anchor" href="#%e5%90%af%e5%8a%a8">#</a>
</h3>
<p>使用节点上的 kubeconfig 文件启动 controller：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-s" data-lang="s"><span style="display:flex;"><span><span style="color:#f92672">$</span> ./sample<span style="color:#f92672">-</span>controller <span style="color:#f92672">-</span>kubeconfig<span style="color:#f92672">=$</span>HOME<span style="color:#f92672">/</span>.kube<span style="color:#f92672">/</span>config
</span></span></code></pre></div><p>启动时，会提示 watch 不到资源，因为还没创建定义：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-s" data-lang="s"><span style="display:flex;"><span>I1026 <span style="color:#ae81ff">23</span><span style="color:#f92672">:</span><span style="color:#ae81ff">40</span><span style="color:#f92672">:</span><span style="color:#ae81ff">56.529233</span>   <span style="color:#ae81ff">57978</span> controller.go<span style="color:#f92672">:</span><span style="color:#ae81ff">115</span>] Setting up event handlers
</span></span><span style="display:flex;"><span>I1026 <span style="color:#ae81ff">23</span><span style="color:#f92672">:</span><span style="color:#ae81ff">40</span><span style="color:#f92672">:</span><span style="color:#ae81ff">56.529444</span>   <span style="color:#ae81ff">57978</span> controller.go<span style="color:#f92672">:</span><span style="color:#ae81ff">156</span>] Starting Foo controller
</span></span><span style="display:flex;"><span>I1026 <span style="color:#ae81ff">23</span><span style="color:#f92672">:</span><span style="color:#ae81ff">40</span><span style="color:#f92672">:</span><span style="color:#ae81ff">56.529450</span>   <span style="color:#ae81ff">57978</span> controller.go<span style="color:#f92672">:</span><span style="color:#ae81ff">159</span>] Waiting <span style="color:#66d9ef">for</span> informer caches to sync
</span></span><span style="display:flex;"><span>E1026 <span style="color:#ae81ff">23</span><span style="color:#f92672">:</span><span style="color:#ae81ff">40</span><span style="color:#f92672">:</span><span style="color:#ae81ff">56.554564</span>   <span style="color:#ae81ff">57978</span> reflector.go<span style="color:#f92672">:</span><span style="color:#ae81ff">138</span>] k8s.io<span style="color:#f92672">/</span>sample<span style="color:#f92672">-</span>controller<span style="color:#f92672">/</span>pkg<span style="color:#f92672">/</span>generated<span style="color:#f92672">/</span>informers<span style="color:#f92672">/</span>externalversions<span style="color:#f92672">/</span>factory.go<span style="color:#f92672">:</span><span style="color:#ae81ff">117</span><span style="color:#f92672">:</span> Failed to watch <span style="color:#f92672">*</span>v1alpha1.Foo<span style="color:#f92672">:</span> failed to list <span style="color:#f92672">*</span>v1alpha1.Foo<span style="color:#f92672">:</span> the server could not find the requested <span style="color:#a6e22e">resource </span>(get foos.samplecontroller.io)
</span></span><span style="display:flex;"><span>E1026 <span style="color:#ae81ff">23</span><span style="color:#f92672">:</span><span style="color:#ae81ff">40</span><span style="color:#f92672">:</span><span style="color:#ae81ff">57.841194</span>   <span style="color:#ae81ff">57978</span> reflector.go<span style="color:#f92672">:</span><span style="color:#ae81ff">138</span>] k8s.io<span style="color:#f92672">/</span>sample<span style="color:#f92672">-</span>controller<span style="color:#f92672">/</span>pkg<span style="color:#f92672">/</span>generated<span style="color:#f92672">/</span>informers<span style="color:#f92672">/</span>externalversions<span style="color:#f92672">/</span>factory.go<span style="color:#f92672">:</span><span style="color:#ae81ff">117</span><span style="color:#f92672">:</span> Failed to watch <span style="color:#f92672">*</span>v1alpha1.Foo<span style="color:#f92672">:</span> failed to list <span style="color:#f92672">*</span>v1alpha1.Foo<span style="color:#f92672">:</span> the server could not find the requested <span style="color:#a6e22e">resource </span>(get foos.samplecontroller.io)
</span></span></code></pre></div><h3 id="创建资源">
  创建资源
  <a class="anchor" href="#%e5%88%9b%e5%bb%ba%e8%b5%84%e6%ba%90">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-s" data-lang="s"><span style="display:flex;"><span><span style="color:#f92672">$</span> kubectl create <span style="color:#f92672">-</span>f foos.crd.yaml
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io<span style="color:#f92672">/</span>foos.samplecontroller.io created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">$</span> kubectl create <span style="color:#f92672">-</span>f example.foos.yaml
</span></span><span style="display:flex;"><span>foo.samplecontroller.io<span style="color:#f92672">/</span>example<span style="color:#f92672">-</span>foo created
</span></span></code></pre></div><p>创建完成，可以使用 <code>kubectl get crd</code> 查看资源定义和对象：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-s" data-lang="s"><span style="display:flex;"><span><span style="color:#f92672">$</span> kubectl get crd
</span></span><span style="display:flex;"><span>NAME                       CREATED AT
</span></span><span style="display:flex;"><span>clusterversions.cfe.io     <span style="color:#ae81ff">2020-10-26</span>T14<span style="color:#f92672">:</span><span style="color:#ae81ff">43</span><span style="color:#f92672">:</span><span style="color:#ae81ff">27</span>Z
</span></span><span style="display:flex;"><span>foos.samplecontroller.io   <span style="color:#ae81ff">2020-10-26</span>T15<span style="color:#f92672">:</span><span style="color:#ae81ff">41</span><span style="color:#f92672">:</span><span style="color:#ae81ff">52</span>Z
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">$</span> kubectl get foos
</span></span><span style="display:flex;"><span>NAME          AGE
</span></span><span style="display:flex;"><span>example<span style="color:#f92672">-</span>foo   <span style="color:#ae81ff">19</span>m
</span></span></code></pre></div><p>sample-controller 会 watch 到新对象 default/example-foo：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-s" data-lang="s"><span style="display:flex;"><span>I1026 <span style="color:#ae81ff">23</span><span style="color:#f92672">:</span><span style="color:#ae81ff">42</span><span style="color:#f92672">:</span><span style="color:#ae81ff">03.232577</span>   <span style="color:#ae81ff">57978</span> controller.go<span style="color:#f92672">:</span><span style="color:#ae81ff">164</span>] Starting workers
</span></span><span style="display:flex;"><span>I1026 <span style="color:#ae81ff">23</span><span style="color:#f92672">:</span><span style="color:#ae81ff">42</span><span style="color:#f92672">:</span><span style="color:#ae81ff">03.232607</span>   <span style="color:#ae81ff">57978</span> controller.go<span style="color:#f92672">:</span><span style="color:#ae81ff">170</span>] Started workers
</span></span><span style="display:flex;"><span>I1026 <span style="color:#ae81ff">23</span><span style="color:#f92672">:</span><span style="color:#ae81ff">42</span><span style="color:#f92672">:</span><span style="color:#ae81ff">03.515970</span>   <span style="color:#ae81ff">57978</span> controller.go<span style="color:#f92672">:</span><span style="color:#ae81ff">228</span>] Successfully synced <span style="color:#e6db74">&#39;default/example-foo&#39;</span>
</span></span><span style="display:flex;"><span>I1026 <span style="color:#ae81ff">23</span><span style="color:#f92672">:</span><span style="color:#ae81ff">42</span><span style="color:#f92672">:</span><span style="color:#ae81ff">03.516099</span>   <span style="color:#ae81ff">57978</span> event.go<span style="color:#f92672">:</span><span style="color:#ae81ff">291</span>] <span style="color:#e6db74">&#34;Event occurred&#34;</span> object<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;default/example-foo&#34;</span> kind<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Foo&#34;</span> apiVersion<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;samplecontroller.io/v1alpha1&#34;</span> type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Normal&#34;</span> reason<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Synced&#34;</span> message<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Foo synced successfully&#34;</span>
</span></span></code></pre></div><h3 id="校验">
  校验
  <a class="anchor" href="#%e6%a0%a1%e9%aa%8c">#</a>
</h3>
<p>检查 controller 创建 Deployment 对象：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-s" data-lang="s"><span style="display:flex;"><span><span style="color:#f92672">$</span> kubectl get deploy                       
</span></span><span style="display:flex;"><span>NAME          READY   UP<span style="color:#f92672">-</span>TO<span style="color:#f92672">-</span>DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>example<span style="color:#f92672">-</span>foo   <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           <span style="color:#ae81ff">3</span>m1s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">$</span> kubectl get pod
</span></span><span style="display:flex;"><span>NAME                           READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>example<span style="color:#f92672">-</span>foo<span style="color:#ae81ff">-54</span>dc4db9fc<span style="color:#ae81ff">-4</span>r8pp   <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     Running   <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">3</span>m8s
</span></span><span style="display:flex;"><span>shell<span style="color:#f92672">-</span>demo                     <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     Running   <span style="color:#ae81ff">9</span>          <span style="color:#ae81ff">43</span>d
</span></span><span style="display:flex;"><span>web<span style="color:#ae81ff">-0</span>                          <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     Running   <span style="color:#ae81ff">16</span>         <span style="color:#ae81ff">78</span>d
</span></span><span style="display:flex;"><span>web<span style="color:#ae81ff">-1</span>                          <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     Running   <span style="color:#ae81ff">16</span>         <span style="color:#ae81ff">78</span>d
</span></span></code></pre></div><h1 id="参考资料">
  参考资料
  <a class="anchor" href="#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99">#</a>
</h1>
<ul>
<li>
  <a href="https://kubernetes.io/zh/docs/concepts/extend-kubernetes/api-extension/custom-resources/">定制资源</a></li>
<li>
  <a href="https://github.com/kubernetes/sample-controller/blob/master/docs/controller-client-go.md">controller-client-go</a></li>
<li>
  <a href="https://github.com/kubernetes/sample-controller/blob/master/README.md">sample-controller</a></li>
</ul></article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">


  <div><a class="flex align-center" href="https://github.com/howieyuen/howieyuen.github.io/commit/8170fbc7cf90437629b14d4ade72a3e39a5e79be" title='Last modified by howieyuen | January 23, 2024' target="_blank" rel="noopener">
      <img src="/svg/calendar.svg" class="book-icon" alt="Calendar" />
      <span>January 23, 2024</span>
    </a>
  </div>




</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">



<div id="gitalk-container"></div>
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script>
  const gitalk = new Gitalk({
    clientID: 'b4cc17dbafc8ad637453',
    clientSecret: '77b4685b4d6da0280eca116a66b6f01244033d35',
    repo: 'howieyuen.github.io',
    owner: 'howieyuen',
    admin: ['howieyuen'],
    id: location.pathname, 
    distractionFreeMode: false 
  });
  (function() {
    if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
      document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
      return;
    }
    gitalk.render('gitalk-container');
  })();
</script>

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#customer-resource">Customer Resource</a>
      <ul>
        <li><a href="#概述">概述</a></li>
        <li><a href="#是否需要自定义资源">是否需要自定义资源</a></li>
        <li><a href="#声明式-api-vs-命令式-api">声明式 API VS 命令式 API</a></li>
      </ul>
    </li>
    <li><a href="#customer-resource-definition">Customer Resource Definition</a>
      <ul>
        <li><a href="#customer-resource-definition-介绍">Customer Resource Definition 介绍</a></li>
        <li><a href="#crd-定义示例">CRD 定义示例</a></li>
        <li><a href="#customer-controller">Customer Controller</a>
          <ul>
            <li><a href="#client-go-组件">client-go 组件</a></li>
            <li><a href="#自定义-controller-组件">自定义 controller 组件</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#sample-controller-使用">sample-controller 使用</a>
      <ul>
        <li><a href="#资源准备">资源准备</a>
          <ul>
            <li><a href="#foocrdyaml">foo.crd.yaml</a></li>
            <li><a href="#examplefooyaml">example.foo.yaml</a></li>
          </ul>
        </li>
        <li><a href="#sample-controller-部署">sample-controller 部署</a>
          <ul>
            <li><a href="#代码">代码</a></li>
            <li><a href="#编译">编译</a></li>
            <li><a href="#启动">启动</a></li>
            <li><a href="#创建资源">创建资源</a></li>
            <li><a href="#校验">校验</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#参考资料">参考资料</a></li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












