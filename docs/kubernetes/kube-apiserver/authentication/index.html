<!DOCTYPE html>
<html lang="en" dir=>

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="1. Kubernetes 中的用户 #  所有 Kubernetes 集群都有两类用户：由 Kubernetes 管理的 ServiceAccount 和普通用户。
对于与普通用户，Kuernetes 使用以下方式管理：
 负责分发私钥的管理员 类似 Keystone 或者 Google Accounts 这类用户数据库 包含用户名和密码列表的文件  因此，kubernetes 并不提供普通用户的定义，普通用户是无法通过 API 调用写入到集群中的。
尽管如此，通过集群的证书机构签名的合法证书的用户，kubernetes 依旧可以认为是合法用户。基于此，kubernetes 使用证书中的 subject.CommonName 字段来确定用户名，接下来，通过 RBAC 确认用户对某资源是否存在要求的操作权限。
与此不同的 ServiceAccount，与 Namespace 绑定，与一组 Secret 所包含的凭据有关。这些凭据会挂载到 Pod 中，从而允许访问 kubernetes 的 API。
API 请求要么与普通用户相关，要么与 ServiceAccount 相关，其他的视为匿名请求。这意味着集群内和集群外的每个进程向 kube-apiserver 发起请求时，都必须通过身份认证，否则会被视为匿名用户。
2. 认证机制 #  目前 kubernetes 提供的认证机制丰富多样，尤其是身份验证，更是五花八门：
 身份验证  X509 Client Cert Static Token File Bootstrap Tokens Static Password File（deprecated in v1.">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="认证机制" />
<meta property="og:description" content="1. Kubernetes 中的用户 #  所有 Kubernetes 集群都有两类用户：由 Kubernetes 管理的 ServiceAccount 和普通用户。
对于与普通用户，Kuernetes 使用以下方式管理：
 负责分发私钥的管理员 类似 Keystone 或者 Google Accounts 这类用户数据库 包含用户名和密码列表的文件  因此，kubernetes 并不提供普通用户的定义，普通用户是无法通过 API 调用写入到集群中的。
尽管如此，通过集群的证书机构签名的合法证书的用户，kubernetes 依旧可以认为是合法用户。基于此，kubernetes 使用证书中的 subject.CommonName 字段来确定用户名，接下来，通过 RBAC 确认用户对某资源是否存在要求的操作权限。
与此不同的 ServiceAccount，与 Namespace 绑定，与一组 Secret 所包含的凭据有关。这些凭据会挂载到 Pod 中，从而允许访问 kubernetes 的 API。
API 请求要么与普通用户相关，要么与 ServiceAccount 相关，其他的视为匿名请求。这意味着集群内和集群外的每个进程向 kube-apiserver 发起请求时，都必须通过身份认证，否则会被视为匿名用户。
2. 认证机制 #  目前 kubernetes 提供的认证机制丰富多样，尤其是身份验证，更是五花八门：
 身份验证  X509 Client Cert Static Token File Bootstrap Tokens Static Password File（deprecated in v1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://howieyuen.github.io/docs/kubernetes/kube-apiserver/authentication/" /><meta property="article:section" content="docs" />
<meta property="article:published_time" content="2020-11-22T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-05-05T17:06:14+08:00" />

<title>认证机制 | 袁昊的学习笔记</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.78dd9f31800b2b5e96d379b042e0b5781bff2d1721c46b00055aa3e7222f3a3c.css" integrity="sha256-eN2fMYALK16W03mwQuC1eBv/LRchxGsABVqj5yIvOjw=">
<script defer src="/en.search.min.306f3039b68c95e12639226149ab899af825bbaf2c2b9228bc3adf4e030996ee.js" integrity="sha256-MG8wObaMleEmOSJhSauJmvglu68sK5IovDrfTgMJlu4="></script>

<script defer src="/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js" integrity="sha256-b2&#43;Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC&#43;NdcPIvZhzk="></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body dir=>
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><img src="/logo.jpeg" alt="Logo" /><span>袁昊的学习笔记</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  



  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Golang</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>数据结构</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/golang/data-structure/chan/" class="">chan</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/golang/data-structure/map/" class="">map</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/golang/data-structure/slice/" class="">slice</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>语言基础</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/golang/language-basics/unsafe/" class="">unsafe</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/golang/language-basics/reflect/" class="">reflect</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>内存管理</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/golang/memory-manage/memory-model/" class="">内存模型</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>golang 工具</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/golang/tools/pprof/" class="">pprof</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Kubernetes</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>kube-apisever</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/kube-apiserver/authorization/" class="">鉴权机制</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/kube-apiserver/authentication/" class=" active">认证机制</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/kube-apiserver/garbage-collector/" class="">垃圾回收</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/kube-apiserver/key-design-of-etcd-watch/" class="">watch 关键设计</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/kube-apiserver/crd/" class="">CRD 入门和使用</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>kube-controller-manager</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/kube-controller-manager/code-analysis-of-garbagecollector-controller/" class="">GC Controller 源码分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/kube-controller-manager/code-analysis-of-daemonset-controller/" class="">DaemonSet Controller 源码分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/kube-controller-manager/code-analysis-of-statefulset-controller/" class="">Statefulset Controller 源码分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/kube-controller-manager/k8s-apps-rolling-update/" class="">无状态应用滚动更新</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>kube-scheduler</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/kube-scheduler/advanced-scheduling/" class="">高级调度</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>kubelet</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/kubelet/kubelet-topology-manager/" class="">Topology Manager 设计方案</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/kubelet/kubelet-eviction-manager/" class="">Eviction Manager 工作机制</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>sig-network</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/kubernetes/sig-network/learn-about-Service/" class="">深入了解 Service</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-20038bcc21ca3d914920842c4a32533d" class="toggle"  />
    <label for="section-20038bcc21ca3d914920842c4a32533d" class="flex justify-between">
      <a  class="">LeetCode</a>
      <span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/leetcode/0321/" class="">321. 拼接最大数</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://howieyuen.github.io/docs/leetcode/0416/" class="">416. 分割等和子集</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>











  
<ul>
  
  <li>
    <a href="/posts/" >
        Blog
      </a>
  </li>
  
  <li>
    <a href="https://github.com/howieyuen/" target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
  <li>
    <a href="https://themes.gohugo.io/hugo-book/" target="_blank" rel="noopener">
        Hugo Themes
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var e=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>认证机制</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  <nav id="TableOfContents">
  <ul>
    <li><a href="#1-kubernetes-中的用户">1. Kubernetes 中的用户</a></li>
    <li><a href="#2-认证机制">2. 认证机制</a>
      <ul>
        <li><a href="#21-身份验证策略">2.1 身份验证策略</a>
          <ul>
            <li><a href="#211-x509-client-cert">2.1.1 X509 Client Cert</a></li>
            <li><a href="#212-static-token-file">2.1.2 Static Token File</a></li>
            <li><a href="#213-bootstrap-tokens">2.1.3 Bootstrap Tokens</a></li>
            <li><a href="#214--serviceaccount-token">2.1.4  ServiceAccount Token</a></li>
            <li><a href="#215-openid-connect-token">2.1.5 OpenID Connect Token</a></li>
            <li><a href="#216-webhook-token">2.1.6 Webhook Token</a></li>
            <li><a href="#217-authentication-proxy">2.1.7 Authentication Proxy</a></li>
          </ul>
        </li>
        <li><a href="#22-其他">2.2 其他</a></li>
      </ul>
    </li>
  </ul>
</nav>


  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="1-kubernetes-中的用户">
  1. Kubernetes 中的用户
  <a class="anchor" href="#1-kubernetes-%e4%b8%ad%e7%9a%84%e7%94%a8%e6%88%b7">#</a>
</h1>
<p>所有 Kubernetes 集群都有两类用户：由 Kubernetes 管理的 ServiceAccount 和普通用户。</p>
<p>对于与普通用户，Kuernetes 使用以下方式管理：</p>
<ul>
<li>负责分发私钥的管理员</li>
<li>类似 Keystone 或者 Google Accounts 这类用户数据库</li>
<li>包含用户名和密码列表的文件</li>
</ul>
<p>因此，kubernetes 并不提供普通用户的定义，普通用户是无法通过 API 调用写入到集群中的。</p>
<p>尽管如此，通过集群的证书机构签名的合法证书的用户，kubernetes 依旧可以认为是合法用户。基于此，kubernetes 使用证书中的 <code>subject.CommonName</code> 字段来确定用户名，接下来，通过 RBAC 确认用户对某资源是否存在要求的操作权限。</p>
<p>与此不同的 ServiceAccount，与 Namespace 绑定，与一组 Secret 所包含的凭据有关。这些凭据会挂载到 Pod 中，从而允许访问 kubernetes 的 API。</p>
<p>API 请求要么与普通用户相关，要么与 ServiceAccount 相关，其他的视为匿名请求。这意味着集群内和集群外的每个进程向 kube-apiserver 发起请求时，都必须通过身份认证，否则会被视为匿名用户。</p>
<h1 id="2-认证机制">
  2. 认证机制
  <a class="anchor" href="#2-%e8%ae%a4%e8%af%81%e6%9c%ba%e5%88%b6">#</a>
</h1>
<p>目前 kubernetes 提供的认证机制丰富多样，尤其是身份验证，更是五花八门：</p>
<ul>
<li>身份验证
<ul>
<li>X509 Client Cert</li>
<li>Static Token File</li>
<li>Bootstrap Tokens</li>
<li><del>Static Password File</del>（deprecated in v1.16）</li>
<li>ServiceAccount Token</li>
<li>OpenID Connect Token</li>
<li>Webhook Token</li>
<li>Authentication Proxy</li>
</ul>
</li>
<li>匿名请求</li>
<li>用户伪装</li>
<li>client-go 凭据插件</li>
</ul>
<h2 id="21-身份验证策略">
  2.1 身份验证策略
  <a class="anchor" href="#21-%e8%ba%ab%e4%bb%bd%e9%aa%8c%e8%af%81%e7%ad%96%e7%95%a5">#</a>
</h2>
<h3 id="211-x509-client-cert">
  2.1.1 X509 Client Cert
  <a class="anchor" href="#211-x509-client-cert">#</a>
</h3>
<p>X509 客户端证书认证，也被称为 TLS 双向认证，即为服务端和客户端互相验证证书的正确性。使用此认证方式，只要是 CA 签名过的证书都能通过认证。</p>
<ol>
<li>
<p>启用</p>
<p>kube-apiserver 通过指定 <code>--client-ca-file</code> 参数启用此认证方式。</p>
</li>
<li>
<p>认证接口</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// staging/src/k8s.io/apiserver/pkg/authentication/authenticator/interfaces.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Request</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">AuthenticateRequest</span>(<span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">Response</span>, <span style="color:#66d9ef">bool</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>该方法接收客户端请求。若验证失败，bool 返回 false，验证成功，bool 返回 true，Response 中携带身份验证用户的信息，例如 Name、UID、Groups、Extra。</p>
</li>
<li>
<p>认证实现</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// staging/src/k8s.io/apiserver/pkg/authentication/request/x509/x509.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Authenticator</span>) <span style="color:#a6e22e">AuthenticateRequest</span>(<span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">authenticator</span>.<span style="color:#a6e22e">Response</span>, <span style="color:#66d9ef">bool</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">TLS</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">||</span> len(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">TLS</span>.<span style="color:#a6e22e">PeerCertificates</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Use intermediates, if provided
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">optsCopy</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">verifyOptionsFn</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// if there are intentionally no verify options, then we cannot authenticate this request
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">optsCopy</span>.<span style="color:#a6e22e">Intermediates</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">TLS</span>.<span style="color:#a6e22e">PeerCertificates</span>) &gt; <span style="color:#ae81ff">1</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">optsCopy</span>.<span style="color:#a6e22e">Intermediates</span> = <span style="color:#a6e22e">x509</span>.<span style="color:#a6e22e">NewCertPool</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">intermediate</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">TLS</span>.<span style="color:#a6e22e">PeerCertificates</span>[<span style="color:#ae81ff">1</span>:] {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">optsCopy</span>.<span style="color:#a6e22e">Intermediates</span>.<span style="color:#a6e22e">AddCert</span>(<span style="color:#a6e22e">intermediate</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">remaining</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">TLS</span>.<span style="color:#a6e22e">PeerCertificates</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">NotAfter</span>.<span style="color:#a6e22e">Sub</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">clientCertificateExpirationHistogram</span>.<span style="color:#a6e22e">Observe</span>(<span style="color:#a6e22e">remaining</span>.<span style="color:#a6e22e">Seconds</span>())
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 校验证书，如果通过，可解析 user 信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">chains</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">TLS</span>.<span style="color:#a6e22e">PeerCertificates</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Verify</span>(<span style="color:#a6e22e">optsCopy</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">errlist</span> []<span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">chain</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">chains</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">user</span>, <span style="color:#a6e22e">ok</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">User</span>(<span style="color:#a6e22e">chain</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">errlist</span> = append(<span style="color:#a6e22e">errlist</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">user</span>, <span style="color:#a6e22e">ok</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">utilerrors</span>.<span style="color:#a6e22e">NewAggregate</span>(<span style="color:#a6e22e">errlist</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ol>
<h3 id="212-static-token-file">
  2.1.2 Static Token File
  <a class="anchor" href="#212-static-token-file">#</a>
</h3>
<p>Token 也被称为令牌，服务端为了验证客户端身份，需要客户端向服务端提供一个可靠的验证信息，这个验证信息就是 Token。目前，令牌会长期有效，并且在不重启 API 服务器的情况下 无法更改令牌列表。</p>
<ol>
<li>
<p>启用</p>
<p>kube-apiserver 通过指定 <code>--token-auth-file</code> 参数启用，令牌文件是一个 CSV 文件，包含至少 3 个列：令牌、用户名和用户的 UID。 其余列被视为可选的组名。示例如下：</p>
<pre tabindex="0"><code>token,user,uid,&#34;group1,group2,group3&#34;
</code></pre></li>
<li>
<p>请求头配置</p>
<p>在 HTTP 请求头中，设置 Authentication 的值，格式为 Bearer $TOKEN，格式如下：</p>
<pre tabindex="0"><code>Authorization: Bearer 31ada4fd-adec-460c-809a-9e56ceb75269
</code></pre></li>
<li>
<p>认证实现</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// staging/src/k8s.io/apiserver/pkg/authentication/token/tokenfile/tokenfile.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TokenAuthenticator</span>) <span style="color:#a6e22e">AuthenticateToken</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">value</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">authenticator</span>.<span style="color:#a6e22e">Response</span>, <span style="color:#66d9ef">bool</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">user</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">tokens</span>[<span style="color:#a6e22e">value</span>]
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">authenticator</span>.<span style="color:#a6e22e">Response</span>{<span style="color:#a6e22e">User</span>: <span style="color:#a6e22e">user</span>}, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>该认证方式相对简单，a.tokens 保存了服务端 Token 列表，通过 map 查询客户端提供的 Token 是否存在，存在即认证成功，反之则认证失败。</p>
</li>
</ol>
<h3 id="213-bootstrap-tokens">
  2.1.3 Bootstrap Tokens
  <a class="anchor" href="#213-bootstrap-tokens">#</a>
</h3>
<p>Bootstrap Token 是一种简单的 Bearer Token，这种令牌是在新建集群或者在现在集群中加入节点时使用。一般是由 kubeadm 管理，以 secret 形式保存在 kube-system 命名空间，可以动态地创建删除，并且 kube-controller-manager 中 TokenCleaner 会在 Token 过期时删除。该能力目前依旧是 alpha 阶段，但官方预期也不会有大的突破性变化。</p>
<ol>
<li>
<p>启用</p>
<p>kube-apiserver 设置 <code>--enable-bootstrap-token</code> 启动 Bootstrap Token 身份认证，并且依赖 kube-controller-manager 设置 <code>--controllers=*,tokencleaner,bootstrapsigner</code> 启动 TokenCleaner 和 BootstrapSigner。</p>
</li>
<li>
<p>请求头配置</p>
<p>Token 的格式为 <code>[a-z0-9]{6}.[a-z0-9]{16}</code>，第一部分是 token id，第二部分是 token 的 secret。可以用如下方式设置 HTTP Header：</p>
<pre tabindex="0"><code>Authorization: Bearer 781292.db7bc3a58fc5f07e
</code></pre></li>
<li>
<p>认证实现</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// plugin/pkg/auth/authenticator/token/bootstrap/bootstrap.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TokenAuthenticator</span>) <span style="color:#a6e22e">AuthenticateToken</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">token</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">authenticator</span>.<span style="color:#a6e22e">Response</span>, <span style="color:#66d9ef">bool</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 1. 校验 token 格式
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">tokenID</span>, <span style="color:#a6e22e">tokenSecret</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bootstraptokenutil</span>.<span style="color:#a6e22e">ParseToken</span>(<span style="color:#a6e22e">token</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 2. 拼接 secret name，获取 secret 对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">secretName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bootstrapapi</span>.<span style="color:#a6e22e">BootstrapTokenSecretPrefix</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">tokenID</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">secret</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">lister</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">secretName</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">IsNotFound</span>(<span style="color:#a6e22e">err</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">3</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;No secret of name %s to match bootstrap bearer token&#34;</span>, <span style="color:#a6e22e">secretName</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 3. 校验 secret 有效，不在删除中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">secret</span>.<span style="color:#a6e22e">DeletionTimestamp</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">tokenErrorf</span>(<span style="color:#a6e22e">secret</span>, <span style="color:#e6db74">&#34;is deleted and awaiting removal&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 4. 校验 secret 类型必须是 bootstrap.kubernetes.io/token
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> string(<span style="color:#a6e22e">secret</span>.<span style="color:#a6e22e">Type</span>) <span style="color:#f92672">!=</span> string(<span style="color:#a6e22e">bootstrapapi</span>.<span style="color:#a6e22e">SecretTypeBootstrapToken</span>) <span style="color:#f92672">||</span> <span style="color:#a6e22e">secret</span>.<span style="color:#a6e22e">Data</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">tokenErrorf</span>(<span style="color:#a6e22e">secret</span>, <span style="color:#e6db74">&#34;has invalid type, expected %s.&#34;</span>, <span style="color:#a6e22e">bootstrapapi</span>.<span style="color:#a6e22e">SecretTypeBootstrapToken</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 5. 校验 token secret 有效
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ts</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bootstrapsecretutil</span>.<span style="color:#a6e22e">GetData</span>(<span style="color:#a6e22e">secret</span>, <span style="color:#a6e22e">bootstrapapi</span>.<span style="color:#a6e22e">BootstrapTokenSecretKey</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">subtle</span>.<span style="color:#a6e22e">ConstantTimeCompare</span>([]byte(<span style="color:#a6e22e">ts</span>), []byte(<span style="color:#a6e22e">tokenSecret</span>)) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">tokenErrorf</span>(<span style="color:#a6e22e">secret</span>, <span style="color:#e6db74">&#34;has invalid value for key %s, expected %s.&#34;</span>, <span style="color:#a6e22e">bootstrapapi</span>.<span style="color:#a6e22e">BootstrapTokenSecretKey</span>, <span style="color:#a6e22e">tokenSecret</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 6. 校验 token id 有效
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bootstrapsecretutil</span>.<span style="color:#a6e22e">GetData</span>(<span style="color:#a6e22e">secret</span>, <span style="color:#a6e22e">bootstrapapi</span>.<span style="color:#a6e22e">BootstrapTokenIDKey</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">id</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">tokenID</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">tokenErrorf</span>(<span style="color:#a6e22e">secret</span>, <span style="color:#e6db74">&#34;has invalid value for key %s, expected %s.&#34;</span>, <span style="color:#a6e22e">bootstrapapi</span>.<span style="color:#a6e22e">BootstrapTokenIDKey</span>, <span style="color:#a6e22e">tokenID</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 7. 校验 token 是否过期
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">bootstrapsecretutil</span>.<span style="color:#a6e22e">HasExpired</span>(<span style="color:#a6e22e">secret</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()) {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// logging done in isSecretExpired method.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 8. 校验 secret 对象的 data 字段中，key 为 usage-bootstrap-authentication，value 为 true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">bootstrapsecretutil</span>.<span style="color:#a6e22e">GetData</span>(<span style="color:#a6e22e">secret</span>, <span style="color:#a6e22e">bootstrapapi</span>.<span style="color:#a6e22e">BootstrapTokenUsageAuthentication</span>) <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;true&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">tokenErrorf</span>(<span style="color:#a6e22e">secret</span>, <span style="color:#e6db74">&#34;not marked %s=true.&#34;</span>, <span style="color:#a6e22e">bootstrapapi</span>.<span style="color:#a6e22e">BootstrapTokenUsageAuthentication</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 9. 获取 secret.data[auth-extra-groups]，与 default group 组合
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">groups</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bootstrapsecretutil</span>.<span style="color:#a6e22e">GetGroups</span>(<span style="color:#a6e22e">secret</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">tokenErrorf</span>(<span style="color:#a6e22e">secret</span>, <span style="color:#e6db74">&#34;has invalid value for key %s: %v.&#34;</span>, <span style="color:#a6e22e">bootstrapapi</span>.<span style="color:#a6e22e">BootstrapTokenExtraGroupsKey</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">authenticator</span>.<span style="color:#a6e22e">Response</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">User</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">DefaultInfo</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Name</span>:   <span style="color:#a6e22e">bootstrapapi</span>.<span style="color:#a6e22e">BootstrapUserPrefix</span> <span style="color:#f92672">+</span> string(<span style="color:#a6e22e">id</span>),
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Groups</span>: <span style="color:#a6e22e">groups</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	}, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ol>
<h3 id="214--serviceaccount-token">
  2.1.4  ServiceAccount Token
  <a class="anchor" href="#214--serviceaccount-token">#</a>
</h3>
<p>其他认证方式都是从 kubernetes 集群外部访问 kube-apiserver 组件，而 ServiceAccount 是从 Pod 内部访问，提供给 Pod 中的进程使用。ServiceAccount 包含了 3 个部分的内容：</p>
<ul>
<li>Namespace：指定 Pod 所在的命名空间</li>
<li>CA：kube-apiserver CA 公钥证书，是 Pod 内部进程对 kube-apiserver 进行验证的证书</li>
<li>Token：用于身份验证，通过 kube-apiserver 私钥签发经过 Base64 编码的 Bearer Token</li>
</ul>
<p>他们都通过 mount 命令挂载到 Pod 的文件系统中，Namespace 存储在 /var/run/secrets/kubernetes.io/serviceaccount/namespace，经过 Base64 加密；CA 的存储路径 /var/run/secrets/kubernetes.io/serviceaccount/ca.crt；Token 存储在 /var/run/secrets/kubernetes.io/serviceaccount/token 文件中。</p>
<ol>
<li>
<p>启用</p>
<p>kube-apiserver 指定以下参数启用</p>
<ul>
<li><code>--service-account-key-file</code> ：包含用来给 Bearer Token 签名的 PEM 编码密钥，如果未指定，使用 kube-apiserver 的 TLS 私钥。</li>
<li><code>--service-account-lookup</code>：用于验证 service account token 是否存在 etcd 中，默认为 true。</li>
</ul>
</li>
<li>
<p>配置</p>
<p>ServiceAccount 通常是 kube-apiserver 自动创建，并通过准入控制器关联到 Pod 中。当然也可以在 Pod.spec.serviceAccountName 显示地指定。</p>
</li>
<li>
<p>认证实现</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// pkg/serviceaccount/jwt.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">j</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">jwtTokenAuthenticator</span>) <span style="color:#a6e22e">AuthenticateToken</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">tokenData</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">authenticator</span>.<span style="color:#a6e22e">Response</span>, <span style="color:#66d9ef">bool</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 1. 校验 token 格式正确
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">j</span>.<span style="color:#a6e22e">hasCorrectIssuer</span>(<span style="color:#a6e22e">tokenData</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 2. 解析 JWT 对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">tok</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">ParseSigned</span>(<span style="color:#a6e22e">tokenData</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">public</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">Claims</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">private</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">j</span>.<span style="color:#a6e22e">validator</span>.<span style="color:#a6e22e">NewPrivateClaims</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// TODO: Pick the key that has the same key ID as `tok`, if one exists.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">found</span>   <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">errlist</span> []<span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 3. 使用--service-account-key-file 提供的密钥，反序列化 JWT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">j</span>.<span style="color:#a6e22e">keys</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tok</span>.<span style="color:#a6e22e">Claims</span>(<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">public</span>, <span style="color:#a6e22e">private</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">errlist</span> = append(<span style="color:#a6e22e">errlist</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">found</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 4. 验证 namespace 是否正确、serviceAccountName、serviceAccountID 是否存在，token 是否失效
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">sa</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">j</span>.<span style="color:#a6e22e">validator</span>.<span style="color:#a6e22e">Validate</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">tokenData</span>, <span style="color:#a6e22e">public</span>, <span style="color:#a6e22e">private</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">authenticator</span>.<span style="color:#a6e22e">Response</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">User</span>:      <span style="color:#a6e22e">sa</span>.<span style="color:#a6e22e">UserInfo</span>(),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Audiences</span>: <span style="color:#a6e22e">auds</span>,
</span></span><span style="display:flex;"><span>	}, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>服务账号被身份认证后，所确定的用户名为 <code>system:serviceaccount:&lt;NAMESPACE&gt;:&lt;SERVICEACCOUNT&gt;</code>， 并被分配到用户组 <code>system:serviceaccounts</code> 和 <code>system:serviceaccounts:&lt;NAMESPACE&gt;</code>。</p>
</li>
</ol>
<h3 id="215-openid-connect-token">
  2.1.5 OpenID Connect Token
  <a class="anchor" href="#215-openid-connect-token">#</a>
</h3>
<p>OpenID Connect Token(OIDC) 是一套基于 OAuth2.0 协议的轻量级认证规范，其提供了通过 API 进行身份交互的框架。OIDC 认证除了认证请求外，还会标明请求的用户身份（ID Token）。其中 Token 被称为 ID Token，此 ID Token 是 JWT，具有服务器签名的相关字段。认证流程如下：</p>
<ol>
<li>用户想要访问 kube-apiserver，先通过认证服务（Auth Service，例如 Google Accounts 服务）认证自己，得到 access_token、id_token 和 refresh_token。</li>
<li>用户把 access_token、id_token 和 refresh_token 配置到客户端应用程序，例如：kubectl 或者 dashboard 工具</li>
<li>客户端使用 Token 以用户身份访问 kube-apiserver</li>
</ol>
<p>kube-apiserver 和 Auth Service 没有直接交互，而是鉴定客户端发送过来的 Token 是否合法。完整的 OIDC 认证过程如下图所示：</p>


<script src="/mermaid.min.js"></script>

  <script>mermaid.initialize({
  "flowchart": {
    "useMaxWidth":true
  },
  "theme": "default"
}
)</script>




<p class="mermaid">
sequenceDiagram
    participant user as 用户
    participant idp as 身份提供者 
    participant kube as Kubectl
    participant api as API 服务器

    user ->> idp: 1. 登录到 IdP
    activate idp
    idp -->> user: 2. 提供 access_token,<br>id_token, 和 refresh_token
    deactivate idp
    activate user
    user ->> kube: 3. 调用 Kubectl 并<br>设置 --token 为 id_token<br>或者将令牌添加到 .kube/config
    deactivate user
    activate kube
    kube ->> api: 4. Authorization: Bearer...
    deactivate kube
    activate api
    api ->> api: 5. JWT 签名合法么？
    api ->> api: 6. JWT 是否已过期？(iat+exp)
    api ->> api: 7. 用户被授权了么？
    api -->> kube: 8. 已授权：执行<br>操作并返回结果
    deactivate api
    activate kube
    kube --x user: 9. 返回结果
    deactivate kube
</p>

<ol>
<li>登录到身份服务（即 Auth Server）</li>
<li>身份服务将为你提供 access_token、id_token 和 refresh_token</li>
<li>用户在使用 kubectl 时，将 id_token 设置为 <code>--token</code> 标志值，或者将其直接添加到 kubeconfig 中</li>
<li>kubectl 将 id_token 设置为 Authorization 的请求头，发送给 API 服务器</li>
<li>API 服务器将负责通过检查配置中引用的证书来确认 JWT 的签名是合法的</li>
<li>检查确认 id_token 尚未过期</li>
<li>确认用户有权限执行操作</li>
<li>鉴权成功之后，API 服务器向 kubectl 返回响应</li>
<li>kubectl 向用户提供反馈信息</li>
</ol>
<p>kube-apiserver 不与 Auth Service 交互就可以认证 Token 的合法性，关键在于第 5 步，所有 JWT 都由颁发给它的 Auth Service 进行了数字签名，只需要在 kube-apiserver 的启动参数中，配置信任的 Auth Server 证书，用它来验证 id_token 是否合法。</p>
<ol>
<li>启用</li>
</ol>
<ul>
<li><code>--oidc-ca-file</code>：指向一个 CA 证书的路径，该 CA 负责对你的身份服务的 Web 证书提供签名。默认值为宿主系统的根 CA（<code>/etc/kubernetes/ssl/kc-ca.pem</code>）。</li>
<li><code>--oidc-client-id</code>：所有令牌都应发放给此客户 ID。</li>
<li><code>--oidc-groups-claim</code>：JWT 声明的用户组名称。</li>
<li><code>--oidc-groups-prefix</code>：添加到组申领的前缀，用来避免与现有用户组名（如：<code>system:</code> 组）发生冲突。例如，此标志值为 <code>oidc:</code> 时，所得到的用户组名形如 <code>oidc:engineering</code> 和 <code>oidc:infra</code>。</li>
<li><code>--oidc-issuer-url</code>：允许 API 服务器发现公开的签名密钥的服务的 URL。只接受模式为 <code>https://</code> 的 URL。此值通常设置为服务的发现 URL，不含路径。例如：&ldquo;
  <a href="https://accounts.google.com">https://accounts.google.com</a>&rdquo; 或 &ldquo;
  <a href="https://login.salesforce.com">https://login.salesforce.com</a>&rdquo;。此 URL 应指向 .well-known/openid-configuration 下一层的路径。</li>
<li><code>--oidc-required-claim</code>：取值为一个 key=value 偶对，意为 ID 令牌中必须存在的申领。如果设置了此标志，则 ID 令牌会被检查以确定是否包含取值匹配的申领。此标志可多次重复，以指定多个申领。</li>
<li><code>--oidc-username-claim</code>：JWT 声明的用户名称。默认情况下使用 <code>sub</code> 值，即最终用户的一个唯一的标识符。</li>
<li><code>--oidc-username-prefix</code>：要添加到用户名申领之前的前缀，用来避免与现有用户名（例如：<code>system:</code> 用户）发生冲突。</li>
</ul>
<ol start="2">
<li>认证实现</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// staging/src/k8s.io/apiserver/plugin/pkg/authenticator/token/oidc/oidc.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Authenticator</span>) <span style="color:#a6e22e">AuthenticateToken</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">token</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">authenticator</span>.<span style="color:#a6e22e">Response</span>, <span style="color:#66d9ef">bool</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">idToken</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">verifier</span>.<span style="color:#a6e22e">Verify</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">token</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">authenticator</span>.<span style="color:#a6e22e">Response</span>{<span style="color:#a6e22e">User</span>: <span style="color:#a6e22e">info</span>}, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>整个认证逻辑，大体上是解析 id_token，把其中的 user、group 信息取出，组成 User 对象返回。在返回之前，要对针对 kube-apiserver 的各个 reqiured_claims 入参校验，看看从 id_token 中的值是否匹配。</p>
<h3 id="216-webhook-token">
  2.1.6 Webhook Token
  <a class="anchor" href="#216-webhook-token">#</a>
</h3>
<p>webhook 也被称为钩子，是一种基于 HTTP 协议的回调机制，当客户端发送的认证请求到达 kube-apiserver 时，kubbe-apiserver 回调钩子方法，将验证信息发送给远程的 webhook 服务器进行验证，让根据返回的状态码判断是否认证通过。</p>
<ol>
<li>启用</li>
</ol>
<ul>
<li><code>--authentication-token-webhook-config-file</code>：指向一个配置文件，其中描述 如何访问远程的 Webhook 服务。</li>
<li><code>--authentication-token-webhook-cache-ttl</code>：用来设定身份认证决定的缓存时间。默认时长为 2 分钟。</li>
</ul>
<p>配置文件使用 kubeconfig 文件的格式。文件中，clusters 指代远程服务，users 指代远程 API 服务 Webhook。下面是一个例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># Kubernetes API 版本</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># API 对象类别</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Config</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># clusters 指代远程服务</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">clusters</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">name-of-remote-authn-service</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cluster</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">certificate-authority</span>: <span style="color:#ae81ff">/path/to/ca.pem        </span> <span style="color:#75715e"># 用来验证远程服务的 CA</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">server</span>: <span style="color:#ae81ff">https://authn.example.com/authenticate</span> <span style="color:#75715e"># 要查询的远程服务 URL。必须使用 &#39;https&#39;。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># users 指代 API 服务的 Webhook 配置</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">users</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">name-of-api-server</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">user</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">client-certificate</span>: <span style="color:#ae81ff">/path/to/cert.pem</span> <span style="color:#75715e"># Webhook 插件要使用的证书</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">client-key</span>: <span style="color:#ae81ff">/path/to/key.pem         </span> <span style="color:#75715e"># 与证书匹配的密钥</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubeconfig 文件需要一个上下文（Context），此上下文用于本 API 服务器</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">current-context</span>: <span style="color:#ae81ff">webhook</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">contexts</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">context</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">cluster</span>: <span style="color:#ae81ff">name-of-remote-authn-service</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">user</span>: <span style="color:#ae81ff">name-of-api-sever</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">webhook</span>
</span></span></code></pre></div><p>当客户端尝试在 API 服务器上使用持有者令牌完成身份认证（ 如前所述）时， 身份认证 Webhook 会用 POST 请求发送一个 JSON 序列化的对象到远程服务。 该对象是 <code>authentication.k8s.io/v1beta1</code> 组的 <code>TokenReview</code> 对象， 其中包含持有者令牌。 Kubernetes 不会强制请求提供此 HTTP 头部。</p>
<p>要注意的是，Webhook API 对象和其他 Kubernetes API 对象一样，也要受到同一 版本兼容规则约束。 实现者要了解对 Beta 阶段对象的兼容性承诺，并检查请求的 apiVersion 字段， 以确保数据结构能够正常反序列化解析。此外，API 服务器必须启用 <code>authentication.k8s.io/v1beta1</code> API 扩展组 （<code>--runtime-config=authentication.k8s.io/v1beta1=true</code>）。</p>
<ol start="2">
<li>认证实现</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// staging/src/k8s.io/apiserver/pkg/authentication/token/cache/cached_token_authenticator.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">cachedTokenAuthenticator</span>) <span style="color:#a6e22e">AuthenticateToken</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">token</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">authenticator</span>.<span style="color:#a6e22e">Response</span>, <span style="color:#66d9ef">bool</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">record</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">doAuthenticateToken</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">token</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">record</span>.<span style="color:#a6e22e">ok</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">record</span>.<span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">record</span>.<span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">value</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">record</span>.<span style="color:#a6e22e">annotations</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">audit</span>.<span style="color:#a6e22e">AddAuditAnnotation</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">value</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">record</span>.<span style="color:#a6e22e">resp</span>, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>a.doAuthenticateToken(ctx, token)</code> 是认证过程的核心，首先从缓存中查找是否已认证，有则直接返回，没有调用远程 webhook 服务验证。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// staging/src/k8s.io/apiserver/plugin/pkg/authenticator/token/webhook/webhook.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">w</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">WebhookTokenAuthenticator</span>) <span style="color:#a6e22e">AuthenticateToken</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">token</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">authenticator</span>.<span style="color:#a6e22e">Response</span>, <span style="color:#66d9ef">bool</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">webhook</span>.<span style="color:#a6e22e">WithExponentialBackoff</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">initialBackoff</span>, <span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">tokenReview</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">r</span>, <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">CreateOptions</span>{})
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}, <span style="color:#a6e22e">webhook</span>.<span style="color:#a6e22e">DefaultShouldRetry</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">Authenticated</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">Error</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">Error</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">authenticator</span>.<span style="color:#a6e22e">Response</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">User</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">DefaultInfo</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Name</span>:   <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">User</span>.<span style="color:#a6e22e">Username</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">UID</span>:    <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">User</span>.<span style="color:#a6e22e">UID</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Groups</span>: <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">User</span>.<span style="color:#a6e22e">Groups</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Extra</span>:  <span style="color:#a6e22e">extra</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Audiences</span>: <span style="color:#a6e22e">auds</span>,
</span></span><span style="display:flex;"><span>	}, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>通过 w.tokenReview.Create 发送 POST 请求到远程 webhook 服务，并在 body 体中携带认真信息，根据返回值 Status.Authenticated 判断是否认证通过。</p>
<h3 id="217-authentication-proxy">
  2.1.7 Authentication Proxy
  <a class="anchor" href="#217-authentication-proxy">#</a>
</h3>
<p>API 服务器可以配置成从请求的头部字段值（如 X-Remote-User）中辩识用户。这一设计是用来与某身份认证代理一起使用 API 服务器，代理负责设置请求的头部字段值。</p>
<p>认证代理有几个列表，</p>
<ul>
<li>用户名列表：建议设置为 &ldquo;X-Remote-User&rdquo;。必选</li>
<li>组列表：建议设置为 &ldquo;X-Remote-Group&rdquo;。可选</li>
<li>额外列表：建议设置为 &ldquo;X-Remote-Extra-&quot;。可选</li>
</ul>
<ol>
<li>启用</li>
</ol>
<ul>
<li><code>--requestheader-client-ca-file</code>：指定有效的客户端 CA 证书。</li>
<li><code>--requestheader-allowed-names</code>：指定通用名称（Common Name）</li>
<li><code>--requestheader-username-headers</code>：指定用户名列表</li>
<li><code>--requestheader-group-headers</code>：指定组名列表</li>
<li><code>--requestheader-extra-headers-prefix</code>：指定额外列表</li>
</ul>
<ol start="2">
<li>认证</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// staging/src/k8s.io/apiserver/pkg/authentication/request/headerrequest/requestheader.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">requestHeaderAuthRequestHandler</span>) <span style="color:#a6e22e">AuthenticateRequest</span>(<span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">authenticator</span>.<span style="color:#a6e22e">Response</span>, <span style="color:#66d9ef">bool</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 用户信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">name</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">headerValue</span>(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Header</span>, <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">nameHeaders</span>.<span style="color:#a6e22e">Value</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">name</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 组信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">groups</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">allHeaderValues</span>(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Header</span>, <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">groupHeaders</span>.<span style="color:#a6e22e">Value</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 额外信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">extra</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newExtra</span>(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Header</span>, <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">extraHeaderPrefixes</span>.<span style="color:#a6e22e">Value</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">authenticator</span>.<span style="color:#a6e22e">Response</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">User</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">DefaultInfo</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Name</span>:   <span style="color:#a6e22e">name</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Groups</span>: <span style="color:#a6e22e">groups</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Extra</span>:  <span style="color:#a6e22e">extra</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	}, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在进行认证代理认证时，requestHeader 就是实现方式，分别从 HTTP Header 读出用户、组和额外信息，返回给客户端。</p>
<h2 id="22-其他">
  2.2 其他
  <a class="anchor" href="#22-%e5%85%b6%e4%bb%96">#</a>
</h2>
<blockquote>
<p>有关匿名请求、用户伪装和 client-go 插件代理，请移步官网：
  <a href="http://kubernetes.io/zh/docs/reference/access-authn-authz/authentication/#anonymous-requests">用户认证</a></p>
</blockquote>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">



  <div><a class="flex align-center" href="https://github.com/howieyuen/howieyuen.github.io/commit/be46fbc5a56ee48b09bc3ac56cfce882f3ad2d9e" title='Last modified by howieyuen | May 5, 2022' target="_blank" rel="noopener">
      <img src="/svg/calendar.svg" class="book-icon" alt="Calendar" />
      <span>May 5, 2022</span>
    </a>
  </div>



</div>

 
        
      </footer>

      
  
  <div class="book-comments">



  <div id="gitalk-container"></div>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
  <script>
    let splits = location.pathname.split("/")
    const gitalk = new Gitalk({
      clientID: '25d476132e0758875147',
      clientSecret: '9648a660ceabeb1a20a6354a3c131481724f62db',
      repo: 'howieyuen.github.io',
      owner: 'howieyuen',
      admin: ['howieyuen'],
      id: splits[splits.length-2], 
      distractionFreeMode: false 
    });
    (function() {
      if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
        document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
        return;
      }
      gitalk.render('gitalk-container');
    })();
  </script>
</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#1-kubernetes-中的用户">1. Kubernetes 中的用户</a></li>
    <li><a href="#2-认证机制">2. 认证机制</a>
      <ul>
        <li><a href="#21-身份验证策略">2.1 身份验证策略</a>
          <ul>
            <li><a href="#211-x509-client-cert">2.1.1 X509 Client Cert</a></li>
            <li><a href="#212-static-token-file">2.1.2 Static Token File</a></li>
            <li><a href="#213-bootstrap-tokens">2.1.3 Bootstrap Tokens</a></li>
            <li><a href="#214--serviceaccount-token">2.1.4  ServiceAccount Token</a></li>
            <li><a href="#215-openid-connect-token">2.1.5 OpenID Connect Token</a></li>
            <li><a href="#216-webhook-token">2.1.6 Webhook Token</a></li>
            <li><a href="#217-authentication-proxy">2.1.7 Authentication Proxy</a></li>
          </ul>
        </li>
        <li><a href="#22-其他">2.2 其他</a></li>
      </ul>
    </li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>

</html>












